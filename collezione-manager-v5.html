<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Collezione Vintage v5 - Gestione Macchine da Scrivere e Calcolatrici</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&family=Source+Sans+3:wght@300;400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #1a1814;
      --bg-secondary: #232019;
      --bg-tertiary: #2d2a22;
      --bg-hover: #38342a;
      --bg-card: #262318;
      --border-subtle: rgba(212,175,125,0.08);
      --border-medium: rgba(212,175,125,0.15);
      --text-primary: #f5f0e8;
      --text-secondary: #c4b8a5;
      --text-muted: #8a7e6d;
      --accent-primary: #c9a86c;
      --accent-primary-soft: rgba(201,168,108,0.15);
      --accent-secondary: #d4af7d;
      --accent-success: #7cb87c;
      --accent-success-soft: rgba(124,184,124,0.12);
      --accent-warning: #d4a55a;
      --accent-warning-soft: rgba(212,165,90,0.12);
      --accent-danger: #c47070;
      --accent-danger-soft: rgba(196,112,112,0.12);
      --accent-info: #7aacc4;
      --accent-info-soft: rgba(122,172,196,0.12);
      --accent-work: #9b7ed9;
      --accent-work-soft: rgba(155,126,217,0.12);
      --accent-accessory: #e0976b;
      --accent-accessory-soft: rgba(224,151,107,0.12);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Source Sans 3', -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg-primary); color: var(--text-primary); font-size: 15px; line-height: 1.5; }
    h1, h2, h3, h4 { font-family: 'Playfair Display', Georgia, serif; }
    ::-webkit-scrollbar { width: 10px; height: 10px; }
    ::-webkit-scrollbar-track { background: var(--bg-secondary); }
    ::-webkit-scrollbar-thumb { background: var(--bg-tertiary); border-radius: 5px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--bg-hover); }
    @keyframes slideIn { from { transform: translateY(-10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
    details summary { list-style: none; }
    details summary::-webkit-details-marker { display: none; }
    details[open] summary span:first-child { transform: rotate(90deg); display: inline-block; }
    details summary span:first-child { transition: transform 0.2s ease; display: inline-block; }
    @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
    input:focus, select:focus, textarea:focus { outline: none; border-color: var(--accent-primary) !important; box-shadow: 0 0 0 3px var(--accent-primary-soft); }
    input, select, textarea { font-size: 15px; }
    button { font-size: 14px; }
    .save-indicator { display: flex; align-items: center; gap: 8px; padding: 8px 14px; border-radius: 8px; font-size: 14px; font-weight: 500; }
    .save-indicator.saved { background: var(--accent-success-soft); color: var(--accent-success); }
    .save-indicator.unsaved { background: var(--accent-warning-soft); color: var(--accent-warning); animation: blink 1s infinite; }
    .save-indicator.no-file { background: var(--accent-danger-soft); color: var(--accent-danger); }
    /* Responsive table */
    @media (max-width: 1200px) {
      table th, table td { padding: 12px 8px !important; font-size: 14px !important; }
      table th span, table td span { font-size: 12px !important; padding: 4px 8px !important; }
    }
    @media (max-width: 900px) {
      table th, table td { padding: 10px 6px !important; font-size: 13px !important; }
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useCallback, useMemo, useRef } = React;

    const defaultCategories = [
      { id: 'cat-1', name: 'Macchine da scrivere portatili', color: '#c9a86c' },
      { id: 'cat-2', name: 'Macchine da scrivere da tavolo', color: '#7aacc4' },
      { id: 'cat-3', name: 'Calcolatrici meccaniche', color: '#7cb87c' },
      { id: 'cat-4', name: 'Calcolatrici elettroniche', color: '#d4a55a' },
      { id: 'cat-5', name: 'Addizionatrici', color: '#9b7ed9' },
      { id: 'cat-6', name: 'Registratori di cassa', color: '#c47070' },
    ];

    const defaultSubcategories = [
      { id: 'subcat-1', name: 'Ultraportatili', categoryId: 'cat-1' },
      { id: 'subcat-2', name: 'Standard', categoryId: 'cat-1' },
      { id: 'subcat-3', name: 'Elettriche', categoryId: 'cat-2' },
      { id: 'subcat-4', name: 'Manuali', categoryId: 'cat-2' },
      { id: 'subcat-5', name: 'A manovella', categoryId: 'cat-3' },
      { id: 'subcat-6', name: 'A tastiera', categoryId: 'cat-3' },
    ];

    const defaultBrands = [
      { id: 'brand-1', name: 'Olivetti' },
      { id: 'brand-2', name: 'Underwood' },
      { id: 'brand-3', name: 'Remington' },
      { id: 'brand-4', name: 'Royal' },
      { id: 'brand-5', name: 'Hermes' },
      { id: 'brand-6', name: 'Facit' },
      { id: 'brand-7', name: 'Brunsviga' },
      { id: 'brand-8', name: 'Monroe' },
    ];

    const defaultModels = [
      { id: 'model-1', name: 'Lettera 22', brandId: 'brand-1' },
      { id: 'model-2', name: 'Lettera 32', brandId: 'brand-1' },
      { id: 'model-3', name: 'Valentine', brandId: 'brand-1' },
      { id: 'model-4', name: 'Divisumma 24', brandId: 'brand-1' },
      { id: 'model-5', name: 'No. 5', brandId: 'brand-2' },
      { id: 'model-6', name: 'Portable', brandId: 'brand-3' },
      { id: 'model-7', name: 'Quiet De Luxe', brandId: 'brand-4' },
      { id: 'model-8', name: 'Baby', brandId: 'brand-5' },
      { id: 'model-9', name: 'Model 13', brandId: 'brand-7' },
    ];

    const defaultLocations = [
      { id: 'loc-1', name: 'Vetrina A', description: 'Vetrina principale ingresso' },
      { id: 'loc-2', name: 'Vetrina B', description: 'Vetrina laterale destra' },
      { id: 'loc-3', name: 'Scaffale 1', description: 'Scaffale magazzino piano terra' },
      { id: 'loc-4', name: 'Scaffale 2', description: 'Scaffale magazzino primo piano' },
      { id: 'loc-5', name: 'Laboratorio', description: 'Area restauro e riparazioni' },
      { id: 'loc-6', name: 'Deposito', description: 'Deposito esterno' },
    ];

    const defaultStatuses = [
      { id: 'status-1', name: 'Funzionante', color: '#7cb87c', icon: 'âœ“' },
      { id: 'status-2', name: 'Da restaurare', color: '#d4a55a', icon: 'ðŸ”§' },
      { id: 'status-3', name: 'In restauro', color: '#9b7ed9', icon: 'âš™ï¸' },
      { id: 'status-4', name: 'In manutenzione', color: '#7aacc4', icon: 'ðŸ› ï¸' },
      { id: 'status-5', name: 'In attesa ricambi', color: '#e0976b', icon: 'â³' },
      { id: 'status-6', name: 'Non funzionante', color: '#c47070', icon: 'âœ—' },
      { id: 'status-7', name: 'Da valutare', color: '#8a7e6d', icon: '?' },
    ];

    const defaultAestheticGrades = [
      { id: 'grade-1', name: 'Eccellente', color: '#7cb87c', score: 5 },
      { id: 'grade-2', name: 'Ottimo', color: '#9bc47c', score: 4 },
      { id: 'grade-3', name: 'Buono', color: '#d4a55a', score: 3 },
      { id: 'grade-4', name: 'Discreto', color: '#e0976b', score: 2 },
      { id: 'grade-5', name: 'Sufficiente', color: '#c47070', score: 1 },
      { id: 'grade-6', name: 'Da restaurare', color: '#8a7e6d', score: 0 },
    ];

    const defaultAccessoryTypes = [
      { id: 'acctype-1', name: 'Custodia', icon: 'ðŸ’¼' },
      { id: 'acctype-2', name: 'Nastro', icon: 'ðŸŽ€' },
      { id: 'acctype-3', name: 'Coperchio', icon: 'ðŸ”²' },
      { id: 'acctype-4', name: 'Manuale', icon: 'ðŸ“–' },
      { id: 'acctype-5', name: 'Spazzola pulizia', icon: 'ðŸ–Œï¸' },
      { id: 'acctype-6', name: 'Chiave', icon: 'ðŸ”‘' },
      { id: 'acctype-7', name: 'Piedini', icon: 'âš«' },
      { id: 'acctype-8', name: 'Cavo alimentazione', icon: 'ðŸ”Œ' },
      { id: 'acctype-9', name: 'Altro', icon: 'ðŸ“¦' },
    ];

    const accessoryStatuses = [
      { id: 'acc-status-1', name: 'Presente', color: '#7cb87c' },
      { id: 'acc-status-2', name: 'Mancante', color: '#c47070' },
      { id: 'acc-status-3', name: 'Da acquistare', color: '#d4a55a' },
      { id: 'acc-status-4', name: 'Ordinato', color: '#7aacc4' },
      { id: 'acc-status-5', name: 'Danneggiato', color: '#e0976b' },
    ];

    // Tipi di manutenzione programmata (per categoria)
    const defaultMaintenanceTypes = [
      { id: 'maint-1', name: 'Pulizia meccanismo', categoryId: 'cat-1', defaultFrequencyDays: 180 },
      { id: 'maint-2', name: 'Lubrificazione segmento', categoryId: 'cat-1', defaultFrequencyDays: 365 },
      { id: 'maint-3', name: 'Controllo nastro', categoryId: 'cat-1', defaultFrequencyDays: 90 },
      { id: 'maint-4', name: 'Verifica allineamento tipi', categoryId: 'cat-1', defaultFrequencyDays: 365 },
      { id: 'maint-5', name: 'Pulizia rulli', categoryId: 'cat-1', defaultFrequencyDays: 180 },
      { id: 'maint-6', name: 'Pulizia meccanismo', categoryId: 'cat-2', defaultFrequencyDays: 180 },
      { id: 'maint-7', name: 'Lubrificazione ingranaggi', categoryId: 'cat-2', defaultFrequencyDays: 365 },
      { id: 'maint-8', name: 'Verifica azzeramento', categoryId: 'cat-2', defaultFrequencyDays: 180 },
      { id: 'maint-9', name: 'Controllo nastro inchiostro', categoryId: 'cat-2', defaultFrequencyDays: 90 },
    ];

    const sampleItems = [
      { 
        id: 'ITEM-001', description: 'Olivetti Lettera 22 del 1950, colore verde oliva originale.',
        brandId: 'brand-1', modelId: 'model-1', category: 'Macchine da scrivere portatili', subcategory: 'Standard',
        purchaseCost: 350, purchaseYear: '2023', status: 'Funzionante', aestheticGrade: 'Ottimo', location: 'Vetrina A', 
        version: '1a serie', defectFound: '', notes: 'Pezzo raro, documentazione originale inclusa.', images: [],
        works: [
          { id: 'work-1', description: 'Pulizia completa meccanismo', cost: 80, date: '2024-01-15', images: [], notes: 'Rimosso residui inchiostro' },
          { id: 'work-2', description: 'Sostituzione nastro', cost: 25, date: '2024-01-20', images: [], notes: 'Nastro nero/rosso nuovo' }
        ],
        accessories: [
          { id: 'acc-1', name: 'Custodia originale', typeId: 'acctype-1', cost: 0, status: 'Presente', images: [], notes: 'In ottime condizioni' },
          { id: 'acc-2', name: 'Manuale italiano', typeId: 'acctype-4', cost: 45, status: 'Presente', images: [], notes: 'Acquistato separatamente' }
        ],
        dateAdded: '2024-01-10', lastModified: '2024-03-10', year: '1950', serialNumber: 'L22-45678'
      },
      { 
        id: 'ITEM-002', description: 'Olivetti Valentine design Ettore Sottsass.',
        brandId: 'brand-1', modelId: 'model-3', category: 'Macchine da scrivere portatili', subcategory: 'Ultraportatili',
        purchaseCost: 890, purchaseYear: '2024', status: 'Da restaurare', aestheticGrade: 'Discreto', location: 'Laboratorio', 
        version: '', defectFound: 'Tasti bloccati, carrello non scorre bene', notes: 'Custodia con segni.', images: [],
        works: [],
        accessories: [{ id: 'acc-3', name: 'Custodia rossa', typeId: 'acctype-1', cost: 0, status: 'Danneggiato', images: [], notes: 'Graffi visibili' }],
        dateAdded: '2024-02-05', lastModified: '2024-02-05', year: '1969', serialNumber: 'VAL-12345'
      },
      { 
        id: 'ITEM-003', description: 'Calcolatrice meccanica a manovella.',
        brandId: 'brand-7', modelId: 'model-9', category: 'Calcolatrici meccaniche', subcategory: 'A manovella',
        purchaseCost: 280, purchaseYear: '2023', status: 'In manutenzione', aestheticGrade: 'Buono', location: 'Laboratorio', 
        version: 'ZK', defectFound: 'Leva reset bloccata', notes: '', images: [],
        works: [{ id: 'work-3', description: 'Diagnosi meccanismo', cost: 50, date: '2024-02-01', images: [], notes: '' }],
        accessories: [],
        dateAdded: '2024-01-20', lastModified: '2024-02-01', year: '1935', serialNumber: 'B13-98765'
      },
      { 
        id: 'ITEM-004', description: 'Calcolatrice elettromeccanica Olivetti.',
        brandId: 'brand-1', modelId: 'model-4', category: 'Calcolatrici meccaniche', subcategory: 'A tastiera',
        purchaseCost: 420, purchaseYear: '2024', status: 'Funzionante', aestheticGrade: 'Eccellente', location: 'Vetrina B', 
        version: 'GT', defectFound: '', notes: '', images: [],
        works: [],
        accessories: [{ id: 'acc-5', name: 'Coperchio antipolvere', typeId: 'acctype-3', cost: 35, status: 'Presente', images: [], notes: '' }],
        dateAdded: '2024-03-01', lastModified: '2024-03-01', year: '1956', serialNumber: 'D24-55555'
      },
    ];

    const generateId = () => `ID-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
    
    // Convert image to WebP with resize and themed background
    const convertToWebP = (file, quality = 0.85) => new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = (e) => {
        const img = new Image();
        img.onload = () => {
          // Target dimensions: 1024 x 768 (1.33 ratio horizontal)
          const targetWidth = 1024;
          const targetHeight = 768;
          const targetRatio = targetWidth / targetHeight; // 1.33
          
          // Calculate scaled dimensions keeping aspect ratio
          let srcWidth = img.width;
          let srcHeight = img.height;
          let scale = 1;
          
          // Scale down if larger than max
          if (srcWidth > targetWidth || srcHeight > targetHeight) {
            const scaleW = targetWidth / srcWidth;
            const scaleH = targetHeight / srcHeight;
            scale = Math.min(scaleW, scaleH);
          }
          
          const scaledWidth = Math.round(srcWidth * scale);
          const scaledHeight = Math.round(srcHeight * scale);
          
          // Create canvas with target dimensions
          const canvas = document.createElement('canvas');
          canvas.width = targetWidth;
          canvas.height = targetHeight;
          const ctx = canvas.getContext('2d');
          
          // Fill with themed gradient background (vintage dark brown/sepia)
          const gradient = ctx.createRadialGradient(targetWidth/2, targetHeight/2, 0, targetWidth/2, targetHeight/2, targetWidth/2);
          gradient.addColorStop(0, '#2d2a22');
          gradient.addColorStop(1, '#1a1814');
          ctx.fillStyle = gradient;
          ctx.fillRect(0, 0, targetWidth, targetHeight);
          
          // Add subtle vignette effect
          const vignetteGradient = ctx.createRadialGradient(targetWidth/2, targetHeight/2, targetHeight/3, targetWidth/2, targetHeight/2, targetWidth/1.5);
          vignetteGradient.addColorStop(0, 'rgba(0,0,0,0)');
          vignetteGradient.addColorStop(1, 'rgba(0,0,0,0.3)');
          ctx.fillStyle = vignetteGradient;
          ctx.fillRect(0, 0, targetWidth, targetHeight);
          
          // Center the image
          const x = Math.round((targetWidth - scaledWidth) / 2);
          const y = Math.round((targetHeight - scaledHeight) / 2);
          
          // Draw the scaled image centered
          ctx.drawImage(img, x, y, scaledWidth, scaledHeight);
          
          canvas.toBlob((blob) => {
            const reader2 = new FileReader();
            reader2.onload = () => resolve(reader2.result);
            reader2.onerror = reject;
            reader2.readAsDataURL(blob);
          }, 'image/webp', quality);
        };
        img.onerror = reject;
        img.src = e.target.result;
      };
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });

    const formatDate = (dateStr) => {
      if (!dateStr) return '-';
      return new Date(dateStr).toLocaleDateString('it-IT', { day: '2-digit', month: 'short', year: 'numeric' });
    };
    const formatCurrency = (amount) => new Intl.NumberFormat('it-IT', { style: 'currency', currency: 'EUR' }).format(amount || 0);

    // Common emojis for quick selection
    const commonEmojis = ['ðŸ“‹', 'âœ…', 'ðŸ”§', 'â³', 'âŒ', 'âš ï¸', 'ðŸ’«', 'ðŸŽ¯', 'ðŸ“¦', 'ðŸŽ’', 'ðŸ’¼', 'ðŸ”Œ', 'ðŸ“Ž', 'ðŸ–‹ï¸', 'âŒ¨ï¸', 'ðŸ”©', 'ðŸ› ï¸', 'ðŸ“š', 'ðŸŽ¨', 'ðŸ’¡', 'ðŸ”‹', 'ðŸ“±', 'ðŸ’¾', 'ðŸ–¨ï¸', 'ðŸ“', 'âœ¨', 'ðŸ†', 'â­', 'ðŸ’Ž', 'ðŸ”’', 'ðŸ”‘', 'ðŸŽ', 'ðŸ“Œ', 'ðŸ·ï¸', 'ðŸ—‚ï¸', 'ðŸ“'];
    
    // EmojiPicker component
    const EmojiPicker = ({ value, onChange, style }) => {
      const [showPicker, setShowPicker] = React.useState(false);
      const pickerRef = React.useRef(null);
      
      React.useEffect(() => {
        const handleClickOutside = (e) => {
          if (pickerRef.current && !pickerRef.current.contains(e.target)) setShowPicker(false);
        };
        if (showPicker) document.addEventListener('mousedown', handleClickOutside);
        return () => document.removeEventListener('mousedown', handleClickOutside);
      }, [showPicker]);
      
      return (
        <div ref={pickerRef} style={{ position: 'relative', display: 'inline-block', ...style }}>
          <button type="button" onClick={() => setShowPicker(!showPicker)} style={{ width: 50, height: 42, borderRadius: 8, border: '1px solid var(--border-medium)', background: 'var(--bg-tertiary)', cursor: 'pointer', fontSize: 20, display: 'flex', alignItems: 'center', justifyContent: 'center' }}>{value || 'ðŸ“‹'}</button>
          {showPicker && (
            <div style={{ position: 'absolute', top: '100%', left: 0, marginTop: 4, padding: 8, background: 'var(--bg-secondary)', border: '1px solid var(--border-medium)', borderRadius: 12, boxShadow: '0 10px 40px rgba(0,0,0,0.4)', zIndex: 1000, width: 220 }}>
              <div style={{ display: 'grid', gridTemplateColumns: 'repeat(6, 1fr)', gap: 4 }}>
                {commonEmojis.map((emoji, i) => (
                  <button key={i} type="button" onClick={() => { onChange(emoji); setShowPicker(false); }} style={{ width: 32, height: 32, border: 'none', borderRadius: 6, background: value === emoji ? 'var(--accent-primary-soft)' : 'transparent', cursor: 'pointer', fontSize: 16, display: 'flex', alignItems: 'center', justifyContent: 'center', transition: 'background 0.1s' }} onMouseEnter={(e) => e.target.style.background = 'var(--bg-hover)'} onMouseLeave={(e) => e.target.style.background = value === emoji ? 'var(--accent-primary-soft)' : 'transparent'}>{emoji}</button>
                ))}
              </div>
              <div style={{ marginTop: 8, paddingTop: 8, borderTop: '1px solid var(--border-subtle)' }}>
                <input type="text" value={value} onChange={(e) => onChange(e.target.value)} placeholder="Inserisci emoji..." maxLength={2} style={{ width: '100%', padding: '8px 10px', border: '1px solid var(--border-medium)', borderRadius: 6, background: 'var(--bg-tertiary)', color: 'var(--text-primary)', fontSize: 14, textAlign: 'center', fontFamily: 'inherit' }} />
              </div>
            </div>
          )}
        </div>
      );
    };

    // Export all images as JPEG in ZIP
    const exportImagesAsZip = async (items, getBrandName, getModelName) => {
      const zip = new JSZip();
      let imageCount = 0;
      
      for (const item of items) {
        if (item.images && item.images.length > 0) {
          const brandName = getBrandName(item.brandId);
          const modelName = getModelName(item.modelId);
          const baseName = `${brandName}-${modelName}${item.version ? '-' + item.version : ''}${item.serialNumber ? '-' + item.serialNumber : ''}`.replace(/[^a-z0-9\-]/gi, '-').toLowerCase();
          
          for (let i = 0; i < item.images.length; i++) {
            const imgData = item.images[i];
            // Convert WebP/base64 to JPEG
            const img = new Image();
            await new Promise((resolve) => {
              img.onload = resolve;
              img.src = imgData;
            });
            const canvas = document.createElement('canvas');
            canvas.width = img.width;
            canvas.height = img.height;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(img, 0, 0);
            const jpegData = canvas.toDataURL('image/jpeg', 0.9).split(',')[1];
            const fileName = item.images.length > 1 ? `${baseName}-${i + 1}.jpg` : `${baseName}.jpg`;
            zip.file(fileName, jpegData, { base64: true });
            imageCount++;
          }
        }
      }
      
      if (imageCount === 0) {
        return null;
      }
      
      const content = await zip.generateAsync({ type: 'blob' });
      const url = URL.createObjectURL(content);
      const a = document.createElement('a');
      a.href = url;
      a.download = `collezione-immagini-${new Date().toISOString().split('T')[0]}.zip`;
      a.click();
      URL.revokeObjectURL(url);
      return imageCount;
    };

    // Export single item with images + PDF scheda
    const exportSingleItemZip = async (item, brands, models, accessoryTypes, maintenanceTypes, getBrandName, getModelName) => {
      const zip = new JSZip();
      const brandName = getBrandName(item.brandId);
      const modelName = getModelName(item.modelId);
      const baseName = `${brandName}-${modelName}${item.version ? '-' + item.version : ''}${item.serialNumber ? '-SN' + item.serialNumber : ''}`.replace(/[^a-z0-9\-]/gi, '-').replace(/--+/g, '-').toLowerCase();
      
      // Create folder for main photos
      const fotoFolder = zip.folder('foto-principali');
      if (item.images && item.images.length > 0) {
        for (let i = 0; i < item.images.length; i++) {
          const imgData = item.images[i];
          const img = new Image();
          await new Promise((resolve) => {
            img.onload = resolve;
            img.src = imgData;
          });
          const canvas = document.createElement('canvas');
          canvas.width = img.width;
          canvas.height = img.height;
          const ctx = canvas.getContext('2d');
          ctx.fillStyle = '#FFFFFF';
          ctx.fillRect(0, 0, canvas.width, canvas.height);
          ctx.drawImage(img, 0, 0);
          const jpegData = canvas.toDataURL('image/jpeg', 0.9).split(',')[1];
          const fileName = item.images.length > 1 ? `${baseName}-foto${i + 1}.jpg` : `${baseName}-foto.jpg`;
          fotoFolder.file(fileName, jpegData, { base64: true });
        }
      }
      
      // Create folder for repair photos
      if (item.works && item.works.length > 0) {
        const riparazioniFolder = zip.folder('riparazioni');
        for (let w = 0; w < item.works.length; w++) {
          const work = item.works[w];
          if (work.images && work.images.length > 0) {
            // Create subfolder for this repair
            const workDate = work.date || 'senza-data';
            const workDesc = (work.description || 'riparazione').substring(0, 30).replace(/[^a-z0-9]/gi, '-').replace(/--+/g, '-').toLowerCase();
            const workFolderName = `${workDate}-${workDesc}`;
            const workFolder = riparazioniFolder.folder(workFolderName);
            
            for (let i = 0; i < work.images.length; i++) {
              const imgData = work.images[i];
              const img = new Image();
              await new Promise((resolve) => {
                img.onload = resolve;
                img.src = imgData;
              });
              const canvas = document.createElement('canvas');
              canvas.width = img.width;
              canvas.height = img.height;
              const ctx = canvas.getContext('2d');
              ctx.fillStyle = '#FFFFFF';
              ctx.fillRect(0, 0, canvas.width, canvas.height);
              ctx.drawImage(img, 0, 0);
              const jpegData = canvas.toDataURL('image/jpeg', 0.9).split(',')[1];
              const fileName = work.images.length > 1 ? `${workDate}-${workDesc}-foto${i + 1}.jpg` : `${workDate}-${workDesc}.jpg`;
              workFolder.file(fileName, jpegData, { base64: true });
            }
          }
        }
      }
      
      // Create folder for accessory photos
      if (item.accessories && item.accessories.length > 0) {
        const accessoriFolder = zip.folder('accessori');
        for (let a = 0; a < item.accessories.length; a++) {
          const accessory = item.accessories[a];
          if (accessory.images && accessory.images.length > 0) {
            // Create subfolder for this accessory
            const accName = (accessory.name || 'accessorio').substring(0, 30).replace(/[^a-z0-9]/gi, '-').replace(/--+/g, '-').toLowerCase();
            const accFolderName = `${String(a + 1).padStart(2, '0')}-${accName}`;
            const accFolder = accessoriFolder.folder(accFolderName);
            
            for (let i = 0; i < accessory.images.length; i++) {
              const imgData = accessory.images[i];
              const img = new Image();
              await new Promise((resolve) => {
                img.onload = resolve;
                img.src = imgData;
              });
              const canvas = document.createElement('canvas');
              canvas.width = img.width;
              canvas.height = img.height;
              const ctx = canvas.getContext('2d');
              ctx.fillStyle = '#FFFFFF';
              ctx.fillRect(0, 0, canvas.width, canvas.height);
              ctx.drawImage(img, 0, 0);
              const jpegData = canvas.toDataURL('image/jpeg', 0.9).split(',')[1];
              const fileName = accessory.images.length > 1 ? `${accName}-foto${i + 1}.jpg` : `${accName}.jpg`;
              accFolder.file(fileName, jpegData, { base64: true });
            }
          }
        }
      }
      
      // Generate PDF and add to ZIP
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('p', 'mm', 'a4');
      const getTypeName = (typeId) => accessoryTypes.find(t => t.id === typeId)?.name || '-';
      const getMaintenanceTypeName = (typeId) => maintenanceTypes.find(t => t.id === typeId)?.name || '-';
      const pageWidth = 210;
      const margin = 15;
      const contentWidth = pageWidth - (margin * 2);
      const formatCurrencyLocal = (amount) => new Intl.NumberFormat('it-IT', { style: 'currency', currency: 'EUR' }).format(amount || 0);
      const formatDateLocal = (dateStr) => { if (!dateStr) return '-'; try { return new Date(dateStr).toLocaleDateString('it-IT'); } catch { return dateStr; } };
      
      // Header
      doc.setFillColor(201, 168, 108);
      doc.rect(0, 0, pageWidth, 35, 'F');
      doc.setTextColor(26, 24, 20);
      doc.setFontSize(22);
      doc.text('SCHEDA MACCHINA', margin, 18);
      doc.setFontSize(12);
      doc.text(`${brandName} ${modelName}`, margin, 28);
      doc.setTextColor(50, 50, 50);
      let y = 45;
      
      // Cover image
      if (item.images?.[0]) {
        try {
          doc.addImage(item.images[0], 'WEBP', pageWidth - margin - 60, 40, 60, 45);
        } catch(e) {}
      }
      
      // Title
      doc.setFontSize(16);
      doc.setFont(undefined, 'bold');
      const displayName = `${brandName} ${modelName}${item.version ? ' ' + item.version : ''}`;
      const nameLines = doc.splitTextToSize(displayName, item.images?.[0] ? 110 : contentWidth);
      doc.text(nameLines, margin, y);
      y += nameLines.length * 7 + 3;
      
      // Info
      doc.setFontSize(10);
      doc.setFont(undefined, 'normal');
      const info = [
        ['Marca:', brandName], ['Modello:', modelName], ['Versione:', item.version || '-'],
        ['Anno produzione:', item.year || '-'], ['Numero di serie:', item.serialNumber || '-'],
        ['Categoria:', item.category || '-'], ['Sottocategoria:', item.subcategory || '-'],
        ['Stato:', item.status || '-'], ['Grado estetico:', item.aestheticGrade || '-'],
        ['Ubicazione:', item.location || '-'], ['Anno acquisto:', item.purchaseYear || '-'],
      ];
      info.forEach(([label, value]) => {
        doc.setFont(undefined, 'bold'); doc.text(label, margin, y);
        doc.setFont(undefined, 'normal'); doc.text(String(value), 55, y); y += 6;
      });
      y += 5;
      
      if (item.description) {
        doc.setFont(undefined, 'bold'); doc.text('Descrizione:', margin, y); y += 5;
        doc.setFont(undefined, 'normal');
        const descLines = doc.splitTextToSize(item.description, contentWidth);
        doc.text(descLines, margin, y); y += descLines.length * 5 + 5;
      }
      if (item.defectFound) {
        doc.setFont(undefined, 'bold'); doc.setTextColor(196, 112, 112);
        doc.text('Difetti riscontrati:', margin, y); y += 5;
        doc.setFont(undefined, 'normal'); doc.setTextColor(50, 50, 50);
        const defectLines = doc.splitTextToSize(item.defectFound, contentWidth);
        doc.text(defectLines, margin, y); y += defectLines.length * 5 + 5;
      }
      if (item.works?.length > 0) {
        if (y > 240) { doc.addPage(); y = 20; }
        doc.setFont(undefined, 'bold'); doc.text(`RIPARAZIONI (${item.works.length})`, margin, y); y += 6;
        doc.setFont(undefined, 'normal');
        item.works.forEach(w => {
          const workText = `â€¢ ${w.description} - ${formatCurrencyLocal(w.cost)} - ${formatDateLocal(w.date)}`;
          const workLines = doc.splitTextToSize(workText, contentWidth - 5);
          if (y + workLines.length * 5 > 275) { doc.addPage(); y = 20; }
          doc.text(workLines, 18, y); y += workLines.length * 5;
          if (w.notes) { const noteLines = doc.splitTextToSize(`Note: ${w.notes}`, contentWidth - 10); doc.text(noteLines, 22, y); y += noteLines.length * 5; }
        });
        y += 5;
      }
      if (item.accessories?.length > 0) {
        if (y > 240) { doc.addPage(); y = 20; }
        doc.setFont(undefined, 'bold'); doc.text(`ACCESSORI (${item.accessories.length})`, margin, y); y += 6;
        doc.setFont(undefined, 'normal');
        item.accessories.forEach(a => {
          const accText = `â€¢ ${a.name} (${getTypeName(a.typeId)}) - ${a.status} - ${formatCurrencyLocal(a.cost)}`;
          const accLines = doc.splitTextToSize(accText, contentWidth - 5);
          if (y + accLines.length * 5 > 275) { doc.addPage(); y = 20; }
          doc.text(accLines, 18, y); y += accLines.length * 5;
        });
        y += 5;
      }
      // Scheduled Checks
      if (item.scheduledChecks?.length > 0) {
        if (y > 220) { doc.addPage(); y = 20; }
        doc.setFont(undefined, 'bold');
        doc.setTextColor(201, 168, 108);
        doc.text(`CONTROLLI PROGRAMMATI (${item.scheduledChecks.length})`, margin, y);
        doc.setTextColor(50, 50, 50);
        y += 6;
        doc.setFont(undefined, 'normal');
        doc.setFontSize(9);
        item.scheduledChecks.forEach(check => {
          const today = new Date(); today.setHours(0, 0, 0, 0);
          const nextDate = check.nextCheckDate ? new Date(check.nextCheckDate) : null;
          if (nextDate) nextDate.setHours(0, 0, 0, 0);
          const daysUntil = nextDate ? Math.ceil((nextDate - today) / (1000 * 60 * 60 * 24)) : null;
          const isOverdue = daysUntil !== null && daysUntil < 0;
          const checkCost = check.history?.reduce((s, h) => s + (h.cost || 0), 0) || 0;
          const checkName = getMaintenanceTypeName(check.maintenanceTypeId);
          let statusText = isOverdue ? `[SCADUTO da ${Math.abs(daysUntil)} gg]` : daysUntil !== null ? `[Tra ${daysUntil} gg]` : '';
          if (y + 12 > 275) { doc.addPage(); y = 20; }
          if (isOverdue) doc.setTextColor(196, 112, 112);
          else if (daysUntil !== null && daysUntil <= (check.warningDays || 30)) doc.setTextColor(212, 165, 90);
          else doc.setTextColor(50, 50, 50);
          doc.setFont(undefined, 'bold');
          doc.text(`â€¢ ${checkName} ${statusText}`, 18, y);
          doc.setTextColor(50, 50, 50);
          doc.setFont(undefined, 'normal');
          y += 5;
          let infoLine = `Ogni ${check.frequencyDays} gg | Avviso ${check.warningDays || 30} gg | ${check.isRecursive !== false ? 'Ricorsivo' : 'Una tantum'}`;
          doc.text(infoLine, 22, y); y += 4;
          infoLine = check.lastCheckDate ? `Ultimo: ${formatDateLocal(check.lastCheckDate)}` : 'Mai eseguito';
          if (check.history?.length > 0) infoLine += ` | ${check.history.length} esecuzioni | â‚¬${checkCost.toFixed(2)}`;
          doc.text(infoLine, 22, y); y += 5;
        });
        doc.setFontSize(10);
        y += 3;
      }
      if (item.notes) {
        if (y > 250) { doc.addPage(); y = 20; }
        doc.setFont(undefined, 'bold'); doc.text('NOTE:', margin, y); y += 5;
        doc.setFont(undefined, 'normal');
        const noteLines = doc.splitTextToSize(item.notes, contentWidth);
        doc.text(noteLines, margin, y); y += noteLines.length * 5 + 5;
      }
      
      // Economic summary
      const purchaseCost = item.purchaseCost || 0;
      const worksCost = item.works?.reduce((s, w) => s + (w.cost || 0), 0) || 0;
      const accessoriesCost = item.accessories?.reduce((s, a) => s + (a.cost || 0), 0) || 0;
      const maintenanceCost = item.scheduledChecks?.reduce((s, c) => s + (c.history?.reduce((h, e) => h + (e.cost || 0), 0) || 0), 0) || 0;
      const totalCost = purchaseCost + worksCost + accessoriesCost + maintenanceCost;
      if (y > 230) { doc.addPage(); y = 20; }
      doc.setFillColor(240, 240, 235);
      doc.rect(margin, y, contentWidth, maintenanceCost > 0 ? 35 : 28, 'F');
      y += 7;
      doc.setFont(undefined, 'bold'); doc.setFontSize(11);
      doc.text('RIEPILOGO ECONOMICO', margin + 2, y); y += 7;
      doc.setFontSize(9); doc.setFont(undefined, 'normal');
      doc.text(`Acquisto: ${formatCurrencyLocal(purchaseCost)}`, margin + 2, y);
      doc.text(`Riparazioni: ${formatCurrencyLocal(worksCost)}`, margin + 50, y);
      doc.text(`Accessori: ${formatCurrencyLocal(accessoriesCost)}`, margin + 100, y);
      if (maintenanceCost > 0) { y += 6; doc.text(`Manutenzioni: ${formatCurrencyLocal(maintenanceCost)}`, margin + 2, y); }
      y += 7;
      doc.setFont(undefined, 'bold'); doc.setFontSize(10); doc.setTextColor(124, 184, 124);
      doc.text(`TOTALE INVESTITO: ${formatCurrencyLocal(totalCost)}`, margin + 2, y);
      doc.setFontSize(8); doc.setTextColor(150, 150, 150);
      doc.text(`Generato il ${formatDateLocal(new Date().toISOString())} - Collezione Vintage v5.0`, margin, 285);
      
      // Add PDF to ZIP
      const pdfBlob = doc.output('blob');
      zip.file(`${baseName}-scheda.pdf`, pdfBlob);
      
      // Generate ZIP
      const content = await zip.generateAsync({ type: 'blob' });
      const url = URL.createObjectURL(content);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${baseName}.zip`;
      a.click();
      URL.revokeObjectURL(url);
      return true;
    };

    // Tooltip Component
    function SmartTooltip({ children, content, style = {} }) {
      const [show, setShow] = useState(false);
      const [pos, setPos] = useState({ top: 0, left: 0 });
      const ref = useRef(null);
      const handleEnter = () => {
        if (!ref.current) return;
        const r = ref.current.getBoundingClientRect();
        setPos({ top: r.top - 50, left: Math.max(10, r.left - 80) });
        setShow(true);
      };
      if (!content) return children;
      return (
        <span ref={ref} onMouseEnter={handleEnter} onMouseLeave={() => setShow(false)} style={{ ...style, cursor: 'help' }}>
          {children}
          {show && ReactDOM.createPortal(
            <div style={{ position: 'fixed', top: pos.top, left: pos.left, maxWidth: 200, padding: '8px 12px', background: 'var(--bg-secondary)', border: '1px solid var(--border-medium)', borderRadius: 8, fontSize: 12, color: 'var(--text-secondary)', zIndex: 9999, boxShadow: '0 4px 16px rgba(0,0,0,0.3)' }}>{content}</div>,
            document.body
          )}
        </span>
      );
    }

    // Sortable Image Gallery
    function SortableImageGallery({ images, onChange, onOpenLightbox }) {
      const [dragIdx, setDragIdx] = useState(null);
      const [overIdx, setOverIdx] = useState(null);
      const handleDrop = (e, dropIdx) => {
        e.preventDefault();
        if (dragIdx === null || dragIdx === dropIdx) { setDragIdx(null); setOverIdx(null); return; }
        const newImgs = [...images];
        const dragged = newImgs[dragIdx];
        newImgs.splice(dragIdx, 1);
        newImgs.splice(dropIdx, 0, dragged);
        onChange(newImgs);
        setDragIdx(null); setOverIdx(null);
      };
      return (
        <div style={{ display: 'flex', flexWrap: 'wrap', gap: 10 }}>
          {images.map((img, i) => (
            <div key={i} draggable onDragStart={() => setDragIdx(i)} onDragOver={(e) => { e.preventDefault(); setOverIdx(i); }}
              onDragLeave={() => setOverIdx(null)} onDrop={(e) => handleDrop(e, i)} onDragEnd={() => { setDragIdx(null); setOverIdx(null); }}
              style={{ position: 'relative', opacity: dragIdx === i ? 0.5 : 1, transform: overIdx === i ? 'scale(1.1)' : 'scale(1)', transition: 'all 0.15s', cursor: 'grab' }}>
              <div onClick={() => onOpenLightbox(images, i)} style={{ width: 70, height: 70, borderRadius: 8, background: `url(${img}) center/cover`, border: overIdx === i ? '2px dashed var(--accent-primary)' : '1px solid var(--border-subtle)', cursor: 'zoom-in' }} />
              {i === 0 && <div style={{ position: 'absolute', bottom: 2, left: 2, fontSize: 9, padding: '2px 5px', background: 'var(--accent-primary)', color: '#fff', borderRadius: 4 }}>Copertina</div>}
              <button onClick={(e) => { e.stopPropagation(); onChange(images.filter((_, idx) => idx !== i)); }} style={{ position: 'absolute', top: -6, right: -6, width: 18, height: 18, borderRadius: '50%', background: 'var(--accent-danger)', border: 'none', color: '#fff', fontSize: 10, cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>Ã—</button>
            </div>
          ))}
        </div>
      );
    }

    // Economic Summary Component
    function EconomicSummary({ item }) {
      const purchase = item.purchaseCost || 0;
      const works = item.works?.reduce((s, w) => s + (w.cost || 0), 0) || 0;
      const accessories = item.accessories?.reduce((s, a) => s + (a.cost || 0), 0) || 0;
      const maintenance = item.scheduledChecks?.reduce((s, c) => s + (c.history?.reduce((h, e) => h + (e.cost || 0), 0) || 0), 0) || 0;
      const maintenanceCount = item.scheduledChecks?.reduce((s, c) => s + (c.history?.length || 0), 0) || 0;
      const total = purchase + works + accessories + maintenance;
      return (
        <div style={{ padding: 18, background: 'linear-gradient(135deg, var(--bg-card) 0%, var(--bg-tertiary) 100%)', borderRadius: 14, border: '1px solid var(--border-medium)' }}>
          <div style={{ fontWeight: 600, marginBottom: 14, display: 'flex', alignItems: 'center', gap: 10, fontSize: 16 }}><span style={{ fontSize: 22 }}>ðŸ’°</span> Riepilogo economico</div>
          <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: 12 }}>
            <div style={{ padding: 14, background: 'var(--bg-primary)', borderRadius: 10 }}>
              <div style={{ fontSize: 13, color: 'var(--text-muted)', marginBottom: 4 }}>ðŸ›’ Acquisto {item.purchaseYear && `(${item.purchaseYear})`}</div>
              <div style={{ fontSize: 20, fontWeight: 700, color: 'var(--accent-primary)' }}>{formatCurrency(purchase)}</div>
            </div>
            <div style={{ padding: 14, background: 'var(--bg-primary)', borderRadius: 10 }}>
              <div style={{ fontSize: 13, color: 'var(--text-muted)', marginBottom: 4 }}>ðŸ”§ Riparazioni ({item.works?.length || 0})</div>
              <div style={{ fontSize: 20, fontWeight: 700, color: 'var(--accent-work)' }}>{formatCurrency(works)}</div>
            </div>
            <div style={{ padding: 14, background: 'var(--bg-primary)', borderRadius: 10 }}>
              <div style={{ fontSize: 13, color: 'var(--text-muted)', marginBottom: 4 }}>ðŸ“¦ Accessori ({item.accessories?.length || 0})</div>
              <div style={{ fontSize: 20, fontWeight: 700, color: 'var(--accent-accessory)' }}>{formatCurrency(accessories)}</div>
            </div>
            <div style={{ padding: 14, background: 'var(--bg-primary)', borderRadius: 10 }}>
              <div style={{ fontSize: 13, color: 'var(--text-muted)', marginBottom: 4 }}>ðŸ”” Manutenzioni ({maintenanceCount})</div>
              <div style={{ fontSize: 20, fontWeight: 700, color: 'var(--accent-warning)' }}>{formatCurrency(maintenance)}</div>
            </div>
          </div>
          <div style={{ marginTop: 14, padding: 14, background: 'var(--accent-success-soft)', borderRadius: 10, border: '2px solid var(--accent-success)', textAlign: 'center' }}>
            <div style={{ fontSize: 13, color: 'var(--accent-success)', marginBottom: 4, fontWeight: 600 }}>ðŸ’Ž TOTALE INVESTITO</div>
            <div style={{ fontSize: 26, fontWeight: 700, color: 'var(--accent-success)' }}>{formatCurrency(total)}</div>
          </div>
        </div>
      );
    }

    // Generate Single Item PDF - Professional Layout
    const generateItemPDF = (item, brands, models, accessoryTypes, maintenanceTypes = [], showEconomics = true) => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('p', 'mm', 'a4');
      const brandName = brands.find(b => b.id === item.brandId)?.name || '-';
      const modelName = models.find(m => m.id === item.modelId)?.name || '-';
      const getTypeName = (typeId) => accessoryTypes.find(t => t.id === typeId)?.name || '-';
      const getMaintenanceTypeName = (typeId) => maintenanceTypes.find(t => t.id === typeId)?.name || '-';
      const pageWidth = 210;
      const pageHeight = 297;
      const margin = 15;
      const contentWidth = pageWidth - (margin * 2);
      const colWidth = (contentWidth - 10) / 2;
      const col1X = margin;
      const col2X = margin + colWidth + 10;
      
      // === HEADER - Golden bar ===
      doc.setFillColor(201, 168, 108);
      doc.rect(0, 0, pageWidth, 28, 'F');
      doc.setTextColor(30, 28, 24);
      doc.setFontSize(20);
      doc.setFont(undefined, 'bold');
      doc.text(brandName.toUpperCase(), margin, 12);
      doc.setFontSize(14);
      doc.setFont(undefined, 'normal');
      doc.text(`${modelName}${item.version ? ' - ' + item.version : ''}`, margin, 20);
      doc.setFontSize(9);
      doc.setTextColor(80, 70, 50);
      doc.text(`Scheda generata il ${formatDate(new Date().toISOString())}`, pageWidth - margin - 45, 24);
      
      doc.setTextColor(50, 50, 50);
      let y = 35;
      
      // === ROW 1: Image (left) + Machine Info (right) ===
      let leftY = y;
      let rightY = y;
      const imgWidth = colWidth;
      const imgHeight = 70;
      
      // LEFT: Image
      if (item.images?.[0]) {
        try {
          doc.addImage(item.images[0], 'WEBP', col1X, leftY, imgWidth, imgHeight);
        } catch(e) { 
          doc.setFillColor(248, 246, 242);
          doc.rect(col1X, leftY, imgWidth, imgHeight, 'F');
          doc.setDrawColor(220, 215, 205);
          doc.rect(col1X, leftY, imgWidth, imgHeight, 'S');
          doc.setFontSize(10);
          doc.setTextColor(160, 155, 145);
          doc.text('Immagine non disponibile', col1X + imgWidth/2 - 25, leftY + imgHeight/2);
        }
      } else {
        doc.setFillColor(248, 246, 242);
        doc.rect(col1X, leftY, imgWidth, imgHeight, 'F');
        doc.setDrawColor(220, 215, 205);
        doc.rect(col1X, leftY, imgWidth, imgHeight, 'S');
        doc.setFontSize(10);
        doc.setTextColor(160, 155, 145);
        doc.text('Nessuna immagine', col1X + imgWidth/2 - 20, leftY + imgHeight/2);
      }
      leftY += imgHeight + 5;
      
      // RIGHT: Machine details box
      doc.setFillColor(252, 250, 246);
      doc.rect(col2X, rightY, colWidth, imgHeight, 'F');
      doc.setDrawColor(220, 215, 200);
      doc.setLineWidth(0.3);
      doc.rect(col2X, rightY, colWidth, imgHeight, 'S');
      
      let infoY = rightY + 8;
      doc.setFontSize(10);
      doc.setFont(undefined, 'bold');
      doc.setTextColor(100, 90, 70);
      doc.text('INFORMAZIONI MACCHINA', col2X + 5, infoY);
      infoY += 8;
      
      doc.setFontSize(9);
      const infoFields = [
        ['Categoria:', item.category || '-'],
        ['Sottocategoria:', item.subcategory || '-'],
        ['Anno produzione:', item.year || '-'],
        ['N. Serie:', item.serialNumber || '-'],
        ['Ubicazione:', item.location || '-'],
        ['Anno acquisto:', item.purchaseYear || '-'],
      ];
      infoFields.forEach(([label, value]) => {
        doc.setFont(undefined, 'bold');
        doc.setTextColor(100, 95, 85);
        doc.text(label, col2X + 5, infoY);
        doc.setFont(undefined, 'normal');
        doc.setTextColor(50, 50, 50);
        doc.text(String(value).substring(0, 28), col2X + 35, infoY);
        infoY += 5.5;
      });
      
      // Status badges with labels
      infoY += 2;
      doc.setFontSize(9);
      doc.setFont(undefined, 'bold');
      doc.setTextColor(100, 95, 85);
      doc.text('Stato:', col2X + 5, infoY);
      const statusColor = item.status === 'Funzionante' ? [80, 150, 80] : item.status === 'Da restaurare' ? [180, 90, 90] : [150, 135, 100];
      doc.setFillColor(...statusColor);
      doc.roundedRect(col2X + 22, infoY - 5, 38, 7, 1.5, 1.5, 'F');
      doc.setFontSize(8);
      doc.setTextColor(255, 255, 255);
      doc.text(item.status || '-', col2X + 25, infoY - 0.5);
      
      if (item.aestheticGrade) {
        infoY += 9;
        doc.setFontSize(9);
        doc.setTextColor(100, 95, 85);
        doc.text('Grado:', col2X + 5, infoY);
        doc.setFillColor(70, 110, 160);
        doc.roundedRect(col2X + 22, infoY - 5, 38, 7, 1.5, 1.5, 'F');
        doc.setFontSize(8);
        doc.setTextColor(255, 255, 255);
        doc.text(item.aestheticGrade, col2X + 25, infoY - 0.5);
      }
      
      rightY += imgHeight + 5;
      y = Math.max(leftY, rightY);
      doc.setTextColor(50, 50, 50);
      
      // === ROW 2: Description (full width) ===
      if (item.description) {
        doc.setFillColor(252, 251, 248);
        doc.rect(margin, y, contentWidth, 5, 'F');
        doc.setFontSize(10);
        doc.setFont(undefined, 'bold');
        doc.setTextColor(120, 100, 70);
        doc.text('DESCRIZIONE', margin + 3, y + 3.5);
        y += 7;
        
        doc.setFont(undefined, 'normal');
        doc.setTextColor(50, 50, 50);
        doc.setFontSize(9);
        const descLines = doc.splitTextToSize(item.description, contentWidth - 6);
        doc.text(descLines.slice(0, 5), margin + 3, y);
        y += Math.min(descLines.length, 5) * 4.5 + 3;
      }
      
      // === ROW 3: Defects (full width like description) ===
      if (item.defectFound) {
        doc.setFillColor(255, 245, 245);
        doc.rect(margin, y, contentWidth, 5, 'F');
        doc.setFontSize(10);
        doc.setFont(undefined, 'bold');
        doc.setTextColor(180, 80, 80);
        doc.text('DIFETTI RISCONTRATI', margin + 3, y + 3.5);
        y += 7;
        
        doc.setFont(undefined, 'normal');
        doc.setTextColor(80, 60, 60);
        doc.setFontSize(9);
        const defLines = doc.splitTextToSize(item.defectFound, contentWidth - 6);
        doc.text(defLines.slice(0, 5), margin + 3, y);
        y += Math.min(defLines.length, 5) * 4 + 3;
      }
      
      // === ROW 4: Notes (full width) ===
      if (item.notes) {
        doc.setFillColor(255, 252, 240);
        doc.rect(margin, y, contentWidth, 5, 'F');
        doc.setFontSize(10);
        doc.setFont(undefined, 'bold');
        doc.setTextColor(180, 140, 60);
        doc.text('NOTE', margin + 3, y + 3.5);
        y += 7;
        
        doc.setFont(undefined, 'normal');
        doc.setTextColor(80, 70, 50);
        doc.setFontSize(9);
        const noteLines = doc.splitTextToSize(item.notes, contentWidth - 6);
        doc.text(noteLines.slice(0, 4), margin + 3, y);
        y += Math.min(noteLines.length, 4) * 4 + 3;
      }
      
      // === ROW 5: Repairs (left) + Accessories (right) ===
      const hasWorks = item.works?.length > 0;
      const hasAccessories = item.accessories?.length > 0;
      
      if (hasWorks || hasAccessories) {
        if (y > 230) { doc.addPage(); y = 15; }
        leftY = y;
        rightY = y;
        
        if (hasWorks) {
          const worksCost = item.works.reduce((s, w) => s + (w.cost || 0), 0);
          doc.setFillColor(245, 240, 255);
          doc.rect(col1X, leftY, colWidth, 6, 'F');
          doc.setFontSize(10);
          doc.setFont(undefined, 'bold');
          doc.setTextColor(120, 90, 170);
          doc.text(`RIPARAZIONI (${item.works.length})`, col1X + 3, leftY + 4.5);
          if (showEconomics) {
            doc.text(formatCurrency(worksCost), col1X + colWidth - 3, leftY + 4.5, { align: 'right' });
          }
          leftY += 9;
          
          doc.setFontSize(9);
          doc.setFont(undefined, 'normal');
          doc.setTextColor(60, 50, 70);
          item.works.slice(0, 6).forEach(w => {
            doc.text(`${formatDate(w.date)} - ${w.description.substring(0, 30)}`, col1X + 3, leftY);
            if (showEconomics) {
              doc.setFont(undefined, 'bold');
              doc.text(formatCurrency(w.cost), col1X + colWidth - 3, leftY, { align: 'right' });
              doc.setFont(undefined, 'normal');
            }
            leftY += 4.5;
          });
          if (item.works.length > 6) {
            doc.setFont(undefined, 'italic');
            doc.setTextColor(120, 115, 105);
            doc.text(`... e altre ${item.works.length - 6} riparazioni`, col1X + 3, leftY);
            leftY += 4.5;
          }
        }
        
        if (hasAccessories) {
          const accCost = item.accessories.reduce((s, a) => s + (a.cost || 0), 0);
          doc.setFillColor(255, 248, 240);
          doc.rect(col2X, rightY, colWidth, 6, 'F');
          doc.setFontSize(10);
          doc.setFont(undefined, 'bold');
          doc.setTextColor(200, 130, 70);
          doc.text(`ACCESSORI (${item.accessories.length})`, col2X + 3, rightY + 4.5);
          if (showEconomics) {
            doc.text(formatCurrency(accCost), col2X + colWidth - 3, rightY + 4.5, { align: 'right' });
          }
          rightY += 9;
          
          doc.setFontSize(9);
          doc.setFont(undefined, 'normal');
          doc.setTextColor(80, 60, 40);
          item.accessories.slice(0, 6).forEach(a => {
            doc.text(`${a.name.substring(0, 25)} (${getTypeName(a.typeId).substring(0, 10)})`, col2X + 3, rightY);
            if (showEconomics) {
              doc.setFont(undefined, 'bold');
              doc.text(formatCurrency(a.cost), col2X + colWidth - 3, rightY, { align: 'right' });
              doc.setFont(undefined, 'normal');
            }
            rightY += 4.5;
          });
          if (item.accessories.length > 6) {
            doc.setFont(undefined, 'italic');
            doc.setTextColor(120, 115, 105);
            doc.text(`... e altri ${item.accessories.length - 6} accessori`, col2X + 3, rightY);
            rightY += 4.5;
          }
        }
        
        y = Math.max(leftY, rightY) + 4;
      }
      
      // === ROW 5: Scheduled Maintenance (left) + History (right) ===
      const activeChecks = item.scheduledChecks?.filter(c => !c.isCompleted) || [];
      const allHistory = [];
      item.scheduledChecks?.forEach(check => {
        check.history?.forEach(h => {
          allHistory.push({ ...h, checkName: getMaintenanceTypeName(check.maintenanceTypeId), isRecursive: check.isRecursive !== false });
        });
      });
      allHistory.sort((a, b) => new Date(b.date) - new Date(a.date));
      
      if (activeChecks.length > 0 || allHistory.length > 0) {
        if (y > 230) { doc.addPage(); y = 15; }
        leftY = y;
        rightY = y;
        
        if (activeChecks.length > 0) {
          doc.setFillColor(255, 252, 240);
          doc.rect(col1X, leftY, colWidth, 6, 'F');
          doc.setFontSize(10);
          doc.setFont(undefined, 'bold');
          doc.setTextColor(180, 140, 60);
          doc.text(`CONTROLLI PROGRAMMATI (${activeChecks.length})`, col1X + 3, leftY + 4.5);
          leftY += 9;
          
          doc.setFontSize(9);
          doc.setFont(undefined, 'normal');
          
          activeChecks.slice(0, 5).forEach(check => {
            const today = new Date(); today.setHours(0, 0, 0, 0);
            const nextDate = check.nextCheckDate ? new Date(check.nextCheckDate) : null;
            if (nextDate) nextDate.setHours(0, 0, 0, 0);
            const daysUntil = nextDate ? Math.ceil((nextDate - today) / (1000 * 60 * 60 * 24)) : null;
            const isOverdue = daysUntil !== null && daysUntil < 0;
            
            if (isOverdue) doc.setTextColor(180, 60, 60);
            else if (daysUntil !== null && daysUntil <= (check.warningDays || 30)) doc.setTextColor(180, 130, 40);
            else doc.setTextColor(60, 60, 60);
            
            const status = isOverdue ? `SCADUTO ${Math.abs(daysUntil)}gg` : daysUntil !== null ? `tra ${daysUntil}gg` : '';
            doc.text(`${getMaintenanceTypeName(check.maintenanceTypeId).substring(0, 25)}`, col1X + 3, leftY);
            doc.setFont(undefined, 'bold');
            doc.text(status, col1X + colWidth - 25, leftY);
            doc.setFont(undefined, 'normal');
            leftY += 4.5;
          });
          doc.setTextColor(50, 50, 50);
        }
        
        if (allHistory.length > 0) {
          const historyCost = allHistory.reduce((s, h) => s + (h.cost || 0), 0);
          doc.setFillColor(245, 255, 245);
          doc.rect(col2X, rightY, colWidth, 6, 'F');
          doc.setFontSize(10);
          doc.setFont(undefined, 'bold');
          doc.setTextColor(80, 140, 80);
          doc.text(`STORICO MANUTENZIONI (${allHistory.length})`, col2X + 3, rightY + 4.5);
          if (showEconomics) {
            doc.text(formatCurrency(historyCost), col2X + colWidth - 3, rightY + 4.5, { align: 'right' });
          }
          rightY += 9;
          
          doc.setFontSize(9);
          doc.setFont(undefined, 'normal');
          doc.setTextColor(50, 70, 50);
          
          allHistory.slice(0, 5).forEach(h => {
            const tag = !h.isRecursive ? ' [1x]' : '';
            doc.text(`${formatDate(h.date)} - ${h.checkName.substring(0, 18)}${tag}`, col2X + 3, rightY);
            if (showEconomics) {
              doc.setFont(undefined, 'bold');
              doc.text(formatCurrency(h.cost), col2X + colWidth - 3, rightY, { align: 'right' });
              doc.setFont(undefined, 'normal');
            }
            rightY += 4.5;
          });
          if (allHistory.length > 5) {
            doc.setFont(undefined, 'italic');
            doc.setTextColor(120, 115, 105);
            doc.text(`... e altri ${allHistory.length - 5} interventi`, col2X + 3, rightY);
            rightY += 4.5;
          }
        }
        
        y = Math.max(leftY, rightY) + 5;
      }
      
      // === ECONOMIC SUMMARY - FULL WIDTH ===
      if (showEconomics) {
        if (y > 255) { doc.addPage(); y = 15; }
        
        const purchaseCost = item.purchaseCost || 0;
        const worksCost = item.works?.reduce((s, w) => s + (w.cost || 0), 0) || 0;
        const accessoriesCost = item.accessories?.reduce((s, a) => s + (a.cost || 0), 0) || 0;
        const maintenanceCost = item.scheduledChecks?.reduce((s, c) => s + (c.history?.reduce((h, e) => h + (e.cost || 0), 0) || 0), 0) || 0;
        const totalCost = purchaseCost + worksCost + accessoriesCost + maintenanceCost;
        
        doc.setFillColor(252, 250, 244);
        doc.rect(margin, y, contentWidth, 28, 'F');
        doc.setDrawColor(201, 168, 108);
        doc.setLineWidth(0.8);
        doc.rect(margin, y, contentWidth, 28, 'S');
        
        doc.setFontSize(10);
        doc.setFont(undefined, 'bold');
        doc.setTextColor(150, 125, 80);
        doc.text('RIEPILOGO ECONOMICO', margin + 5, y + 6);
        
        // First row - 4 costs evenly spaced
        doc.setFontSize(9);
        doc.setFont(undefined, 'normal');
        doc.setTextColor(80, 75, 65);
        const econY1 = y + 14;
        const colSpacing = contentWidth / 4;
        doc.text(`Acquisto: ${formatCurrency(purchaseCost)}`, margin + 5, econY1);
        doc.text(`Riparazioni: ${formatCurrency(worksCost)}`, margin + colSpacing + 5, econY1);
        doc.text(`Accessori: ${formatCurrency(accessoriesCost)}`, margin + colSpacing * 2 + 5, econY1);
        doc.text(`Manutenzioni: ${formatCurrency(maintenanceCost)}`, margin + colSpacing * 3 + 5, econY1);
        
        // Second row - Total right-aligned
        doc.setFont(undefined, 'bold');
        doc.setFontSize(12);
        doc.setTextColor(60, 130, 60);
        doc.text(`TOTALE INVESTITO: ${formatCurrency(totalCost)}`, pageWidth - margin - 5, y + 23, { align: 'right' });
        
        y += 32;
      }
      
      // === FOOTER ===
      doc.setFontSize(8);
      doc.setTextColor(150, 145, 135);
      doc.setFont(undefined, 'normal');
      doc.text('Collezione Vintage Manager v5.0', margin, pageHeight - 8);
      doc.text(`ID: ${item.id.substring(0, 8)}`, pageWidth - margin - 22, pageHeight - 8);
      
      // Save with detailed filename including serial if available
      const fileNameParts = [brandName, modelName];
      if (item.version) fileNameParts.push(item.version);
      if (item.serialNumber) fileNameParts.push(`SN-${item.serialNumber}`);
      const fileName = `scheda-${fileNameParts.join('-')}`.replace(/[^a-z0-9\-]/gi, '-').replace(/--+/g, '-').toLowerCase();
      doc.save(`${fileName}.pdf`);
    };

    // Works Popup
    function WorksPopup({ item, works, onClose, onSave, brands, models }) {
      const [localWorks, setLocalWorks] = useState(works || []);
      const [showAdd, setShowAdd] = useState(false);
      const [newWork, setNewWork] = useState({ description: '', cost: 0, date: new Date().toISOString().split('T')[0], images: [], notes: '' });
      const [editingId, setEditingId] = useState(null);

      const totalCost = localWorks.reduce((s, w) => s + (w.cost || 0), 0);
      const brandName = brands.find(b => b.id === item.brandId)?.name || '-';
      const modelName = models.find(m => m.id === item.modelId)?.name || '-';
      const inputStyle = { width: '100%', padding: '14px 16px', border: '1px solid var(--border-medium)', borderRadius: 10, background: 'var(--bg-tertiary)', color: 'var(--text-primary)', fontSize: 15, fontFamily: 'inherit' };
      const btnStyle = { padding: '12px 18px', borderRadius: 10, border: 'none', cursor: 'pointer', fontSize: 14, fontWeight: 500, fontFamily: 'inherit', display: 'inline-flex', alignItems: 'center', gap: 8 };

      const handleAdd = () => {
        if (!newWork.description.trim()) return;
        setLocalWorks([...localWorks, { ...newWork, id: generateId() }]);
        setNewWork({ description: '', cost: 0, date: new Date().toISOString().split('T')[0], images: [], notes: '' });
        setShowAdd(false);
      };
      const handleImgUpload = async (e) => {
        const files = Array.from(e.target.files);
        const imgs = await Promise.all(files.map(f => convertToWebP(f)));
        setNewWork({ ...newWork, images: [...newWork.images, ...imgs] });
      };

      return (
        <div style={{ position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.85)', backdropFilter: 'blur(8px)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 300, padding: 20 }} onClick={onClose}>
          <div style={{ width: '100%', maxWidth: 900, maxHeight: '90vh', overflowY: 'auto', background: 'var(--bg-secondary)', borderRadius: 16, border: '1px solid var(--border-medium)', boxShadow: '0 25px 80px rgba(0,0,0,0.5)' }} onClick={(e) => e.stopPropagation()}>
            <div style={{ padding: '20px 24px', borderBottom: '1px solid var(--border-subtle)', display: 'flex', alignItems: 'center', justifyContent: 'space-between', background: 'var(--accent-work-soft)' }}>
              <div>
                <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 4 }}><span style={{ fontSize: 20 }}>ðŸ”§</span><h2 style={{ margin: 0, fontSize: 18 }}>Riparazioni</h2></div>
                <div style={{ fontSize: 13, color: 'var(--text-secondary)' }}>{brandName} {modelName}{item.version ? ` (${item.version})` : ''}</div>
              </div>
              <div style={{ display: 'flex', alignItems: 'center', gap: 16 }}>
                <div style={{ textAlign: 'right' }}>
                  <div style={{ fontSize: 20, fontWeight: 700, color: 'var(--accent-work)' }}>{formatCurrency(totalCost)}</div>
                  <div style={{ fontSize: 11, color: 'var(--text-muted)' }}>{localWorks.length} riparazioni</div>
                </div>
                <button onClick={onClose} style={{ width: 36, height: 36, borderRadius: 8, background: 'var(--bg-tertiary)', border: 'none', color: 'var(--text-muted)', cursor: 'pointer', fontSize: 18 }}>Ã—</button>
              </div>
            </div>
            <div style={{ padding: 24 }}>
              {localWorks.length > 0 && <div style={{ display: 'flex', flexDirection: 'column', gap: 12, marginBottom: 20 }}>
                {localWorks.map(w => (
                  <div key={w.id} style={{ padding: 16, background: 'var(--bg-card)', borderRadius: 12, border: '1px solid var(--border-subtle)' }}>
                    {editingId === w.id ? (
                      <div style={{ display: 'flex', flexDirection: 'column', gap: 10 }}>
                        <input value={w.description} onChange={(e) => setLocalWorks(localWorks.map(x => x.id === w.id ? { ...x, description: e.target.value } : x))} style={inputStyle} placeholder="Descrizione" />
                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 10 }}>
                          <input type="number" value={w.cost} onChange={(e) => setLocalWorks(localWorks.map(x => x.id === w.id ? { ...x, cost: parseFloat(e.target.value) || 0 } : x))} style={inputStyle} placeholder="Costo â‚¬" step="0.01" />
                          <input type="date" value={w.date} onChange={(e) => setLocalWorks(localWorks.map(x => x.id === w.id ? { ...x, date: e.target.value } : x))} style={inputStyle} />
                        </div>
                        <textarea value={w.notes || ''} onChange={(e) => setLocalWorks(localWorks.map(x => x.id === w.id ? { ...x, notes: e.target.value } : x))} style={{ ...inputStyle, resize: 'vertical' }} rows={2} placeholder="Note..." />
                        {/* Photo management in edit mode */}
                        <div style={{ display: 'flex', alignItems: 'center', gap: 10, flexWrap: 'wrap' }}>
                          <label style={{ display: 'inline-flex', alignItems: 'center', gap: 6, padding: '8px 14px', background: 'var(--bg-tertiary)', borderRadius: 8, cursor: 'pointer', fontSize: 12, color: 'var(--text-secondary)' }}>
                            ðŸ“· Aggiungi foto
                            <input type="file" accept="image/*" multiple onChange={async (e) => {
                              const files = Array.from(e.target.files);
                              const imgs = await Promise.all(files.map(f => convertToWebP(f)));
                              setLocalWorks(localWorks.map(x => x.id === w.id ? { ...x, images: [...(x.images || []), ...imgs] } : x));
                            }} style={{ display: 'none' }} />
                          </label>
                          {w.images?.length > 0 && <span style={{ fontSize: 11, color: 'var(--text-muted)' }}>{w.images.length} foto</span>}
                        </div>
                        {w.images?.length > 0 && (
                          <div style={{ display: 'flex', gap: 8, flexWrap: 'wrap' }}>
                            {w.images.map((img, i) => (
                              <div key={i} style={{ position: 'relative' }}>
                                <div style={{ width: 60, height: 60, borderRadius: 8, background: `url(${img}) center/cover`, border: '1px solid var(--border-subtle)' }} />
                                <button onClick={() => setLocalWorks(localWorks.map(x => x.id === w.id ? { ...x, images: x.images.filter((_, idx) => idx !== i) } : x))} style={{ position: 'absolute', top: -6, right: -6, width: 20, height: 20, borderRadius: '50%', background: 'var(--accent-danger)', border: 'none', color: '#fff', fontSize: 12, cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>Ã—</button>
                              </div>
                            ))}
                          </div>
                        )}
                        <button onClick={() => setEditingId(null)} style={{ ...btnStyle, background: 'var(--accent-success)', color: '#fff' }}>âœ“ Fatto</button>
                      </div>
                    ) : (
                      <div style={{ display: 'flex', alignItems: 'flex-start', justifyContent: 'space-between', gap: 12 }}>
                        <div style={{ flex: 1 }}>
                          <div style={{ fontWeight: 600, marginBottom: 4 }}>{w.description}</div>
                          <div style={{ fontSize: 12, color: 'var(--text-muted)' }}>{formatDate(w.date)}</div>
                          {w.notes && <div style={{ fontSize: 12, color: 'var(--text-secondary)', marginTop: 6, fontStyle: 'italic' }}>{w.notes}</div>}
                          {w.images?.length > 0 && <div style={{ display: 'flex', gap: 6, marginTop: 10 }}>{w.images.map((img, i) => <div key={i} style={{ width: 40, height: 40, borderRadius: 6, background: `url(${img}) center/cover`, border: '1px solid var(--border-subtle)' }} />)}</div>}
                        </div>
                        <div style={{ textAlign: 'right' }}>
                          <div style={{ fontSize: 16, fontWeight: 700, color: 'var(--accent-work)' }}>{formatCurrency(w.cost)}</div>
                          <div style={{ display: 'flex', gap: 6, marginTop: 8 }}>
                            <button onClick={() => setEditingId(w.id)} title="Modifica" style={{ ...btnStyle, padding: '6px 10px', background: 'var(--accent-info-soft)', color: 'var(--accent-info)', fontSize: 11 }}>âœï¸</button>
                            <button onClick={() => setLocalWorks(localWorks.filter(x => x.id !== w.id))} title="Elimina" style={{ ...btnStyle, padding: '6px 10px', background: 'var(--accent-danger-soft)', color: 'var(--accent-danger)', fontSize: 11 }}>ðŸ—‘ï¸</button>
                          </div>
                        </div>
                      </div>
                    )}
                  </div>
                ))}
              </div>}
              {localWorks.length === 0 && !showAdd && <div style={{ textAlign: 'center', padding: 40, color: 'var(--text-muted)' }}><div style={{ fontSize: 40, marginBottom: 12, opacity: 0.5 }}>ðŸ”§</div><div>Nessuna riparazione</div></div>}
              {showAdd && (
                <div style={{ padding: 20, background: 'var(--bg-card)', borderRadius: 12, border: '2px solid var(--accent-work)', marginBottom: 16 }}>
                  <div style={{ fontWeight: 600, marginBottom: 16, color: 'var(--accent-work)' }}>âž• Nuova riparazione</div>
                  <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr 1fr', gap: 12, marginBottom: 12 }}>
                    <input value={newWork.description} onChange={(e) => setNewWork({ ...newWork, description: e.target.value })} style={inputStyle} placeholder="Descrizione *" autoFocus />
                    <input type="number" value={newWork.cost} onChange={(e) => setNewWork({ ...newWork, cost: parseFloat(e.target.value) || 0 })} style={inputStyle} placeholder="Costo â‚¬" step="0.01" />
                    <input type="date" value={newWork.date} onChange={(e) => setNewWork({ ...newWork, date: e.target.value })} style={inputStyle} />
                  </div>
                  <div style={{ display: 'grid', gridTemplateColumns: '1fr auto auto', gap: 12, alignItems: 'start' }}>
                    <textarea value={newWork.notes} onChange={(e) => setNewWork({ ...newWork, notes: e.target.value })} style={{ ...inputStyle, resize: 'vertical' }} rows={2} placeholder="Note..." />
                    <label style={{ display: 'inline-flex', alignItems: 'center', gap: 8, padding: '12px 16px', background: 'var(--bg-tertiary)', borderRadius: 8, cursor: 'pointer', fontSize: 12, color: 'var(--text-secondary)', height: 'fit-content' }}>ðŸ“· Foto<input type="file" accept="image/*" multiple onChange={handleImgUpload} style={{ display: 'none' }} /></label>
                    <div style={{ display: 'flex', gap: 8 }}>
                      <button onClick={handleAdd} disabled={!newWork.description.trim()} style={{ ...btnStyle, background: newWork.description.trim() ? 'var(--accent-work)' : 'var(--bg-tertiary)', color: newWork.description.trim() ? '#fff' : 'var(--text-muted)' }}>âœ“ Aggiungi</button>
                      <button onClick={() => { setShowAdd(false); setNewWork({ description: '', cost: 0, date: new Date().toISOString().split('T')[0], images: [], notes: '' }); }} style={{ ...btnStyle, background: 'var(--bg-tertiary)', color: 'var(--text-secondary)' }}>âœ•</button>
                    </div>
                  </div>
                  {newWork.images.length > 0 && <div style={{ display: 'flex', gap: 8, flexWrap: 'wrap', marginTop: 12 }}>{newWork.images.map((img, i) => <div key={i} style={{ position: 'relative' }}><div style={{ width: 50, height: 50, borderRadius: 6, background: `url(${img}) center/cover` }} /><button onClick={() => setNewWork({ ...newWork, images: newWork.images.filter((_, idx) => idx !== i) })} style={{ position: 'absolute', top: -6, right: -6, width: 18, height: 18, borderRadius: '50%', background: 'var(--accent-danger)', border: 'none', color: '#fff', fontSize: 10, cursor: 'pointer' }}>Ã—</button></div>)}</div>}
                </div>
              )}
              {!showAdd && <button onClick={() => setShowAdd(true)} style={{ ...btnStyle, marginTop: 16, background: 'var(--accent-work)', color: '#fff', width: '100%', justifyContent: 'center' }}>+ Aggiungi riparazione</button>}
              <div style={{ display: 'flex', gap: 12, marginTop: 24, paddingTop: 20, borderTop: '1px solid var(--border-subtle)' }}>
                <button onClick={() => { onSave(localWorks); onClose(); }} style={{ ...btnStyle, flex: 1, justifyContent: 'center', background: 'var(--accent-success)', color: '#fff', padding: '14px 20px' }}>ðŸ’¾ Salva</button>
                <button onClick={onClose} style={{ ...btnStyle, flex: 1, justifyContent: 'center', background: 'var(--bg-tertiary)', color: 'var(--text-secondary)', padding: '14px 20px' }}>Annulla</button>
              </div>
            </div>
          </div>
        </div>
      );
    }

    // Accessories Popup
    function AccessoriesPopup({ item, accessories, onClose, onSave, brands, models, accessoryTypes }) {
      const [localAcc, setLocalAcc] = useState(accessories || []);
      const [showAdd, setShowAdd] = useState(false);
      const [newAcc, setNewAcc] = useState({ name: '', typeId: accessoryTypes[0]?.id || '', cost: 0, status: 'Presente', images: [], notes: '' });
      const [editingId, setEditingId] = useState(null);

      const totalCost = localAcc.reduce((s, a) => s + (a.cost || 0), 0);
      const brandName = brands.find(b => b.id === item.brandId)?.name || '-';
      const modelName = models.find(m => m.id === item.modelId)?.name || '-';
      const getStatusColor = (status) => accessoryStatuses.find(s => s.name === status)?.color || '#8a7e6d';
      const getTypeInfo = (typeId) => accessoryTypes.find(t => t.id === typeId) || { name: '-', icon: 'ðŸ“¦' };
      const inputStyle = { width: '100%', padding: '14px 16px', border: '1px solid var(--border-medium)', borderRadius: 10, background: 'var(--bg-tertiary)', color: 'var(--text-primary)', fontSize: 15, fontFamily: 'inherit' };
      const btnStyle = { padding: '12px 18px', borderRadius: 10, border: 'none', cursor: 'pointer', fontSize: 14, fontWeight: 500, fontFamily: 'inherit', display: 'inline-flex', alignItems: 'center', gap: 8 };

      const handleAdd = () => {
        if (!newAcc.name.trim()) return;
        setLocalAcc([...localAcc, { ...newAcc, id: generateId() }]);
        setNewAcc({ name: '', typeId: accessoryTypes[0]?.id || '', cost: 0, status: 'Presente', images: [], notes: '' });
        setShowAdd(false);
      };
      const handleImgUpload = async (e) => {
        const files = Array.from(e.target.files);
        const imgs = await Promise.all(files.map(f => convertToWebP(f)));
        setNewAcc({ ...newAcc, images: [...newAcc.images, ...imgs] });
      };

      return (
        <div style={{ position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.85)', backdropFilter: 'blur(8px)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 300, padding: 20 }} onClick={onClose}>
          <div style={{ width: '100%', maxWidth: 900, maxHeight: '90vh', overflowY: 'auto', background: 'var(--bg-secondary)', borderRadius: 16, border: '1px solid var(--border-medium)', boxShadow: '0 25px 80px rgba(0,0,0,0.5)' }} onClick={(e) => e.stopPropagation()}>
            <div style={{ padding: '20px 24px', borderBottom: '1px solid var(--border-subtle)', display: 'flex', alignItems: 'center', justifyContent: 'space-between', background: 'var(--accent-accessory-soft)' }}>
              <div>
                <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 4 }}><span style={{ fontSize: 20 }}>ðŸ“¦</span><h2 style={{ margin: 0, fontSize: 18 }}>Accessori</h2></div>
                <div style={{ fontSize: 13, color: 'var(--text-secondary)' }}>{brandName} {modelName}{item.version ? ` (${item.version})` : ''}</div>
              </div>
              <div style={{ display: 'flex', alignItems: 'center', gap: 16 }}>
                <div style={{ textAlign: 'right' }}>
                  <div style={{ fontSize: 20, fontWeight: 700, color: 'var(--accent-accessory)' }}>{formatCurrency(totalCost)}</div>
                  <div style={{ fontSize: 11, color: 'var(--text-muted)' }}>{localAcc.length} accessori</div>
                </div>
                <button onClick={onClose} style={{ width: 36, height: 36, borderRadius: 8, background: 'var(--bg-tertiary)', border: 'none', color: 'var(--text-muted)', cursor: 'pointer', fontSize: 18 }}>Ã—</button>
              </div>
            </div>
            <div style={{ padding: 24 }}>
              {localAcc.length > 0 && <div style={{ display: 'flex', flexDirection: 'column', gap: 12, marginBottom: 20 }}>
                {localAcc.map(a => {
                  const typeInfo = getTypeInfo(a.typeId);
                  return (
                  <div key={a.id} style={{ padding: 16, background: 'var(--bg-card)', borderRadius: 12, border: '1px solid var(--border-subtle)' }}>
                    {editingId === a.id ? (
                      <div style={{ display: 'flex', flexDirection: 'column', gap: 10 }}>
                        <input value={a.name} onChange={(e) => setLocalAcc(localAcc.map(x => x.id === a.id ? { ...x, name: e.target.value } : x))} style={inputStyle} placeholder="Nome accessorio" />
                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: 10 }}>
                          <select value={a.typeId} onChange={(e) => setLocalAcc(localAcc.map(x => x.id === a.id ? { ...x, typeId: e.target.value } : x))} style={inputStyle}>{accessoryTypes.map(t => <option key={t.id} value={t.id}>{t.icon} {t.name}</option>)}</select>
                          <input type="number" value={a.cost} onChange={(e) => setLocalAcc(localAcc.map(x => x.id === a.id ? { ...x, cost: parseFloat(e.target.value) || 0 } : x))} style={inputStyle} placeholder="Costo â‚¬" step="0.01" />
                          <select value={a.status} onChange={(e) => setLocalAcc(localAcc.map(x => x.id === a.id ? { ...x, status: e.target.value } : x))} style={inputStyle}>{accessoryStatuses.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}</select>
                        </div>
                        <textarea value={a.notes || ''} onChange={(e) => setLocalAcc(localAcc.map(x => x.id === a.id ? { ...x, notes: e.target.value } : x))} style={{ ...inputStyle, resize: 'vertical' }} rows={2} placeholder="Note..." />
                        {/* Photo management in edit mode */}
                        <div style={{ display: 'flex', alignItems: 'center', gap: 10, flexWrap: 'wrap' }}>
                          <label style={{ display: 'inline-flex', alignItems: 'center', gap: 6, padding: '8px 14px', background: 'var(--bg-tertiary)', borderRadius: 8, cursor: 'pointer', fontSize: 12, color: 'var(--text-secondary)' }}>
                            ðŸ“· Aggiungi foto
                            <input type="file" accept="image/*" multiple onChange={async (e) => {
                              const files = Array.from(e.target.files);
                              const imgs = await Promise.all(files.map(f => convertToWebP(f)));
                              setLocalAcc(localAcc.map(x => x.id === a.id ? { ...x, images: [...(x.images || []), ...imgs] } : x));
                            }} style={{ display: 'none' }} />
                          </label>
                          {a.images?.length > 0 && <span style={{ fontSize: 11, color: 'var(--text-muted)' }}>{a.images.length} foto</span>}
                        </div>
                        {a.images?.length > 0 && (
                          <div style={{ display: 'flex', gap: 8, flexWrap: 'wrap' }}>
                            {a.images.map((img, i) => (
                              <div key={i} style={{ position: 'relative' }}>
                                <div style={{ width: 60, height: 60, borderRadius: 8, background: `url(${img}) center/cover`, border: '1px solid var(--border-subtle)' }} />
                                <button onClick={() => setLocalAcc(localAcc.map(x => x.id === a.id ? { ...x, images: x.images.filter((_, idx) => idx !== i) } : x))} style={{ position: 'absolute', top: -6, right: -6, width: 20, height: 20, borderRadius: '50%', background: 'var(--accent-danger)', border: 'none', color: '#fff', fontSize: 12, cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>Ã—</button>
                              </div>
                            ))}
                          </div>
                        )}
                        <button onClick={() => setEditingId(null)} style={{ ...btnStyle, background: 'var(--accent-success)', color: '#fff' }}>âœ“ Fatto</button>
                      </div>
                    ) : (
                      <div style={{ display: 'flex', alignItems: 'flex-start', justifyContent: 'space-between', gap: 12 }}>
                        <div style={{ flex: 1 }}>
                          <div style={{ display: 'flex', alignItems: 'center', gap: 10, marginBottom: 6 }}>
                            <span style={{ fontSize: 18 }}>{typeInfo.icon}</span>
                            <span style={{ fontWeight: 600 }}>{a.name}</span>
                            <span style={{ fontSize: 11, padding: '3px 10px', background: `${getStatusColor(a.status)}20`, color: getStatusColor(a.status), borderRadius: 6, fontWeight: 500 }}>{a.status}</span>
                          </div>
                          <div style={{ fontSize: 12, color: 'var(--text-muted)' }}>Tipo: {typeInfo.name}</div>
                          {a.notes && <div style={{ fontSize: 12, color: 'var(--text-secondary)', marginTop: 6, fontStyle: 'italic' }}>{a.notes}</div>}
                          {a.images?.length > 0 && <div style={{ display: 'flex', gap: 6, marginTop: 10 }}>{a.images.map((img, i) => <div key={i} style={{ width: 40, height: 40, borderRadius: 6, background: `url(${img}) center/cover`, border: '1px solid var(--border-subtle)' }} />)}</div>}
                        </div>
                        <div style={{ textAlign: 'right' }}>
                          <div style={{ fontSize: 16, fontWeight: 700, color: 'var(--accent-accessory)' }}>{formatCurrency(a.cost)}</div>
                          <div style={{ display: 'flex', gap: 6, marginTop: 8 }}>
                            <button onClick={() => setEditingId(a.id)} title="Modifica" style={{ ...btnStyle, padding: '6px 10px', background: 'var(--accent-info-soft)', color: 'var(--accent-info)', fontSize: 11 }}>âœï¸</button>
                            <button onClick={() => setLocalAcc(localAcc.filter(x => x.id !== a.id))} title="Elimina" style={{ ...btnStyle, padding: '6px 10px', background: 'var(--accent-danger-soft)', color: 'var(--accent-danger)', fontSize: 11 }}>ðŸ—‘ï¸</button>
                          </div>
                        </div>
                      </div>
                    )}
                  </div>
                );})}
              </div>}
              {localAcc.length === 0 && !showAdd && <div style={{ textAlign: 'center', padding: 40, color: 'var(--text-muted)' }}><div style={{ fontSize: 40, marginBottom: 12, opacity: 0.5 }}>ðŸ“¦</div><div>Nessun accessorio</div></div>}
              {showAdd && (
                <div style={{ padding: 20, background: 'var(--bg-card)', borderRadius: 12, border: '2px solid var(--accent-accessory)', marginBottom: 16 }}>
                  <div style={{ fontWeight: 600, marginBottom: 16, color: 'var(--accent-accessory)' }}>âž• Nuovo accessorio</div>
                  <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr 1fr 1fr', gap: 12, marginBottom: 12 }}>
                    <input value={newAcc.name} onChange={(e) => setNewAcc({ ...newAcc, name: e.target.value })} style={inputStyle} placeholder="Nome accessorio *" autoFocus />
                    <select value={newAcc.typeId} onChange={(e) => setNewAcc({ ...newAcc, typeId: e.target.value })} style={inputStyle}>{accessoryTypes.map(t => <option key={t.id} value={t.id}>{t.icon} {t.name}</option>)}</select>
                    <input type="number" value={newAcc.cost} onChange={(e) => setNewAcc({ ...newAcc, cost: parseFloat(e.target.value) || 0 })} style={inputStyle} placeholder="Costo â‚¬" step="0.01" />
                    <select value={newAcc.status} onChange={(e) => setNewAcc({ ...newAcc, status: e.target.value })} style={inputStyle}>{accessoryStatuses.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}</select>
                  </div>
                  <div style={{ display: 'grid', gridTemplateColumns: '1fr auto auto', gap: 12, alignItems: 'start' }}>
                    <textarea value={newAcc.notes} onChange={(e) => setNewAcc({ ...newAcc, notes: e.target.value })} style={{ ...inputStyle, resize: 'vertical' }} rows={2} placeholder="Note..." />
                    <label style={{ display: 'inline-flex', alignItems: 'center', gap: 8, padding: '12px 16px', background: 'var(--bg-tertiary)', borderRadius: 8, cursor: 'pointer', fontSize: 12, color: 'var(--text-secondary)', height: 'fit-content' }}>ðŸ“· Foto<input type="file" accept="image/*" multiple onChange={handleImgUpload} style={{ display: 'none' }} /></label>
                    <div style={{ display: 'flex', gap: 8 }}>
                      <button onClick={handleAdd} disabled={!newAcc.name.trim()} style={{ ...btnStyle, background: newAcc.name.trim() ? 'var(--accent-accessory)' : 'var(--bg-tertiary)', color: newAcc.name.trim() ? '#fff' : 'var(--text-muted)' }}>âœ“ Aggiungi</button>
                      <button onClick={() => { setShowAdd(false); setNewAcc({ name: '', typeId: accessoryTypes[0]?.id || '', cost: 0, status: 'Presente', images: [], notes: '' }); }} style={{ ...btnStyle, background: 'var(--bg-tertiary)', color: 'var(--text-secondary)' }}>âœ•</button>
                    </div>
                  </div>
                  {newAcc.images.length > 0 && <div style={{ display: 'flex', gap: 8, flexWrap: 'wrap', marginTop: 12 }}>{newAcc.images.map((img, i) => <div key={i} style={{ position: 'relative' }}><div style={{ width: 50, height: 50, borderRadius: 6, background: `url(${img}) center/cover` }} /><button onClick={() => setNewAcc({ ...newAcc, images: newAcc.images.filter((_, idx) => idx !== i) })} style={{ position: 'absolute', top: -6, right: -6, width: 18, height: 18, borderRadius: '50%', background: 'var(--accent-danger)', border: 'none', color: '#fff', fontSize: 10, cursor: 'pointer' }}>Ã—</button></div>)}</div>}
                </div>
              )}
              {!showAdd && <button onClick={() => setShowAdd(true)} style={{ ...btnStyle, marginTop: 16, background: 'var(--accent-accessory)', color: '#fff', width: '100%', justifyContent: 'center' }}>+ Aggiungi accessorio</button>}
              <div style={{ display: 'flex', gap: 12, marginTop: 24, paddingTop: 20, borderTop: '1px solid var(--border-subtle)' }}>
                <button onClick={() => { onSave(localAcc); onClose(); }} style={{ ...btnStyle, flex: 1, justifyContent: 'center', background: 'var(--accent-success)', color: '#fff', padding: '14px 20px' }}>ðŸ’¾ Salva</button>
                <button onClick={onClose} style={{ ...btnStyle, flex: 1, justifyContent: 'center', background: 'var(--bg-tertiary)', color: 'var(--text-secondary)', padding: '14px 20px' }}>Annulla</button>
              </div>
            </div>
          </div>
        </div>
      );
    }

    // Scheduled Checks Popup - Manage maintenance schedule for an item
    function ScheduledChecksPopup({ item, checks, onClose, onSave, onConfirmCheck, onEditHistory, brands, models, maintenanceTypes, categories }) {
      const [localChecks, setLocalChecks] = useState(checks || []);
      const [newCheckTypeId, setNewCheckTypeId] = useState('');
      const [newCheckFrequency, setNewCheckFrequency] = useState(180);
      const [newCheckWarningDays, setNewCheckWarningDays] = useState(30);
      const [newCheckRecursive, setNewCheckRecursive] = useState(true);
      const [newCheckEstimatedCost, setNewCheckEstimatedCost] = useState('');
      const [viewHistoryCheckId, setViewHistoryCheckId] = useState(null);
      const [editingHistoryItem, setEditingHistoryItem] = useState(null);
      
      const getBrandName = (id) => brands.find(b => b.id === id)?.name || '-';
      const getModelName = (id) => models.find(m => m.id === id)?.name || '-';
      const getTypeName = (id) => maintenanceTypes.find(t => t.id === id)?.name || '-';
      
      const itemCategoryId = categories.find(c => c.name === item.category)?.id;
      const availableTypes = maintenanceTypes.filter(t => t.categoryId === itemCategoryId);
      
      const addCheck = () => {
        if (!newCheckTypeId) return;
        const type = maintenanceTypes.find(t => t.id === newCheckTypeId);
        const today = new Date();
        const nextDate = new Date();
        nextDate.setDate(today.getDate() + (parseInt(newCheckFrequency) || 180));
        const newCheck = {
          id: `check-${Date.now()}`,
          maintenanceTypeId: newCheckTypeId,
          frequencyDays: parseInt(newCheckFrequency) || 180,
          warningDays: parseInt(newCheckWarningDays) || 30,
          isRecursive: newCheckRecursive,
          estimatedCost: parseFloat(newCheckEstimatedCost) || 0,
          lastCheckDate: null,
          lastCheckCost: null,
          nextCheckDate: nextDate.toISOString().split('T')[0],
          history: [],
          notes: ''
        };
        setLocalChecks(prev => [...prev, newCheck]);
        setNewCheckTypeId('');
        setNewCheckFrequency(type?.defaultFrequencyDays || 180);
        setNewCheckWarningDays(30);
        setNewCheckRecursive(true);
        setNewCheckEstimatedCost('');
      };
      
      const removeCheck = (id) => setLocalChecks(prev => prev.filter(c => c.id !== id));
      
      const updateCheck = (id, field, value) => {
        setLocalChecks(prev => prev.map(c => {
          if (c.id !== id) return c;
          const updated = { ...c, [field]: value };
          if (field === 'frequencyDays') {
            const baseDate = c.lastCheckDate ? new Date(c.lastCheckDate) : new Date();
            const nextDate = new Date(baseDate);
            nextDate.setDate(nextDate.getDate() + parseInt(value));
            updated.nextCheckDate = nextDate.toISOString().split('T')[0];
          }
          return updated;
        }));
      };
      
      const updateHistoryItem = (checkId, historyIndex, updatedItem) => {
        setLocalChecks(prev => prev.map(c => {
          if (c.id !== checkId) return c;
          const newHistory = [...(c.history || [])];
          newHistory[historyIndex] = { ...newHistory[historyIndex], ...updatedItem };
          // Update lastCheckDate and lastCheckCost if editing the last item
          let lastCheckDate = c.lastCheckDate;
          let lastCheckCost = c.lastCheckCost;
          if (historyIndex === newHistory.length - 1) {
            lastCheckDate = newHistory[historyIndex].date;
            lastCheckCost = newHistory[historyIndex].cost;
          }
          return { ...c, history: newHistory, lastCheckDate, lastCheckCost };
        }));
        setEditingHistoryItem(null);
      };
      
      const deleteHistoryItem = (checkId, historyIndex) => {
        setLocalChecks(prev => prev.map(c => {
          if (c.id !== checkId) return c;
          const newHistory = c.history.filter((_, i) => i !== historyIndex);
          const lastItem = newHistory[newHistory.length - 1];
          return { 
            ...c, 
            history: newHistory,
            lastCheckDate: lastItem?.date || null,
            lastCheckCost: lastItem?.cost || null
          };
        }));
      };

      const btnStyle = { padding: '12px 18px', borderRadius: 8, border: 'none', cursor: 'pointer', fontSize: 14, fontWeight: 500, fontFamily: 'inherit', display: 'inline-flex', alignItems: 'center', gap: 6, transition: 'all 0.15s' };
      const inputStyle = { width: '100%', padding: '12px 14px', border: '1px solid var(--border-medium)', borderRadius: 8, background: 'var(--bg-tertiary)', color: 'var(--text-primary)', fontSize: 14, fontFamily: 'inherit' };
      
      const viewingCheck = viewHistoryCheckId ? localChecks.find(c => c.id === viewHistoryCheckId) : null;

      return (
        <div style={{ position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.85)', backdropFilter: 'blur(8px)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 110, padding: 20 }} onClick={onClose}>
          <div style={{ width: '100%', maxWidth: 900, maxHeight: '90vh', overflowY: 'auto', background: 'var(--bg-secondary)', borderRadius: 16, border: '1px solid var(--border-medium)', boxShadow: '0 25px 80px rgba(0,0,0,0.5)' }} onClick={(e) => e.stopPropagation()}>
            <div style={{ padding: '18px 24px', borderBottom: '1px solid var(--border-subtle)', display: 'flex', alignItems: 'center', justifyContent: 'space-between', background: 'var(--accent-warning-soft)' }}>
              <div>
                <h3 style={{ margin: 0, fontSize: 18, display: 'flex', alignItems: 'center', gap: 8 }}>ðŸ”” Controlli Programmati</h3>
                <div style={{ fontSize: 14, color: 'var(--text-secondary)', marginTop: 4 }}>{getBrandName(item.brandId)} {getModelName(item.modelId)}</div>
              </div>
              <button onClick={onClose} style={{ width: 36, height: 36, borderRadius: 8, background: 'var(--bg-tertiary)', border: 'none', color: 'var(--text-muted)', cursor: 'pointer', fontSize: 18 }}>Ã—</button>
            </div>
            
            {/* History View */}
            {viewingCheck && (
              <div style={{ padding: 24, background: 'var(--bg-card)', borderBottom: '1px solid var(--border-subtle)' }}>
                <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: 16 }}>
                  <h4 style={{ margin: 0, fontSize: 16, color: 'var(--accent-primary)' }}>ðŸ“‹ Storico: {getTypeName(viewingCheck.maintenanceTypeId)}</h4>
                  <button onClick={() => setViewHistoryCheckId(null)} style={{ ...btnStyle, padding: '8px 14px', background: 'var(--bg-tertiary)', color: 'var(--text-secondary)' }}>â† Chiudi</button>
                </div>
                {(!viewingCheck.history || viewingCheck.history.length === 0) ? (
                  <div style={{ textAlign: 'center', padding: 30, color: 'var(--text-muted)', fontSize: 14 }}>Nessuna esecuzione registrata</div>
                ) : (
                  <div style={{ display: 'flex', flexDirection: 'column', gap: 10 }}>
                    {viewingCheck.history.map((h, idx) => (
                      <div key={idx} style={{ padding: 14, background: 'var(--bg-primary)', borderRadius: 10, border: '1px solid var(--border-subtle)' }}>
                        {editingHistoryItem?.checkId === viewingCheck.id && editingHistoryItem?.index === idx ? (
                          <div style={{ display: 'flex', gap: 10, flexWrap: 'wrap', alignItems: 'center' }}>
                            <input type="date" value={editingHistoryItem.date} onChange={(e) => setEditingHistoryItem({ ...editingHistoryItem, date: e.target.value })} style={{ ...inputStyle, width: 150, padding: '10px 12px' }} />
                            <div style={{ display: 'flex', alignItems: 'center', gap: 4 }}>
                              <span style={{ fontSize: 14, color: 'var(--text-muted)' }}>â‚¬</span>
                              <input type="number" value={editingHistoryItem.cost} onChange={(e) => setEditingHistoryItem({ ...editingHistoryItem, cost: parseFloat(e.target.value) || 0 })} style={{ ...inputStyle, width: 90, padding: '10px 12px' }} step="0.01" />
                            </div>
                            <input type="text" value={editingHistoryItem.notes || ''} onChange={(e) => setEditingHistoryItem({ ...editingHistoryItem, notes: e.target.value })} placeholder="Note..." style={{ ...inputStyle, flex: 1, minWidth: 120, padding: '10px 12px' }} />
                            <button onClick={() => updateHistoryItem(viewingCheck.id, idx, { date: editingHistoryItem.date, cost: editingHistoryItem.cost, notes: editingHistoryItem.notes })} style={{ ...btnStyle, padding: '10px 14px', background: 'var(--accent-success)', color: '#fff' }}>âœ“</button>
                            <button onClick={() => setEditingHistoryItem(null)} style={{ ...btnStyle, padding: '10px 14px', background: 'var(--bg-tertiary)', color: 'var(--text-secondary)' }}>âœ•</button>
                          </div>
                        ) : (
                          <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', gap: 12, flexWrap: 'wrap' }}>
                            <div style={{ display: 'flex', alignItems: 'center', gap: 16 }}>
                              <span style={{ fontSize: 14, fontWeight: 600, color: 'var(--text-primary)' }}>{new Date(h.date).toLocaleDateString('it-IT')}</span>
                              <span style={{ fontSize: 14, fontWeight: 600, color: 'var(--accent-success)' }}>â‚¬{(h.cost || 0).toFixed(2)}</span>
                              {h.notes && <span style={{ fontSize: 13, color: 'var(--text-muted)' }}>{h.notes}</span>}
                            </div>
                            <div style={{ display: 'flex', gap: 6 }}>
                              <button onClick={() => setEditingHistoryItem({ checkId: viewingCheck.id, index: idx, ...h })} style={{ ...btnStyle, padding: '8px 12px', background: 'var(--accent-info-soft)', color: 'var(--accent-info)' }}>âœï¸</button>
                              <button onClick={() => deleteHistoryItem(viewingCheck.id, idx)} style={{ ...btnStyle, padding: '8px 12px', background: 'var(--accent-danger-soft)', color: 'var(--accent-danger)' }}>ðŸ—‘ï¸</button>
                            </div>
                          </div>
                        )}
                      </div>
                    ))}
                    <div style={{ marginTop: 10, padding: 12, background: 'var(--accent-success-soft)', borderRadius: 8, display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                      <span style={{ fontSize: 14, color: 'var(--text-secondary)' }}>Totale {viewingCheck.history.length} esecuzioni</span>
                      <span style={{ fontSize: 16, fontWeight: 700, color: 'var(--accent-success)' }}>â‚¬{viewingCheck.history.reduce((s, h) => s + (h.cost || 0), 0).toFixed(2)}</span>
                    </div>
                  </div>
                )}
              </div>
            )}
            
            <div style={{ padding: 24 }}>
              {/* Add new check */}
              {availableTypes.length > 0 ? (
                <div style={{ padding: 16, background: 'var(--bg-card)', borderRadius: 12, marginBottom: 20, border: '1px solid var(--border-subtle)' }}>
                  <div style={{ fontSize: 14, fontWeight: 600, color: 'var(--text-secondary)', marginBottom: 12 }}>âž• Nuovo controllo programmato</div>
                  <div style={{ display: 'flex', gap: 10, marginBottom: 12, flexWrap: 'wrap', alignItems: 'center' }}>
                    <select value={newCheckTypeId} onChange={(e) => { setNewCheckTypeId(e.target.value); const t = maintenanceTypes.find(m => m.id === e.target.value); if (t) setNewCheckFrequency(t.defaultFrequencyDays); }} style={{ ...inputStyle, flex: 1, minWidth: 180 }}>
                      <option value="">Seleziona tipo manutenzione...</option>
                      {availableTypes.map(t => <option key={t.id} value={t.id}>{t.name}</option>)}
                    </select>
                  </div>
                  <div style={{ display: 'flex', gap: 12, flexWrap: 'wrap', alignItems: 'center' }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: 6 }}>
                      <span style={{ fontSize: 13, color: 'var(--text-muted)' }}>Ogni</span>
                      <input type="number" value={newCheckFrequency} onChange={(e) => setNewCheckFrequency(e.target.value)} style={{ ...inputStyle, width: 70, padding: '10px 12px', textAlign: 'center' }} min="1" />
                      <span style={{ fontSize: 13, color: 'var(--text-muted)' }}>giorni</span>
                    </div>
                    <div style={{ display: 'flex', alignItems: 'center', gap: 6 }}>
                      <span style={{ fontSize: 13, color: 'var(--text-muted)' }}>Avviso</span>
                      <input type="number" value={newCheckWarningDays} onChange={(e) => setNewCheckWarningDays(e.target.value)} style={{ ...inputStyle, width: 60, padding: '10px 12px', textAlign: 'center' }} min="1" />
                      <span style={{ fontSize: 13, color: 'var(--text-muted)' }}>gg prima</span>
                    </div>
                    <div style={{ display: 'flex', alignItems: 'center', gap: 6 }}>
                      <span style={{ fontSize: 13, color: 'var(--text-muted)' }}>â‚¬</span>
                      <input type="number" value={newCheckEstimatedCost} onChange={(e) => setNewCheckEstimatedCost(e.target.value)} placeholder="Stima" style={{ ...inputStyle, width: 80, padding: '10px 12px', textAlign: 'center' }} min="0" step="0.01" />
                    </div>
                    <label style={{ display: 'flex', alignItems: 'center', gap: 6, cursor: 'pointer', fontSize: 14, color: 'var(--text-secondary)' }}>
                      <input type="checkbox" checked={newCheckRecursive} onChange={(e) => setNewCheckRecursive(e.target.checked)} style={{ width: 16, height: 16 }} />
                      Ricorsivo
                    </label>
                    <button onClick={addCheck} disabled={!newCheckTypeId} style={{ ...btnStyle, background: newCheckTypeId ? 'var(--accent-primary)' : 'var(--bg-tertiary)', color: newCheckTypeId ? '#1a1814' : 'var(--text-muted)' }}>+ Aggiungi</button>
                  </div>
                </div>
              ) : (
                <div style={{ padding: 18, background: 'var(--accent-warning-soft)', borderRadius: 10, marginBottom: 20, fontSize: 14, color: 'var(--accent-warning)' }}>
                  âš ï¸ Nessun tipo di manutenzione definito per questa categoria. Aggiungi tipi in Anagrafiche â†’ Manutenzioni.
                </div>
              )}
              
              {/* List of checks */}
              {localChecks.length === 0 ? (
                <div style={{ textAlign: 'center', padding: 50, color: 'var(--text-muted)' }}>
                  <div style={{ fontSize: 40, marginBottom: 12 }}>ðŸ””</div>
                  <div style={{ fontSize: 15 }}>Nessun controllo programmato</div>
                </div>
              ) : (
                <>
                  {/* Active checks */}
                  {localChecks.filter(c => !c.isCompleted).length > 0 && (
                    <div style={{ marginBottom: 20 }}>
                      <div style={{ fontSize: 13, color: 'var(--text-muted)', marginBottom: 10, fontWeight: 600 }}>CONTROLLI ATTIVI ({localChecks.filter(c => !c.isCompleted).length})</div>
                      <div style={{ display: 'flex', flexDirection: 'column', gap: 12 }}>
                        {localChecks.filter(c => !c.isCompleted).map(check => {
                          const today = new Date();
                          today.setHours(0, 0, 0, 0);
                          const nextDate = check.nextCheckDate ? new Date(check.nextCheckDate) : null;
                          if (nextDate) nextDate.setHours(0, 0, 0, 0);
                          const daysUntil = nextDate ? Math.ceil((nextDate - today) / (1000 * 60 * 60 * 24)) : null;
                          const warningDays = check.warningDays || 30;
                          const isOverdue = daysUntil !== null && daysUntil < 0;
                          const isSoon = daysUntil !== null && daysUntil >= 0 && daysUntil <= warningDays;
                          const totalSpent = check.history?.reduce((s, h) => s + (h.cost || 0), 0) || 0;
                          
                          return (
                            <div key={check.id} style={{ padding: 16, background: isOverdue ? 'var(--accent-danger-soft)' : isSoon ? 'var(--accent-warning-soft)' : 'var(--bg-card)', borderRadius: 12, border: `2px solid ${isOverdue ? 'var(--accent-danger)' : isSoon ? 'var(--accent-warning)' : 'var(--border-subtle)'}` }}>
                              <div style={{ display: 'flex', alignItems: 'flex-start', justifyContent: 'space-between', gap: 12, flexWrap: 'wrap' }}>
                                <div style={{ flex: 1, minWidth: 200 }}>
                                  <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 6 }}>
                                    <span style={{ fontWeight: 600, fontSize: 15 }}>{getTypeName(check.maintenanceTypeId)}</span>
                                    {check.isRecursive !== false && <span style={{ fontSize: 11, padding: '3px 8px', background: 'var(--accent-info-soft)', color: 'var(--accent-info)', borderRadius: 6 }}>ðŸ”„ Ricorsivo</span>}
                                    {check.isRecursive === false && <span style={{ fontSize: 11, padding: '3px 8px', background: 'var(--bg-tertiary)', color: 'var(--text-muted)', borderRadius: 6 }}>1x</span>}
                                  </div>
                                  <div style={{ fontSize: 13, color: 'var(--text-muted)', display: 'flex', flexWrap: 'wrap', gap: 10, marginBottom: 6 }}>
                                    <span>Ogni <strong>{check.frequencyDays}</strong> gg</span>
                                    <span>â€¢ Avviso <strong>{check.warningDays || 30}</strong> gg prima</span>
                                    {check.estimatedCost > 0 && <span>â€¢ Stima: <strong>â‚¬{check.estimatedCost}</strong></span>}
                                  </div>
                                  <div style={{ fontSize: 13, color: 'var(--text-secondary)' }}>
                                    {check.lastCheckDate ? `Ultimo: ${new Date(check.lastCheckDate).toLocaleDateString('it-IT')}${check.lastCheckCost ? ` (â‚¬${check.lastCheckCost})` : ''}` : 'Mai eseguito'}
                                    {check.history?.length > 0 && (
                                      <button onClick={() => setViewHistoryCheckId(check.id)} style={{ marginLeft: 10, padding: '4px 10px', borderRadius: 6, border: 'none', background: 'var(--bg-tertiary)', color: 'var(--accent-info)', fontSize: 12, cursor: 'pointer', fontWeight: 500 }}>
                                        ðŸ“‹ {check.history.length} esecuzioni (â‚¬{totalSpent.toFixed(2)})
                                      </button>
                                    )}
                                  </div>
                                </div>
                                <div style={{ display: 'flex', flexDirection: 'column', gap: 8, alignItems: 'flex-end' }}>
                                  <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
                                    {daysUntil !== null && (
                                      <span style={{ fontSize: 13, padding: '6px 12px', borderRadius: 8, fontWeight: 600, background: isOverdue ? 'var(--accent-danger)' : isSoon ? 'var(--accent-warning)' : 'var(--accent-success-soft)', color: isOverdue ? '#fff' : isSoon ? '#1a1814' : 'var(--accent-success)' }}>
                                        {isOverdue ? `Scaduto da ${Math.abs(daysUntil)} gg` : daysUntil === 0 ? 'Oggi' : `Tra ${daysUntil} gg`}
                                      </span>
                                    )}
                                    {(isOverdue || isSoon || daysUntil === 0) && onConfirmCheck && (
                                      <button onClick={() => onConfirmCheck(item, check)} title="Segna come eseguito" style={{ ...btnStyle, padding: '8px 16px', background: 'var(--accent-success)', color: '#fff', fontSize: 13 }}>âœ“ Fatto</button>
                                    )}
                                  </div>
                                  <div style={{ display: 'flex', alignItems: 'center', gap: 6 }}>
                                    <span style={{ fontSize: 12, color: 'var(--text-muted)' }}>Freq:</span>
                                    <input type="number" value={check.frequencyDays} onChange={(e) => updateCheck(check.id, 'frequencyDays', parseInt(e.target.value))} style={{ ...inputStyle, width: 55, padding: '6px 8px', textAlign: 'center', fontSize: 13 }} min="1" />
                                    <span style={{ fontSize: 12, color: 'var(--text-muted)' }}>Avv:</span>
                                    <input type="number" value={check.warningDays || 30} onChange={(e) => updateCheck(check.id, 'warningDays', parseInt(e.target.value))} style={{ ...inputStyle, width: 50, padding: '6px 8px', textAlign: 'center', fontSize: 13 }} min="1" />
                                    <label style={{ display: 'flex', alignItems: 'center', gap: 4, cursor: 'pointer', fontSize: 12, color: 'var(--text-muted)' }} title="Ricorsivo">
                                      <input type="checkbox" checked={check.isRecursive !== false} onChange={(e) => updateCheck(check.id, 'isRecursive', e.target.checked)} style={{ width: 14, height: 14 }} />
                                      ðŸ”„
                                    </label>
                                    <button onClick={() => removeCheck(check.id)} style={{ ...btnStyle, padding: '6px 10px', background: 'var(--accent-danger-soft)', color: 'var(--accent-danger)', fontSize: 12 }}>ðŸ—‘ï¸</button>
                                  </div>
                                </div>
                              </div>
                            </div>
                          );
                        })}
                      </div>
                    </div>
                  )}
                  
                  {/* Completed checks */}
                  {localChecks.filter(c => c.isCompleted).length > 0 && (
                    <div>
                      <div style={{ fontSize: 13, color: 'var(--text-muted)', marginBottom: 10, fontWeight: 600 }}>CONTROLLI COMPLETATI ({localChecks.filter(c => c.isCompleted).length})</div>
                      <div style={{ display: 'flex', flexDirection: 'column', gap: 8 }}>
                        {localChecks.filter(c => c.isCompleted).map(check => {
                          const totalSpent = check.history?.reduce((s, h) => s + (h.cost || 0), 0) || 0;
                          return (
                            <div key={check.id} style={{ padding: 12, background: 'var(--accent-success-soft)', borderRadius: 10, border: '1px solid var(--accent-success)' }}>
                              <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', flexWrap: 'wrap', gap: 10 }}>
                                <div style={{ display: 'flex', alignItems: 'center', gap: 10 }}>
                                  <span style={{ fontSize: 14, color: 'var(--accent-success)' }}>âœ“</span>
                                  <span style={{ fontWeight: 600, fontSize: 14 }}>{getTypeName(check.maintenanceTypeId)}</span>
                                  <span style={{ fontSize: 11, padding: '2px 6px', background: 'var(--bg-tertiary)', color: 'var(--text-muted)', borderRadius: 4 }}>Una tantum</span>
                                </div>
                                <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
                                  {check.lastCheckDate && <span style={{ fontSize: 12, color: 'var(--text-secondary)' }}>Eseguito: {new Date(check.lastCheckDate).toLocaleDateString('it-IT')}</span>}
                                  {check.history?.length > 0 && (
                                    <button onClick={() => setViewHistoryCheckId(check.id)} style={{ padding: '4px 10px', borderRadius: 6, border: 'none', background: 'var(--bg-tertiary)', color: 'var(--accent-info)', fontSize: 12, cursor: 'pointer', fontWeight: 500 }}>
                                      ðŸ“‹ â‚¬{totalSpent.toFixed(2)}
                                    </button>
                                  )}
                                  <button onClick={() => removeCheck(check.id)} style={{ ...btnStyle, padding: '4px 8px', background: 'var(--accent-danger-soft)', color: 'var(--accent-danger)', fontSize: 11 }}>ðŸ—‘ï¸</button>
                                </div>
                              </div>
                            </div>
                          );
                        })}
                      </div>
                    </div>
                  )}
                </>
              )}
            </div>
            <div style={{ padding: '18px 24px', borderTop: '1px solid var(--border-subtle)', display: 'flex', gap: 12, justifyContent: 'flex-end' }}>
              <button onClick={onClose} style={{ ...btnStyle, background: 'var(--bg-tertiary)', color: 'var(--text-secondary)' }}>Annulla</button>
              <button onClick={() => onSave(localChecks)} style={{ ...btnStyle, background: 'var(--accent-success)', color: '#fff' }}>ðŸ’¾ Salva</button>
            </div>
          </div>
        </div>
      );
    }

    // Check Confirm Popup - Confirm a maintenance check was done
    function CheckConfirmPopup({ item, check, onClose, onConfirm, maintenanceTypes }) {
      const [checkDate, setCheckDate] = useState(new Date().toISOString().split('T')[0]);
      const [cost, setCost] = useState(check.estimatedCost || '');
      const [notes, setNotes] = useState('');
      const getTypeName = (id) => maintenanceTypes.find(t => t.id === id)?.name || '-';
      const btnStyle = { padding: '14px 20px', borderRadius: 10, border: 'none', cursor: 'pointer', fontSize: 15, fontWeight: 500, fontFamily: 'inherit', display: 'inline-flex', alignItems: 'center', gap: 8, transition: 'all 0.15s' };
      const inputStyle = { width: '100%', padding: '14px 16px', border: '1px solid var(--border-medium)', borderRadius: 10, background: 'var(--bg-tertiary)', color: 'var(--text-primary)', fontSize: 15, fontFamily: 'inherit' };
      
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const nextDate = check.nextCheckDate ? new Date(check.nextCheckDate) : null;
      if (nextDate) nextDate.setHours(0, 0, 0, 0);
      const daysUntil = nextDate ? Math.ceil((nextDate - today) / (1000 * 60 * 60 * 24)) : null;
      const isOverdue = daysUntil !== null && daysUntil < 0;
      const totalSpent = check.history?.reduce((s, h) => s + (h.cost || 0), 0) || 0;
      
      return (
        <div style={{ position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.85)', backdropFilter: 'blur(8px)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 120, padding: 20 }} onClick={onClose}>
          <div style={{ width: '100%', maxWidth: 600, background: 'var(--bg-secondary)', borderRadius: 16, border: '1px solid var(--border-medium)', boxShadow: '0 25px 80px rgba(0,0,0,0.5)' }} onClick={(e) => e.stopPropagation()}>
            <div style={{ padding: '18px 24px', borderBottom: '1px solid var(--border-subtle)', background: isOverdue ? 'var(--accent-danger-soft)' : 'var(--accent-success-soft)', borderRadius: '16px 16px 0 0', display: 'flex', alignItems: 'center', gap: 16 }}>
              <div style={{ width: 48, height: 48, background: 'var(--bg-secondary)', borderRadius: 12, display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: 24 }}>
                {isOverdue ? 'âš ï¸' : 'âœ“'}
              </div>
              <div style={{ flex: 1 }}>
                <h3 style={{ margin: 0, fontSize: 18 }}>Conferma Manutenzione</h3>
                <div style={{ fontSize: 14, color: isOverdue ? 'var(--accent-danger)' : 'var(--accent-success)', fontWeight: 600 }}>
                  {getTypeName(check.maintenanceTypeId)}
                </div>
              </div>
              <button onClick={onClose} style={{ width: 32, height: 32, borderRadius: 8, background: 'var(--bg-tertiary)', border: 'none', color: 'var(--text-muted)', cursor: 'pointer', fontSize: 16 }}>Ã—</button>
            </div>
            
            <div style={{ padding: '20px 24px' }}>
              <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: 12, marginBottom: 20 }}>
                <div style={{ padding: 12, background: 'var(--bg-card)', borderRadius: 10, textAlign: 'center' }}>
                  <div style={{ fontSize: 11, color: 'var(--text-muted)', marginBottom: 4 }}>Ultimo</div>
                  <div style={{ fontSize: 13, fontWeight: 600 }}>{check.lastCheckDate ? new Date(check.lastCheckDate).toLocaleDateString('it-IT') : '-'}</div>
                </div>
                <div style={{ padding: 12, background: 'var(--bg-card)', borderRadius: 10, textAlign: 'center' }}>
                  <div style={{ fontSize: 11, color: 'var(--text-muted)', marginBottom: 4 }}>Frequenza</div>
                  <div style={{ fontSize: 13, fontWeight: 600 }}>{check.frequencyDays} gg</div>
                </div>
                <div style={{ padding: 12, background: 'var(--bg-card)', borderRadius: 10, textAlign: 'center' }}>
                  <div style={{ fontSize: 11, color: 'var(--text-muted)', marginBottom: 4 }}>Esecuzioni</div>
                  <div style={{ fontSize: 13, fontWeight: 600 }}>{check.history?.length || 0}</div>
                </div>
                <div style={{ padding: 12, background: 'var(--bg-card)', borderRadius: 10, textAlign: 'center' }}>
                  <div style={{ fontSize: 11, color: 'var(--text-muted)', marginBottom: 4 }}>Totale speso</div>
                  <div style={{ fontSize: 13, fontWeight: 600, color: 'var(--accent-primary)' }}>â‚¬{totalSpent.toFixed(2)}</div>
                </div>
              </div>
              
              <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 2fr', gap: 12, marginBottom: 16 }}>
                <div>
                  <label style={{ display: 'block', fontSize: 12, color: 'var(--text-muted)', marginBottom: 6 }}>Data</label>
                  <input type="date" value={checkDate} onChange={(e) => setCheckDate(e.target.value)} style={{ ...inputStyle, padding: '10px 12px' }} />
                </div>
                <div>
                  <label style={{ display: 'block', fontSize: 12, color: 'var(--text-muted)', marginBottom: 6 }}>Costo â‚¬</label>
                  <input type="number" value={cost} onChange={(e) => setCost(e.target.value)} placeholder="0.00" style={{ ...inputStyle, padding: '10px 12px' }} min="0" step="0.01" />
                </div>
                <div>
                  <label style={{ display: 'block', fontSize: 12, color: 'var(--text-muted)', marginBottom: 6 }}>Note</label>
                  <input type="text" value={notes} onChange={(e) => setNotes(e.target.value)} placeholder="Es: sostituito filtro..." style={{ ...inputStyle, padding: '10px 12px' }} />
                </div>
              </div>
              
              {check.isRecursive === false && (
                <div style={{ padding: 12, background: 'var(--accent-info-soft)', borderRadius: 8, marginBottom: 16, fontSize: 13, color: 'var(--accent-info)', textAlign: 'center' }}>
                  â„¹ï¸ Controllo una tantum: sarÃ  completato dopo la conferma
                </div>
              )}
              
              <div style={{ display: 'flex', gap: 12 }}>
                <button onClick={onClose} style={{ ...btnStyle, background: 'var(--bg-tertiary)', color: 'var(--text-secondary)', flex: 1, justifyContent: 'center' }}>Annulla</button>
                <button onClick={() => onConfirm(item.id, check.id, parseFloat(cost) || 0, notes, checkDate)} style={{ ...btnStyle, background: 'var(--accent-success)', color: '#fff', flex: 1, justifyContent: 'center' }}>âœ“ Conferma</button>
              </div>
            </div>
          </div>
        </div>
      );
    }


    function CollectionManager() {
      const [categories, setCategories] = useState(defaultCategories);
      const [subcategories, setSubcategories] = useState(defaultSubcategories);
      const [brands, setBrands] = useState(defaultBrands);
      const [models, setModels] = useState(defaultModels);
      const [locations, setLocations] = useState(defaultLocations);
      const [statuses, setStatuses] = useState(defaultStatuses);
      const [aestheticGrades, setAestheticGrades] = useState(defaultAestheticGrades);
      const [accessoryTypes, setAccessoryTypes] = useState(defaultAccessoryTypes);
      const [maintenanceTypes, setMaintenanceTypes] = useState(defaultMaintenanceTypes);
      const [items, setItems] = useState([]);
      const [dataLoaded, setDataLoaded] = useState(false);
      const [hasUnsavedChanges, setHasUnsavedChanges] = useState(false);
      const [currentFileName, setCurrentFileName] = useState(null);
      const [showStartModal, setShowStartModal] = useState(true);

      const [selectedItem, setSelectedItem] = useState(null);
      const [selectedIds, setSelectedIds] = useState(new Set());
      const [searchTerm, setSearchTerm] = useState('');
      const [categoryFilter, setCategoryFilter] = useState('Tutti');
      const [brandFilter, setBrandFilter] = useState('Tutti');
      const [locationFilter, setLocationFilter] = useState('Tutte');
      const [statusFilter, setStatusFilter] = useState('Tutti');

      const [sortBy, setSortBy] = useState('dateAdded');
      const [sortOrder, setSortOrder] = useState('desc');
      const [currentPage, setCurrentPage] = useState(1);
      const [rowsPerPage, setRowsPerPage] = useState(25);
      const [notification, setNotification] = useState(null);

      const [isEditing, setIsEditing] = useState(false);
      const [editForm, setEditForm] = useState({});
      const [activeImageIndex, setActiveImageIndex] = useState(0);
      const [showMasterData, setShowMasterData] = useState(false);
      const [showEconomics, setShowEconomics] = useState(false);
      const [masterDataTab, setMasterDataTab] = useState('brands');
      const [worksPopup, setWorksPopup] = useState(null);
      const [accessoriesPopup, setAccessoriesPopup] = useState(null);
      const [scheduledChecksPopup, setScheduledChecksPopup] = useState(null);
      const [checkConfirmPopup, setCheckConfirmPopup] = useState(null);
      const [lightboxOpen, setLightboxOpen] = useState(false);
      const [lightboxImages, setLightboxImages] = useState([]);
      const [lightboxIndex, setLightboxIndex] = useState(0);
      
      // Inline add states
      const [showInlineAddBrand, setShowInlineAddBrand] = useState(false);
      const [showInlineAddModel, setShowInlineAddModel] = useState(false);
      const [showInlineAddCategory, setShowInlineAddCategory] = useState(false);
      const [showInlineAddLocation, setShowInlineAddLocation] = useState(false);
      const [inlineBrandName, setInlineBrandName] = useState('');
      const [inlineModelName, setInlineModelName] = useState('');
      const [inlineCategoryName, setInlineCategoryName] = useState('');
      const [inlineCategoryColor, setInlineCategoryColor] = useState('#c9a86c');
      const [inlineLocationName, setInlineLocationName] = useState('');
      const [inlineLocationDesc, setInlineLocationDesc] = useState('');
      
      // Master data add/edit states
      const [newBrandName, setNewBrandName] = useState('');
      const [newModelName, setNewModelName] = useState('');
      const [newModelBrandId, setNewModelBrandId] = useState('');
      const [newCategoryName, setNewCategoryName] = useState('');
      const [newCategoryColor, setNewCategoryColor] = useState('#c9a86c');
      const [newSubcategoryName, setNewSubcategoryName] = useState('');
      const [newSubcategoryCatId, setNewSubcategoryCatId] = useState('');
      const [newLocationName, setNewLocationName] = useState('');
      const [newLocationDesc, setNewLocationDesc] = useState('');
      const [newStatusName, setNewStatusName] = useState('');
      const [newStatusColor, setNewStatusColor] = useState('#8a7e6d');
      const [newStatusIcon, setNewStatusIcon] = useState('ðŸ“‹');
      const [newAccessoryTypeName, setNewAccessoryTypeName] = useState('');
      const [newAccessoryTypeIcon, setNewAccessoryTypeIcon] = useState('ðŸ“¦');
      const [newMaintenanceName, setNewMaintenanceName] = useState('');
      const [newMaintenanceCategoryId, setNewMaintenanceCategoryId] = useState('');
      const [newMaintenanceFrequency, setNewMaintenanceFrequency] = useState(180);
      const [editingBrand, setEditingBrand] = useState(null);
      const [editingModel, setEditingModel] = useState(null);
      const [editingCategory, setEditingCategory] = useState(null);
      const [editingSubcategory, setEditingSubcategory] = useState(null);
      const [editingLocation, setEditingLocation] = useState(null);
      const [editingStatus, setEditingStatus] = useState(null);
      const [editingAccessoryType, setEditingAccessoryType] = useState(null);
      const [editingMaintenanceType, setEditingMaintenanceType] = useState(null);

      const isMobile = typeof window !== 'undefined' && window.innerWidth < 768;

      const showNotification = useCallback((message, type = 'success') => {
        setNotification({ message, type });
        setTimeout(() => setNotification(null), 3000);
      }, []);

      useEffect(() => {
        const handleBeforeUnload = (e) => { if (hasUnsavedChanges) { e.preventDefault(); e.returnValue = ''; } };
        window.addEventListener('beforeunload', handleBeforeUnload);
        return () => window.removeEventListener('beforeunload', handleBeforeUnload);
      }, [hasUnsavedChanges]);

      useEffect(() => { if (dataLoaded) setHasUnsavedChanges(true); }, [items, categories, subcategories, brands, models, locations, statuses, aestheticGrades, accessoryTypes]);

      // File operations
      const saveFile = useCallback((saveAs = false) => {
        const data = { version: '4.2', exportDate: new Date().toISOString(), categories, subcategories, brands, models, locations, statuses, aestheticGrades, accessoryTypes, maintenanceTypes, items };
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = saveAs || !currentFileName ? `collezione-${new Date().toISOString().split('T')[0]}.json` : currentFileName;
        a.click();
        URL.revokeObjectURL(url);
        if (!saveAs && !currentFileName) setCurrentFileName(a.download);
        setHasUnsavedChanges(false);
        showNotification('Collezione salvata');
      }, [categories, subcategories, brands, models, locations, statuses, aestheticGrades, accessoryTypes, maintenanceTypes, items, currentFileName, showNotification]);

      const loadFile = useCallback(() => {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        input.onchange = async (e) => {
          const file = e.target.files[0];
          if (!file) return;
          try {
            const data = JSON.parse(await file.text());
            setCategories(data.categories || defaultCategories);
            setSubcategories(data.subcategories || defaultSubcategories);
            setBrands(data.brands || defaultBrands);
            setModels(data.models || defaultModels);
            setLocations(data.locations || defaultLocations);
            setStatuses(data.statuses || defaultStatuses);
            setAestheticGrades(data.aestheticGrades || defaultAestheticGrades);
            setAccessoryTypes(data.accessoryTypes || defaultAccessoryTypes);
            setMaintenanceTypes(data.maintenanceTypes || defaultMaintenanceTypes);
            setItems(data.items || []);
            setCurrentFileName(file.name);
            setDataLoaded(true);
            setHasUnsavedChanges(false);
            setShowStartModal(false);
            showNotification(`Caricato: ${file.name}`);
          } catch (err) { showNotification('Errore nel caricamento', 'error'); }
        };
        input.click();
      }, [showNotification]);

      const startNew = useCallback(() => {
        setItems(sampleItems);
        setCategories(defaultCategories);
        setSubcategories(defaultSubcategories);
        setBrands(defaultBrands);
        setModels(defaultModels);
        setLocations(defaultLocations);
        setStatuses(defaultStatuses);
        setAestheticGrades(defaultAestheticGrades);
        setAccessoryTypes(defaultAccessoryTypes);
        setMaintenanceTypes(defaultMaintenanceTypes);
        setCurrentFileName(null);
        setDataLoaded(true);
        setHasUnsavedChanges(true);
        setShowStartModal(false);
        showNotification('Collezione creata con dati esempio');
      }, [showNotification]);

      const startEmpty = useCallback(() => {
        setItems([]);
        setCategories(defaultCategories);
        setSubcategories(defaultSubcategories);
        setBrands(defaultBrands);
        setModels(defaultModels);
        setLocations(defaultLocations);
        setStatuses(defaultStatuses);
        setAestheticGrades(defaultAestheticGrades);
        setAccessoryTypes(defaultAccessoryTypes);
        setMaintenanceTypes(defaultMaintenanceTypes);
        setCurrentFileName(null);
        setDataLoaded(true);
        setHasUnsavedChanges(true);
        setShowStartModal(false);
        showNotification('Collezione vuota creata');
      }, [showNotification]);

      // Helpers
      const getBrandName = useCallback((id) => brands.find(b => b.id === id)?.name || '-', [brands]);
      const getModelName = useCallback((id) => models.find(m => m.id === id)?.name || '-', [models]);
      const getModelsForBrand = useCallback((id) => models.filter(m => m.brandId === id), [models]);
      const getSubcategoriesForCategory = useCallback((catName) => subcategories.filter(s => { const cat = categories.find(c => c.name === catName); return cat && s.categoryId === cat.id; }), [subcategories, categories]);
      const getStatusInfo = useCallback((name) => statuses.find(s => s.name === name) || { name, color: '#8a7e6d', icon: '?' }, [statuses]);
      const getGradeInfo = useCallback((name) => aestheticGrades.find(g => g.name === name) || { name, color: '#8a7e6d', score: 0 }, [aestheticGrades]);
      const getCategoryColor = useCallback((name) => categories.find(c => c.name === name)?.color || '#8a7e6d', [categories]);
      const getLocationDescription = useCallback((name) => locations.find(l => l.name === name)?.description || '', [locations]);

      const filteredItems = useMemo(() => {
        let result = items.filter(item => {
          const search = searchTerm.toLowerCase();
          const brandName = getBrandName(item.brandId).toLowerCase();
          const modelName = getModelName(item.modelId).toLowerCase();
          const matches = item.description?.toLowerCase().includes(search) || brandName.includes(search) || modelName.includes(search) || item.serialNumber?.toLowerCase().includes(search) || item.version?.toLowerCase().includes(search);
          return matches && (categoryFilter === 'Tutti' || item.category === categoryFilter) && (brandFilter === 'Tutti' || item.brandId === brandFilter) && (locationFilter === 'Tutte' || item.location === locationFilter) && (statusFilter === 'Tutti' || item.status === statusFilter);
        });
        result.sort((a, b) => {
          let valA = a[sortBy], valB = b[sortBy];
          if (sortBy === 'brand') { valA = getBrandName(a.brandId); valB = getBrandName(b.brandId); }
          if (sortBy === 'model') { valA = getModelName(a.modelId); valB = getModelName(b.modelId); }
          if (sortBy === 'totalCost') { 
            valA = (a.purchaseCost || 0) + (a.works?.reduce((s, w) => s + (w.cost || 0), 0) || 0) + (a.accessories?.reduce((s, acc) => s + (acc.cost || 0), 0) || 0) + (a.scheduledChecks?.reduce((s, c) => s + (c.history?.reduce((h, e) => h + (e.cost || 0), 0) || 0), 0) || 0);
            valB = (b.purchaseCost || 0) + (b.works?.reduce((s, w) => s + (w.cost || 0), 0) || 0) + (b.accessories?.reduce((s, acc) => s + (acc.cost || 0), 0) || 0) + (b.scheduledChecks?.reduce((s, c) => s + (c.history?.reduce((h, e) => h + (e.cost || 0), 0) || 0), 0) || 0);
          }
          if (typeof valA === 'string') valA = valA?.toLowerCase() || '';
          if (typeof valB === 'string') valB = valB?.toLowerCase() || '';
          return sortOrder === 'asc' ? (valA < valB ? -1 : valA > valB ? 1 : 0) : (valA > valB ? -1 : valA < valB ? 1 : 0);
        });
        return result;
      }, [items, searchTerm, categoryFilter, brandFilter, locationFilter, statusFilter, sortBy, sortOrder, getBrandName, getModelName]);

      const totalPages = rowsPerPage === 'all' ? 1 : Math.ceil(filteredItems.length / rowsPerPage);
      const paginatedItems = useMemo(() => {
        if (rowsPerPage === 'all') return filteredItems;
        const start = (currentPage - 1) * rowsPerPage;
        return filteredItems.slice(start, start + rowsPerPage);
      }, [filteredItems, currentPage, rowsPerPage]);

      const stats = useMemo(() => {
        const totalPurchase = items.reduce((s, c) => s + (c.purchaseCost || 0), 0);
        const totalWorks = items.reduce((s, c) => s + (c.works?.reduce((x, w) => x + (w.cost || 0), 0) || 0), 0);
        const totalAccessories = items.reduce((s, c) => s + (c.accessories?.reduce((x, a) => x + (a.cost || 0), 0) || 0), 0);
        const totalMaintenance = items.reduce((s, c) => s + (c.scheduledChecks?.reduce((x, ch) => x + (ch.history?.reduce((h, e) => h + (e.cost || 0), 0) || 0), 0) || 0), 0);
        const totalMaintenanceCount = items.reduce((s, c) => s + (c.scheduledChecks?.reduce((x, ch) => x + (ch.history?.length || 0), 0) || 0), 0);
        return { 
          total: items.length, 
          totalPurchaseCost: totalPurchase, 
          totalWorksCost: totalWorks, 
          totalAccessoriesCost: totalAccessories, 
          totalMaintenanceCost: totalMaintenance,
          totalMaintenanceCount: totalMaintenanceCount,
          grandTotal: totalPurchase + totalWorks + totalAccessories + totalMaintenance, 
          totalWorksCount: items.reduce((s, c) => s + (c.works?.length || 0), 0), 
          totalAccessoriesCount: items.reduce((s, c) => s + (c.accessories?.length || 0), 0), 
          filteredCount: filteredItems.length 
        };
      }, [items, filteredItems]);

      // CRUD Brands
      const addBrand = useCallback((name, inline = false) => {
        if (!name.trim()) return;
        const newBrand = { id: generateId(), name: name.trim() };
        setBrands(prev => [...prev, newBrand]);
        if (inline) { setEditForm(prev => ({ ...prev, brandId: newBrand.id })); setShowInlineAddBrand(false); setInlineBrandName(''); }
        else setNewBrandName('');
        showNotification('Marca aggiunta');
        return newBrand;
      }, [showNotification]);
      const updateBrand = useCallback((id, name) => { setBrands(prev => prev.map(b => b.id === id ? { ...b, name } : b)); setEditingBrand(null); showNotification('Marca aggiornata'); }, [showNotification]);
      const deleteBrand = useCallback((id) => {
        const usedBy = items.filter(i => i.brandId === id).length;
        const hasModels = models.filter(m => m.brandId === id).length;
        if (usedBy > 0 || hasModels > 0) { showNotification(`In uso da ${usedBy} oggetti e ${hasModels} modelli`, 'error'); return; }
        setBrands(prev => prev.filter(b => b.id !== id));
        showNotification('Marca eliminata', 'warning');
      }, [items, models, showNotification]);

      // CRUD Models
      const addModel = useCallback((name, brandId, inline = false) => {
        if (!name.trim() || !brandId) return;
        const newModel = { id: generateId(), name: name.trim(), brandId };
        setModels(prev => [...prev, newModel]);
        if (inline) { setEditForm(prev => ({ ...prev, modelId: newModel.id })); setShowInlineAddModel(false); setInlineModelName(''); }
        else { setNewModelName(''); setNewModelBrandId(''); }
        showNotification('Modello aggiunto');
        return newModel;
      }, [showNotification]);
      const updateModel = useCallback((id, name, brandId) => { setModels(prev => prev.map(m => m.id === id ? { ...m, name, brandId } : m)); setEditingModel(null); showNotification('Modello aggiornato'); }, [showNotification]);
      const deleteModel = useCallback((id) => {
        const usedBy = items.filter(i => i.modelId === id).length;
        if (usedBy > 0) { showNotification(`In uso da ${usedBy} oggetti`, 'error'); return; }
        setModels(prev => prev.filter(m => m.id !== id));
        showNotification('Modello eliminato', 'warning');
      }, [items, showNotification]);

      // CRUD Categories
      const addCategory = useCallback((name, color, inline = false) => {
        if (!name.trim()) return;
        const newCat = { id: generateId(), name: name.trim(), color };
        setCategories(prev => [...prev, newCat]);
        if (inline) { setEditForm(prev => ({ ...prev, category: newCat.name, subcategory: '' })); setShowInlineAddCategory(false); setInlineCategoryName(''); }
        else { setNewCategoryName(''); setNewCategoryColor('#c9a86c'); }
        showNotification('Categoria aggiunta');
        return newCat;
      }, [showNotification]);
      const updateCategory = useCallback((id, name, color) => {
        const oldCat = categories.find(c => c.id === id);
        if (oldCat && oldCat.name !== name) setItems(prev => prev.map(i => i.category === oldCat.name ? { ...i, category: name } : i));
        setCategories(prev => prev.map(c => c.id === id ? { ...c, name, color } : c));
        setEditingCategory(null);
        showNotification('Categoria aggiornata');
      }, [categories, showNotification]);
      const deleteCategory = useCallback((id) => {
        const cat = categories.find(c => c.id === id);
        const usedBy = items.filter(i => i.category === cat?.name).length;
        const hasSubs = subcategories.filter(s => s.categoryId === id).length;
        if (usedBy > 0 || hasSubs > 0) { showNotification(`In uso da ${usedBy} oggetti e ${hasSubs} sottocategorie`, 'error'); return; }
        setCategories(prev => prev.filter(c => c.id !== id));
        showNotification('Categoria eliminata', 'warning');
      }, [categories, items, subcategories, showNotification]);

      // CRUD Subcategories
      const addSubcategory = useCallback((name, categoryId) => {
        if (!name.trim() || !categoryId) return;
        const newSub = { id: generateId(), name: name.trim(), categoryId };
        setSubcategories(prev => [...prev, newSub]);
        setNewSubcategoryName(''); setNewSubcategoryCatId('');
        showNotification('Sottocategoria aggiunta');
        return newSub;
      }, [showNotification]);
      const updateSubcategory = useCallback((id, name, categoryId) => {
        const oldSub = subcategories.find(s => s.id === id);
        if (oldSub && oldSub.name !== name) setItems(prev => prev.map(i => i.subcategory === oldSub.name ? { ...i, subcategory: name } : i));
        setSubcategories(prev => prev.map(s => s.id === id ? { ...s, name, categoryId } : s));
        setEditingSubcategory(null);
        showNotification('Sottocategoria aggiornata');
      }, [subcategories, showNotification]);
      const deleteSubcategory = useCallback((id) => {
        const sub = subcategories.find(s => s.id === id);
        const usedBy = items.filter(i => i.subcategory === sub?.name).length;
        if (usedBy > 0) { showNotification(`In uso da ${usedBy} oggetti`, 'error'); return; }
        setSubcategories(prev => prev.filter(s => s.id !== id));
        showNotification('Sottocategoria eliminata', 'warning');
      }, [subcategories, items, showNotification]);

      // CRUD Locations
      const addLocation = useCallback((name, description, inline = false) => {
        if (!name.trim()) return;
        const newLoc = { id: generateId(), name: name.trim(), description };
        setLocations(prev => [...prev, newLoc]);
        if (inline) { setEditForm(prev => ({ ...prev, location: newLoc.name })); setShowInlineAddLocation(false); setInlineLocationName(''); setInlineLocationDesc(''); }
        else { setNewLocationName(''); setNewLocationDesc(''); }
        showNotification('Ubicazione aggiunta');
        return newLoc;
      }, [showNotification]);
      const updateLocation = useCallback((id, name, description) => {
        const oldLoc = locations.find(l => l.id === id);
        if (oldLoc && oldLoc.name !== name) setItems(prev => prev.map(i => i.location === oldLoc.name ? { ...i, location: name } : i));
        setLocations(prev => prev.map(l => l.id === id ? { ...l, name, description } : l));
        setEditingLocation(null);
        showNotification('Ubicazione aggiornata');
      }, [locations, showNotification]);
      const deleteLocation = useCallback((id) => {
        const loc = locations.find(l => l.id === id);
        const usedBy = items.filter(i => i.location === loc?.name).length;
        if (usedBy > 0) { showNotification(`In uso da ${usedBy} oggetti`, 'error'); return; }
        setLocations(prev => prev.filter(l => l.id !== id));
        showNotification('Ubicazione eliminata', 'warning');
      }, [locations, items, showNotification]);

      // CRUD Statuses
      const addStatus = useCallback((name, color, icon) => {
        if (!name.trim()) return;
        const newStatus = { id: generateId(), name: name.trim(), color, icon: icon || 'ðŸ“‹' };
        setStatuses(prev => [...prev, newStatus]);
        setNewStatusName(''); setNewStatusColor('#8a7e6d'); setNewStatusIcon('ðŸ“‹');
        showNotification('Stato aggiunto');
        return newStatus;
      }, [showNotification]);
      const updateStatus = useCallback((id, name, color, icon) => {
        const oldStatus = statuses.find(s => s.id === id);
        if (oldStatus && oldStatus.name !== name) setItems(prev => prev.map(i => i.status === oldStatus.name ? { ...i, status: name } : i));
        setStatuses(prev => prev.map(s => s.id === id ? { ...s, name, color, icon } : s));
        setEditingStatus(null);
        showNotification('Stato aggiornato');
      }, [statuses, showNotification]);
      const deleteStatus = useCallback((id) => {
        const status = statuses.find(s => s.id === id);
        const usedBy = items.filter(i => i.status === status?.name).length;
        if (usedBy > 0) { showNotification(`In uso da ${usedBy} oggetti`, 'error'); return; }
        setStatuses(prev => prev.filter(s => s.id !== id));
        showNotification('Stato eliminato', 'warning');
      }, [statuses, items, showNotification]);

      // CRUD Accessory Types
      const addAccessoryType = useCallback((name, icon) => {
        if (!name.trim()) return;
        const newType = { id: generateId(), name: name.trim(), icon: icon || 'ðŸ“¦' };
        setAccessoryTypes(prev => [...prev, newType]);
        setNewAccessoryTypeName(''); setNewAccessoryTypeIcon('ðŸ“¦');
        showNotification('Tipo accessorio aggiunto');
        return newType;
      }, [showNotification]);
      const updateAccessoryType = useCallback((id, name, icon) => {
        setAccessoryTypes(prev => prev.map(t => t.id === id ? { ...t, name, icon } : t));
        setEditingAccessoryType(null);
        showNotification('Tipo accessorio aggiornato');
      }, [showNotification]);
      const deleteAccessoryType = useCallback((id) => {
        const usedBy = items.reduce((count, item) => count + (item.accessories?.filter(a => a.typeId === id).length || 0), 0);
        if (usedBy > 0) { showNotification(`In uso da ${usedBy} accessori`, 'error'); return; }
        setAccessoryTypes(prev => prev.filter(t => t.id !== id));
        showNotification('Tipo accessorio eliminato', 'warning');
      }, [items, showNotification]);

      // CRUD Maintenance Types
      const addMaintenanceType = useCallback((name, categoryId, defaultFrequencyDays) => {
        if (!name.trim() || !categoryId) return;
        const newType = { id: generateId(), name: name.trim(), categoryId, defaultFrequencyDays: parseInt(defaultFrequencyDays) || 180 };
        setMaintenanceTypes(prev => [...prev, newType]);
        setNewMaintenanceName(''); setNewMaintenanceCategoryId(''); setNewMaintenanceFrequency(180);
        showNotification('Tipo manutenzione aggiunto');
      }, [showNotification]);
      const updateMaintenanceType = useCallback((id, name, categoryId, defaultFrequencyDays) => {
        setMaintenanceTypes(prev => prev.map(t => t.id === id ? { ...t, name, categoryId, defaultFrequencyDays: parseInt(defaultFrequencyDays) || 180 } : t));
        setEditingMaintenanceType(null);
        showNotification('Tipo manutenzione aggiornato');
      }, [showNotification]);
      const deleteMaintenanceType = useCallback((id) => {
        const usedBy = items.reduce((count, item) => count + (item.scheduledChecks?.filter(c => c.maintenanceTypeId === id).length || 0), 0);
        if (usedBy > 0) { showNotification(`In uso da ${usedBy} controlli programmati`, 'error'); return; }
        setMaintenanceTypes(prev => prev.filter(t => t.id !== id));
        showNotification('Tipo manutenzione eliminato', 'warning');
      }, [items, showNotification]);

      // Get maintenance status for an item
      const getMaintenanceStatus = useCallback((item) => {
        if (!item.scheduledChecks || item.scheduledChecks.length === 0) return { status: 'none', count: 0, overdue: 0, soon: 0, totalCost: 0 };
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        let overdue = 0, soon = 0, totalCost = 0;
        const activeChecks = item.scheduledChecks.filter(c => !c.isCompleted);
        // Total cost includes ALL history (including completed checks)
        item.scheduledChecks.forEach(check => {
          totalCost += check.history?.reduce((s, h) => s + (h.cost || 0), 0) || 0;
        });
        // Status only counts active checks
        activeChecks.forEach(check => {
          if (check.nextCheckDate) {
            const nextDate = new Date(check.nextCheckDate);
            nextDate.setHours(0, 0, 0, 0);
            const daysUntil = Math.ceil((nextDate - today) / (1000 * 60 * 60 * 24));
            const warningDays = check.warningDays || 30;
            if (daysUntil < 0) overdue++;
            else if (daysUntil <= warningDays) soon++;
          }
        });
        if (overdue > 0) return { status: 'overdue', count: activeChecks.length, overdue, soon, totalCost };
        if (soon > 0) return { status: 'soon', count: activeChecks.length, overdue, soon, totalCost };
        return { status: 'ok', count: activeChecks.length, overdue, soon, totalCost };
      }, []);

      // Save scheduled checks for an item
      const handleSaveScheduledChecks = useCallback((itemId, checks) => {
        setItems(prev => {
          const newItems = prev.map(item => item.id === itemId ? { ...item, scheduledChecks: checks, lastModified: new Date().toISOString() } : item);
          const updatedItem = newItems.find(i => i.id === itemId);
          if (updatedItem) setSelectedItem(updatedItem);
          return newItems;
        });
        setScheduledChecksPopup(null);
        setHasUnsavedChanges(true);
        showNotification('Controlli programmati salvati');
      }, [showNotification]);

      // Confirm a check was done
      const confirmCheck = useCallback((itemId, checkId, cost = 0, notes = '', checkDate = null) => {
        const dateToUse = checkDate || new Date().toISOString().split('T')[0];
        setItems(prev => {
          const newItems = prev.map(item => {
            if (item.id !== itemId) return item;
            const updatedChecks = item.scheduledChecks.map(check => {
              if (check.id !== checkId) return check;
              const historyEntry = { date: dateToUse, cost, notes };
              const newHistory = [...(check.history || []), historyEntry];
              let nextCheckDate = null;
              let isCompleted = false;
              if (check.isRecursive !== false) {
                // Recursive: calculate next date
                const nextDate = new Date(dateToUse);
                nextDate.setDate(nextDate.getDate() + check.frequencyDays);
                nextCheckDate = nextDate.toISOString().split('T')[0];
              } else {
                // Non-recursive: mark as completed, keep in history
                isCompleted = true;
              }
              return { ...check, lastCheckDate: dateToUse, lastCheckCost: cost, nextCheckDate, history: newHistory, isCompleted };
            });
            return { ...item, scheduledChecks: updatedChecks, lastModified: new Date().toISOString() };
          });
          // Update selectedItem if it's the one being modified
          const updatedItem = newItems.find(i => i.id === itemId);
          if (updatedItem) setSelectedItem(updatedItem);
          return newItems;
        });
        setCheckConfirmPopup(null);
        setScheduledChecksPopup(null);
        setHasUnsavedChanges(true);
        showNotification('Controllo confermato' + (cost > 0 ? ` (â‚¬${cost.toFixed(2)})` : ''));
      }, [showNotification]);

      // Item operations
      const handleAdd = useCallback(() => {
        setEditForm({ id: generateId(), description: '', brandId: '', modelId: '', category: '', subcategory: '', purchaseCost: 0, purchaseYear: '', status: 'Da valutare', aestheticGrade: '', defectFound: '', location: '', version: '', notes: '', images: [], works: [], accessories: [], scheduledChecks: [], dateAdded: new Date().toISOString(), lastModified: new Date().toISOString(), year: '', serialNumber: '' });
        setIsEditing(true);
        setSelectedItem(null);
      }, []);
      const handleEdit = useCallback((item, e) => { if (e) e.stopPropagation(); setEditForm({ ...item }); setIsEditing(true); setSelectedItem(item); }, []);
      const handleSave = useCallback(() => {
        if (!editForm.brandId || !editForm.category || !editForm.location) { showNotification('Compila i campi obbligatori', 'error'); return; }
        const updatedItem = { ...editForm, lastModified: new Date().toISOString() };
        const exists = items.find(i => i.id === editForm.id);
        if (exists) setItems(prev => prev.map(i => i.id === editForm.id ? updatedItem : i));
        else setItems(prev => [...prev, updatedItem]);
        setIsEditing(false);
        setSelectedItem(updatedItem);
        showNotification(exists ? 'Oggetto aggiornato' : 'Oggetto creato');
      }, [editForm, items, showNotification]);
      const handleCancel = useCallback(() => { setIsEditing(false); if (!items.find(i => i.id === editForm.id)) setSelectedItem(null); }, [items, editForm]);
      const deleteItem = useCallback((id, e) => { if (e) e.stopPropagation(); if (confirm('Eliminare questo oggetto?')) { setItems(prev => prev.filter(i => i.id !== id)); if (selectedItem?.id === id) setSelectedItem(null); showNotification('Oggetto eliminato', 'warning'); } }, [selectedItem, showNotification]);
      const duplicateItem = useCallback((item, e) => { if (e) e.stopPropagation(); setItems(prev => [...prev, { ...item, id: generateId(), dateAdded: new Date().toISOString(), lastModified: new Date().toISOString() }]); showNotification('Oggetto duplicato'); }, [showNotification]);

      // Works & Accessories management
      const handleSaveWorks = useCallback((itemId, works) => { 
        setItems(prev => {
          const newItems = prev.map(i => i.id === itemId ? { ...i, works, lastModified: new Date().toISOString() } : i);
          const updatedItem = newItems.find(i => i.id === itemId);
          if (updatedItem) setSelectedItem(updatedItem);
          return newItems;
        }); 
        setWorksPopup(null);
        setHasUnsavedChanges(true);
        showNotification('Riparazioni salvate'); 
      }, [showNotification]);
      const handleSaveAccessories = useCallback((itemId, accessories) => { 
        setItems(prev => {
          const newItems = prev.map(i => i.id === itemId ? { ...i, accessories, lastModified: new Date().toISOString() } : i);
          const updatedItem = newItems.find(i => i.id === itemId);
          if (updatedItem) setSelectedItem(updatedItem);
          return newItems;
        }); 
        setAccessoriesPopup(null);
        setHasUnsavedChanges(true);
        showNotification('Accessori salvati'); 
      }, [showNotification]);
      
      // Generic item update for maintenance history popup
      const updateItemPartial = useCallback((itemId, updates) => {
        setItems(prev => {
          const newItems = prev.map(i => i.id === itemId ? { ...i, ...updates, lastModified: new Date().toISOString() } : i);
          const updatedItem = newItems.find(i => i.id === itemId);
          if (updatedItem && selectedItem?.id === itemId) setSelectedItem(updatedItem);
          return newItems;
        });
        setHasUnsavedChanges(true);
      }, [selectedItem]);

      // Selection operations
      const toggleSelect = useCallback((id, e) => { if (e) e.stopPropagation(); setSelectedIds(prev => { const newSet = new Set(prev); if (newSet.has(id)) newSet.delete(id); else newSet.add(id); return newSet; }); }, []);
      const toggleSelectAll = useCallback(() => { setSelectedIds(selectedIds.size === paginatedItems.length ? new Set() : new Set(paginatedItems.map(i => i.id))); }, [selectedIds, paginatedItems]);
      const deleteSelected = useCallback(() => { if (confirm(`Eliminare ${selectedIds.size} oggetti?`)) { setItems(prev => prev.filter(i => !selectedIds.has(i.id))); setSelectedIds(new Set()); showNotification(`${selectedIds.size} oggetti eliminati`, 'warning'); } }, [selectedIds, showNotification]);
      const duplicateSelected = useCallback(() => { const newItems = items.filter(i => selectedIds.has(i.id)).map(item => ({ ...item, id: generateId(), dateAdded: new Date().toISOString(), lastModified: new Date().toISOString() })); setItems(prev => [...prev, ...newItems]); setSelectedIds(new Set()); showNotification(`${newItems.length} oggetti duplicati`); }, [items, selectedIds, showNotification]);

      // Image handling with WebP conversion
      const handleImageUpload = useCallback(async (e) => {
        const files = Array.from(e.target.files);
        const imgs = await Promise.all(files.map(f => convertToWebP(f)));
        setEditForm(prev => ({ ...prev, images: [...(prev.images || []), ...imgs] }));
      }, []);
      const addImageUrl = useCallback(() => { const url = prompt('Inserisci URL immagine:'); if (url) setEditForm(prev => ({ ...prev, images: [...(prev.images || []), url] })); }, []);
      const openLightbox = useCallback((images, index) => { setLightboxImages(images); setLightboxIndex(index); setLightboxOpen(true); }, []);
      const handleSort = useCallback((column) => { if (sortBy === column) setSortOrder(prev => prev === 'asc' ? 'desc' : 'asc'); else { setSortBy(column); setSortOrder('asc'); } }, [sortBy]);

      // PDF Export
      const exportPDF = useCallback(() => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('l', 'mm', 'a4');
        doc.setFontSize(18);
        doc.text('Collezione Vintage', 14, 15);
        doc.setFontSize(10);
        doc.text(`Esportato: ${formatDate(new Date().toISOString())}`, 14, 22);
        const tableData = filteredItems.map(item => {
          const total = (item.purchaseCost || 0) + (item.works?.reduce((s, w) => s + (w.cost || 0), 0) || 0) + (item.accessories?.reduce((s, a) => s + (a.cost || 0), 0) || 0);
          return [getBrandName(item.brandId), getModelName(item.modelId), item.version || '-', item.category || '-', item.year || '-', item.status || '-', item.aestheticGrade || '-', formatCurrency(total)];
        });
        doc.autoTable({ startY: 28, head: [['Marca', 'Modello', 'Versione', 'Categoria', 'Anno', 'Stato', 'Grado', 'Totale']], body: tableData, styles: { fontSize: 8 }, headStyles: { fillColor: [201, 168, 108], textColor: [26, 24, 20] } });
        const finalY = doc.lastAutoTable.finalY + 10;
        doc.setFontSize(11);
        doc.text(`Totale oggetti: ${filteredItems.length} | TOTALE: ${formatCurrency(stats.grandTotal)}`, 14, finalY);
        doc.save(`collezione-${new Date().toISOString().split('T')[0]}.pdf`);
        showNotification('PDF esportato');
      }, [filteredItems, stats, getBrandName, getModelName, showNotification]);

      const SortIcon = ({ column }) => sortBy !== column ? <span style={{ opacity: 0.3, marginLeft: 4 }}>â‡…</span> : <span style={{ marginLeft: 4 }}>{sortOrder === 'asc' ? 'â†‘' : 'â†“'}</span>;
      const isFormValid = editForm.brandId && editForm.category && editForm.location;
      const inputStyle = { width: '100%', padding: '14px 16px', border: '1px solid var(--border-medium)', borderRadius: 10, background: 'var(--bg-tertiary)', color: 'var(--text-primary)', fontSize: 15, fontFamily: 'inherit' };
      const btnStyle = { padding: '12px 18px', borderRadius: 10, border: 'none', cursor: 'pointer', fontSize: 14, fontWeight: 500, fontFamily: 'inherit', display: 'inline-flex', alignItems: 'center', gap: 8, transition: 'all 0.15s' };
      const thStyle = { padding: '14px 16px', textAlign: 'left', fontSize: 13, fontWeight: 600, color: 'var(--text-muted)', textTransform: 'uppercase', letterSpacing: '0.5px', borderBottom: '1px solid var(--border-subtle)', cursor: 'pointer', userSelect: 'none', whiteSpace: 'nowrap' };
      const tdStyle = { padding: '14px 16px', borderBottom: '1px solid var(--border-subtle)', fontSize: 15, verticalAlign: 'middle' };

      // Start Modal
      if (showStartModal) {
        return (
          <div style={{ minHeight: '100vh', display: 'flex', alignItems: 'center', justifyContent: 'center', background: 'linear-gradient(135deg, var(--bg-primary) 0%, #1f1c15 100%)', padding: 20 }}>
            <div style={{ width: '100%', maxWidth: 480, background: 'var(--bg-secondary)', borderRadius: 20, padding: 40, border: '1px solid var(--border-medium)', boxShadow: '0 25px 80px rgba(0,0,0,0.4)', textAlign: 'center' }}>
              <div style={{ width: 72, height: 72, background: 'linear-gradient(135deg, var(--accent-primary), var(--accent-secondary))', borderRadius: 16, display: 'flex', alignItems: 'center', justifyContent: 'center', margin: '0 auto 24px', fontSize: 32 }}>ðŸ–‹ï¸</div>
              <h1 style={{ margin: '0 0 8px', fontSize: 26 }}>Collezione Vintage</h1>
              <p style={{ margin: '0 0 32px', color: 'var(--text-muted)', fontSize: 14 }}>Gestione macchine da scrivere e calcolatrici v5.0</p>
              <div style={{ display: 'flex', flexDirection: 'column', gap: 12 }}>
                <button onClick={loadFile} style={{ ...btnStyle, width: '100%', justifyContent: 'center', padding: '16px 24px', background: 'var(--accent-primary)', color: '#1a1814', fontSize: 15, fontWeight: 600 }}>ðŸ“‚ Apri file esistente</button>
                <button onClick={startNew} style={{ ...btnStyle, width: '100%', justifyContent: 'center', padding: '16px 24px', background: 'var(--bg-tertiary)', color: 'var(--text-primary)', fontSize: 15 }}>âœ¨ Crea con dati esempio</button>
                <button onClick={startEmpty} style={{ ...btnStyle, width: '100%', justifyContent: 'center', padding: '16px 24px', background: 'var(--bg-tertiary)', color: 'var(--text-secondary)', fontSize: 14 }}>ðŸ“„ Collezione vuota</button>
              </div>
              <div style={{ marginTop: 32, padding: 16, background: 'var(--accent-info-soft)', borderRadius: 12, textAlign: 'left' }}>
                <div style={{ fontWeight: 600, color: 'var(--accent-info)', marginBottom: 8, fontSize: 13 }}>ðŸ’¡ NovitÃ  v5.0</div>
                <ul style={{ margin: 0, paddingLeft: 20, fontSize: 12, color: 'var(--text-secondary)', lineHeight: 1.8 }}>
                  <li><strong>ðŸ“· Galleria espandibile</strong> nel popup dettaglio</li>
                  <li><strong>Gestione foto</strong> in modifica riparazioni e accessori</li>
                  <li><strong>ZIP organizzato</strong> con cartelle per foto, riparazioni, accessori</li>
                  <li><strong>Riepilogo migliorato</strong> con contatori piÃ¹ grandi e tooltip</li>
                  <li><strong>Calcolo totale</strong> corretto con manutenzioni incluse</li>
                </ul>
              </div>
            </div>
          </div>
        );
      }

      return (
        <div style={{ minHeight: '100vh', background: 'var(--bg-primary)', fontFamily: "'Source Sans 3', sans-serif", color: 'var(--text-primary)' }}>
          {notification && <div style={{ position: 'fixed', top: 20, right: 20, left: isMobile ? 20 : 'auto', padding: '14px 20px', background: notification.type === 'success' ? 'var(--accent-success)' : notification.type === 'error' ? 'var(--accent-danger)' : 'var(--accent-warning)', color: '#1a1814', borderRadius: 10, fontWeight: 600, zIndex: 1000, animation: 'slideIn 0.25s', fontSize: 13, boxShadow: '0 4px 20px rgba(0,0,0,0.3)' }}>{notification.message}</div>}

          {worksPopup && <WorksPopup item={worksPopup} works={worksPopup.works || []} onClose={() => setWorksPopup(null)} onSave={(works) => handleSaveWorks(worksPopup.id, works)} brands={brands} models={models} />}
          {accessoriesPopup && <AccessoriesPopup item={accessoriesPopup} accessories={accessoriesPopup.accessories || []} onClose={() => setAccessoriesPopup(null)} onSave={(acc) => handleSaveAccessories(accessoriesPopup.id, acc)} brands={brands} models={models} accessoryTypes={accessoryTypes} />}
          {scheduledChecksPopup && <ScheduledChecksPopup item={scheduledChecksPopup} checks={scheduledChecksPopup.scheduledChecks || []} onClose={() => setScheduledChecksPopup(null)} onSave={(checks) => handleSaveScheduledChecks(scheduledChecksPopup.id, checks)} onConfirmCheck={(item, check) => setCheckConfirmPopup({ item, check })} brands={brands} models={models} maintenanceTypes={maintenanceTypes} categories={categories} />}
          {checkConfirmPopup && <CheckConfirmPopup item={checkConfirmPopup.item} check={checkConfirmPopup.check} onClose={() => setCheckConfirmPopup(null)} onConfirm={confirmCheck} maintenanceTypes={maintenanceTypes} />}

          {/* Header */}
          <header style={{ padding: isMobile ? '12px 16px' : '12px 24px', borderBottom: '1px solid var(--border-subtle)', background: 'var(--bg-secondary)' }}>
            <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', gap: 12 }}>
              <div style={{ display: 'flex', alignItems: 'center', gap: 10, minWidth: 0 }}>
                <div style={{ width: 36, height: 36, background: 'linear-gradient(135deg, var(--accent-primary), var(--accent-secondary))', borderRadius: 8, display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: 16, flexShrink: 0 }}>ðŸ–‹ï¸</div>
                <div style={{ minWidth: 0 }}>
                  <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
                    <h1 style={{ margin: 0, fontSize: isMobile ? 14 : 16, fontWeight: 700 }}>Collezione Vintage</h1>
                    <div className={`save-indicator ${!currentFileName ? 'no-file' : hasUnsavedChanges ? 'unsaved' : 'saved'}`} style={{ padding: '3px 8px', fontSize: 10 }}>{!currentFileName ? 'âš ï¸' : hasUnsavedChanges ? 'â—' : 'âœ“'}</div>
                  </div>
                  <span style={{ fontSize: 10, color: 'var(--text-muted)' }}>{currentFileName || 'Non salvato'}</span>
                </div>
              </div>
              <div style={{ display: 'flex', gap: 6, alignItems: 'center' }}>
                {!isMobile && <div style={{ display: 'flex', gap: 12, marginRight: 8, padding: '6px 12px', background: 'var(--bg-tertiary)', borderRadius: 8 }}>
                  <div style={{ textAlign: 'center' }}><div style={{ fontSize: 16, fontWeight: 700, color: 'var(--accent-primary)' }}>{stats.total}</div><div style={{ fontSize: 9, color: 'var(--text-muted)' }}>pezzi</div></div>
                  {showEconomics && <div style={{ textAlign: 'center', borderLeft: '1px solid var(--border-subtle)', paddingLeft: 12 }}><div style={{ fontSize: 16, fontWeight: 700, color: 'var(--accent-success)' }}>{formatCurrency(stats.grandTotal)}</div><div style={{ fontSize: 9, color: 'var(--text-muted)' }}>totale</div></div>}
                </div>}
                <button onClick={() => saveFile(false)} title="Salva" style={{ ...btnStyle, background: hasUnsavedChanges ? 'var(--accent-success)' : 'var(--accent-success-soft)', color: hasUnsavedChanges ? '#fff' : 'var(--accent-success)', padding: isMobile ? '8px' : '8px 12px' }}>ðŸ’¾{!isMobile && ' Salva'}</button>
                <button onClick={() => saveFile(true)} title="Salva con nome" style={{ ...btnStyle, background: 'var(--bg-tertiary)', color: 'var(--text-secondary)', padding: '8px' }}>ðŸ“¥</button>
                <button onClick={loadFile} title="Apri file" style={{ ...btnStyle, background: 'var(--bg-tertiary)', color: 'var(--text-secondary)', padding: '8px' }}>ðŸ“‚</button>
                <button onClick={() => setShowMasterData(true)} title="Anagrafiche" style={{ ...btnStyle, background: 'var(--accent-primary-soft)', color: 'var(--accent-primary)', padding: isMobile ? '8px' : '8px 12px' }}>âš™ï¸{!isMobile && ' Anagrafiche'}</button>
              </div>
            </div>
          </header>

          {/* Toolbar */}
          <div style={{ padding: isMobile ? '10px 16px' : '10px 24px', background: 'var(--bg-primary)', borderBottom: '1px solid var(--border-subtle)' }}>
            <div style={{ display: 'flex', gap: 8, alignItems: 'center', flexWrap: 'wrap' }}>
              <div style={{ position: 'relative', flex: isMobile ? '1 1 100%' : '0 0 160px' }}>
                <input type="text" placeholder="Cerca..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} style={{ ...inputStyle, paddingLeft: 36, padding: '8px 12px 8px 36px' }} />
                <span style={{ position: 'absolute', left: 12, top: '50%', transform: 'translateY(-50%)', color: 'var(--text-muted)', fontSize: 13 }}>ðŸ”</span>
              </div>
              <select value={brandFilter} onChange={(e) => setBrandFilter(e.target.value)} style={{ ...inputStyle, width: 'auto', minWidth: 100, padding: '8px 10px', fontSize: 12 }}><option value="Tutti">ðŸ­ Marca</option>{brands.map(b => <option key={b.id} value={b.id}>{b.name}</option>)}</select>
              <select value={categoryFilter} onChange={(e) => setCategoryFilter(e.target.value)} style={{ ...inputStyle, width: 'auto', minWidth: 110, padding: '8px 10px', fontSize: 12 }}><option value="Tutti">ðŸ·ï¸ Categoria</option>{categories.map(c => <option key={c.id} value={c.name}>{c.name}</option>)}</select>
              <select value={statusFilter} onChange={(e) => setStatusFilter(e.target.value)} style={{ ...inputStyle, width: 'auto', minWidth: 100, padding: '8px 10px', fontSize: 12 }}><option value="Tutti">ðŸ“‹ Stato</option>{statuses.map(s => <option key={s.id} value={s.name}>{s.icon} {s.name}</option>)}</select>
              {!isMobile && <select value={locationFilter} onChange={(e) => setLocationFilter(e.target.value)} style={{ ...inputStyle, width: 'auto', minWidth: 100, padding: '8px 10px', fontSize: 12 }}><option value="Tutte">ðŸ“ Ubicazione</option>{locations.map(l => <option key={l.id} value={l.name}>{l.name}</option>)}</select>}
              <div style={{ flex: 1 }} />
              {selectedIds.size > 0 && <><button onClick={duplicateSelected} title="Duplica selezionati" style={{ ...btnStyle, background: 'var(--accent-info-soft)', color: 'var(--accent-info)', padding: '6px 10px', fontSize: 11 }}>ðŸ“‹ {selectedIds.size}</button><button onClick={deleteSelected} title="Elimina selezionati" style={{ ...btnStyle, background: 'var(--accent-danger-soft)', color: 'var(--accent-danger)', padding: '6px 10px', fontSize: 11 }}>ðŸ—‘ï¸ {selectedIds.size}</button></>}
              <button onClick={handleAdd} title="Aggiungi nuovo oggetto" style={{ ...btnStyle, background: 'var(--accent-primary)', color: '#1a1814', padding: '8px 14px' }}>+ Nuovo</button>
            </div>
            {/* Secondary row */}
            <div style={{ display: 'flex', gap: 8, alignItems: 'center', marginTop: 8, flexWrap: 'wrap' }}>
              <span style={{ fontSize: 11, color: 'var(--text-muted)' }}>Mostra</span>
              <select value={rowsPerPage} onChange={(e) => { setRowsPerPage(e.target.value === 'all' ? 'all' : parseInt(e.target.value)); setCurrentPage(1); }} style={{ ...inputStyle, width: 65, padding: '4px 8px', fontSize: 11 }}><option value={10}>10</option><option value={25}>25</option><option value={50}>50</option><option value="all">Tutti</option></select>
              <span style={{ fontSize: 11, color: 'var(--text-muted)' }}>|</span>
              <span style={{ fontSize: 11, color: 'var(--text-secondary)', fontWeight: 500 }}>{filteredItems.length} risultati{filteredItems.length !== items.length && ` su ${items.length}`}</span>
              <div style={{ flex: 1 }} />
              <button onClick={exportPDF} title="Esporta lista completa in PDF" style={{ ...btnStyle, background: 'var(--accent-danger-soft)', color: 'var(--accent-danger)', padding: '8px 14px', fontSize: 12, border: '1px solid var(--accent-danger)' }}>ðŸ“„ PDF</button>
              <button onClick={async () => { const count = await exportImagesAsZip(items, getBrandName, getModelName); if (count) showNotification(`${count} immagini esportate`); else showNotification('Nessuna immagine', 'error'); }} title="Esporta tutte le immagini in archivio ZIP" style={{ ...btnStyle, background: 'var(--accent-info-soft)', color: 'var(--accent-info)', padding: '8px 14px', fontSize: 12, border: '1px solid var(--accent-info)' }}>ðŸ“¸ ZIP</button>
            </div>
          </div>

          {/* Stats Mobile */}
          {isMobile && <div style={{ display: 'flex', gap: 8, padding: '10px 16px', background: 'var(--bg-card)', borderBottom: '1px solid var(--border-subtle)', justifyContent: 'center' }}>
            <div style={{ padding: '6px 14px', background: 'var(--accent-primary-soft)', borderRadius: 8, textAlign: 'center' }}><span style={{ fontSize: 14, fontWeight: 700, color: 'var(--accent-primary)' }}>{stats.total}</span><span style={{ fontSize: 10, color: 'var(--text-muted)', marginLeft: 4 }}>pezzi</span></div>
            {showEconomics && <div style={{ padding: '6px 14px', background: 'var(--accent-success-soft)', borderRadius: 8, textAlign: 'center' }}><span style={{ fontSize: 14, fontWeight: 700, color: 'var(--accent-success)' }}>{formatCurrency(stats.grandTotal)}</span></div>}
          </div>}

          {/* Table */}
          <div style={{ padding: isMobile ? '0 16px 24px' : '0 24px 24px', overflowX: 'auto' }}>
            <table style={{ width: '100%', borderCollapse: 'collapse', marginTop: 16, tableLayout: 'auto' }}>
              <thead><tr style={{ background: 'var(--bg-secondary)' }}>
                <th style={{ ...thStyle, width: 40, padding: '12px 8px' }} onClick={toggleSelectAll}><div style={{ width: 18, height: 18, borderRadius: 4, background: selectedIds.size === paginatedItems.length && paginatedItems.length > 0 ? 'var(--accent-primary)' : 'var(--bg-tertiary)', border: selectedIds.size === paginatedItems.length && paginatedItems.length > 0 ? 'none' : '2px solid var(--border-medium)', display: 'flex', alignItems: 'center', justifyContent: 'center', color: '#fff', fontSize: 11 }}>{selectedIds.size === paginatedItems.length && paginatedItems.length > 0 && 'âœ“'}</div></th>
                <th style={{ ...thStyle, width: 50, padding: '12px 8px' }}>Foto</th>
                <th style={{ ...thStyle, padding: '12px 10px' }} onClick={() => handleSort('brand')}>Marca<SortIcon column="brand" /></th>
                <th style={{ ...thStyle, padding: '12px 10px' }} onClick={() => handleSort('model')}>Modello<SortIcon column="model" /></th>
                <th style={{ ...thStyle, padding: '12px 10px' }} onClick={() => handleSort('category')}>Categoria<SortIcon column="category" /></th>
                <th style={{ ...thStyle, width: 60, padding: '12px 8px' }} onClick={() => handleSort('year')}>Anno<SortIcon column="year" /></th>
                <th style={{ ...thStyle, padding: '12px 10px' }} onClick={() => handleSort('status')}>Stato<SortIcon column="status" /></th>
                <th style={{ ...thStyle, padding: '12px 8px' }} onClick={() => handleSort('aestheticGrade')}>Grado<SortIcon column="aestheticGrade" /></th>
                <th style={{ ...thStyle, textAlign: 'center', cursor: 'default', padding: '12px 8px' }}>L/A</th>
                <th style={{ ...thStyle, textAlign: 'center', cursor: 'default', padding: '12px 6px', width: 36 }} title="Controlli programmati">ðŸ””</th>
                {showEconomics && <th style={{ ...thStyle, textAlign: 'right', padding: '12px 10px' }} onClick={() => handleSort('totalCost')}>Totale<SortIcon column="totalCost" /></th>}
                <th style={{ ...thStyle, width: 80, padding: '12px 8px' }} onClick={() => handleSort('dateAdded')}>Ins.<SortIcon column="dateAdded" /></th>
                <th style={{ ...thStyle, textAlign: 'center', cursor: 'default', width: 100, padding: '12px 8px' }}>Azioni</th>
              </tr></thead>
              <tbody>
                {paginatedItems.map(item => {
                  const isSelected = selectedIds.has(item.id);
                  const statusInfo = getStatusInfo(item.status);
                  const gradeInfo = getGradeInfo(item.aestheticGrade);
                  const worksCount = item.works?.length || 0;
                  const worksCost = item.works?.reduce((s, w) => s + (w.cost || 0), 0) || 0;
                  const accessoriesCount = item.accessories?.length || 0;
                  const accessoriesCost = item.accessories?.reduce((s, a) => s + (a.cost || 0), 0) || 0;
                  const maintenanceCost = item.scheduledChecks?.reduce((s, c) => s + (c.history?.reduce((h, e) => h + (e.cost || 0), 0) || 0), 0) || 0;
                  const totalCost = (item.purchaseCost || 0) + worksCost + accessoriesCost + maintenanceCost;
                  const maintStatus = getMaintenanceStatus(item);
                  return (
                    <tr key={item.id} onClick={() => { setSelectedItem(item); setActiveImageIndex(0); }} style={{ background: isSelected ? 'var(--accent-primary-soft)' : 'transparent', cursor: 'pointer', transition: 'background 0.15s' }} onMouseEnter={(e) => { if (!isSelected) e.currentTarget.style.background = 'var(--bg-hover)'; }} onMouseLeave={(e) => { if (!isSelected) e.currentTarget.style.background = 'transparent'; }}>
                      <td style={{ ...tdStyle, padding: '10px 6px' }} onClick={(e) => e.stopPropagation()}><div onClick={(e) => toggleSelect(item.id, e)} style={{ width: 16, height: 16, borderRadius: 4, background: isSelected ? 'var(--accent-primary)' : 'var(--bg-tertiary)', border: isSelected ? 'none' : '2px solid var(--border-medium)', display: 'flex', alignItems: 'center', justifyContent: 'center', color: '#fff', fontSize: 9, cursor: 'pointer' }}>{isSelected && 'âœ“'}</div></td>
                      <td style={{ ...tdStyle, padding: '10px 6px' }} onClick={(e) => { e.stopPropagation(); if (item.images?.length) openLightbox(item.images, 0); }}><div style={{ width: 36, height: 36, borderRadius: 6, background: item.images?.[0] ? `url(${item.images[0]}) center/cover` : 'var(--bg-tertiary)', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: 12, border: '1px solid var(--border-subtle)', cursor: item.images?.length ? 'zoom-in' : 'default', color: 'var(--text-muted)' }}>{!item.images?.[0] && 'ðŸ–‹ï¸'}</div></td>
                      <td style={{ ...tdStyle, fontWeight: 600, color: 'var(--accent-primary)', padding: '14px 10px', whiteSpace: 'nowrap', fontSize: 14 }}>{getBrandName(item.brandId)}</td>
                      <td style={{ ...tdStyle, padding: '14px 10px', whiteSpace: 'nowrap', fontSize: 14 }}>{getModelName(item.modelId)}</td>
                      <td style={{ ...tdStyle, padding: '14px 10px' }}><span style={{ fontSize: 12, padding: '4px 8px', background: `${getCategoryColor(item.category)}20`, borderRadius: 6, color: getCategoryColor(item.category), fontWeight: 500, whiteSpace: 'nowrap' }}>{item.category || '-'}</span></td>
                      <td style={{ ...tdStyle, fontWeight: 500, color: 'var(--accent-secondary)', padding: '14px 8px', textAlign: 'center', fontSize: 14 }}>{item.year || '-'}</td>
                      <td style={{ ...tdStyle, padding: '14px 10px' }}><span style={{ fontSize: 12, padding: '4px 8px', background: `${statusInfo.color}20`, borderRadius: 6, color: statusInfo.color, fontWeight: 500, display: 'inline-flex', alignItems: 'center', gap: 4, whiteSpace: 'nowrap' }}>{statusInfo.icon} {item.status || '-'}</span></td>
                      <td style={{ ...tdStyle, padding: '14px 8px', textAlign: 'center' }}>{item.aestheticGrade && <span style={{ fontSize: 12, padding: '4px 8px', background: `${gradeInfo.color}20`, borderRadius: 6, color: gradeInfo.color, fontWeight: 500 }}>{item.aestheticGrade}</span>}</td>
                      <td style={{ ...tdStyle, textAlign: 'center', padding: '14px 6px' }} onClick={(e) => e.stopPropagation()}><div style={{ display: 'flex', gap: 4, justifyContent: 'center' }}>
                        <button onClick={() => setWorksPopup(item)} title="Riparazioni" style={{ ...btnStyle, padding: '5px 8px', background: worksCount > 0 ? 'var(--accent-work-soft)' : 'var(--bg-tertiary)', color: worksCount > 0 ? 'var(--accent-work)' : 'var(--text-muted)', fontSize: 11, minWidth: 32 }}>{worksCount}</button>
                        <button onClick={() => setAccessoriesPopup(item)} title="Accessori" style={{ ...btnStyle, padding: '5px 8px', background: accessoriesCount > 0 ? 'var(--accent-accessory-soft)' : 'var(--bg-tertiary)', color: accessoriesCount > 0 ? 'var(--accent-accessory)' : 'var(--text-muted)', fontSize: 11, minWidth: 32 }}>{accessoriesCount}</button>
                      </div></td>
                      <td style={{ ...tdStyle, textAlign: 'center', padding: '14px 4px' }} onClick={(e) => e.stopPropagation()}>
                        {maintStatus.count > 0 ? (
                          <button onClick={() => setScheduledChecksPopup(item)} title={`${maintStatus.count} controlli programmati${maintStatus.overdue > 0 ? ` (${maintStatus.overdue} scaduti!)` : maintStatus.soon > 0 ? ` (${maintStatus.soon} in scadenza)` : ''}`} style={{ ...btnStyle, padding: '5px 8px', fontSize: 12, background: maintStatus.status === 'overdue' ? 'var(--accent-danger)' : maintStatus.status === 'soon' ? 'var(--accent-warning)' : 'var(--accent-success-soft)', color: maintStatus.status === 'overdue' ? '#fff' : maintStatus.status === 'soon' ? '#1a1814' : 'var(--accent-success)', animation: maintStatus.status === 'overdue' ? 'pulse 1s infinite' : 'none' }}>
                            {maintStatus.status === 'overdue' ? 'âš ï¸' : maintStatus.status === 'soon' ? 'ðŸ””' : 'âœ“'}
                          </button>
                        ) : (
                          <span style={{ fontSize: 12, color: 'var(--text-muted)' }}>-</span>
                        )}
                      </td>
                      {showEconomics && <td style={{ ...tdStyle, textAlign: 'right', fontWeight: 600, color: 'var(--accent-success)', padding: '14px 10px', whiteSpace: 'nowrap', fontSize: 14 }}>{formatCurrency(totalCost)}</td>}
                      <td style={{ ...tdStyle, padding: '10px 6px', fontSize: 10, color: 'var(--text-muted)', whiteSpace: 'nowrap' }}>{item.dateAdded ? new Date(item.dateAdded).toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit', year: '2-digit' }) : '-'}</td>
                      <td style={{ ...tdStyle, textAlign: 'center', padding: '10px 4px' }} onClick={(e) => e.stopPropagation()}><div style={{ display: 'flex', gap: 3, justifyContent: 'center' }}>
                        <button onClick={(e) => handleEdit(item, e)} title="Modifica" style={{ ...btnStyle, padding: '5px 7px', background: 'var(--accent-info-soft)', color: 'var(--accent-info)', fontSize: 11 }}>âœï¸</button>
                        <button onClick={(e) => duplicateItem(item, e)} title="Duplica" style={{ ...btnStyle, padding: '5px 7px', background: 'var(--bg-tertiary)', color: 'var(--text-secondary)', fontSize: 11 }}>ðŸ“‹</button>
                        <button onClick={(e) => deleteItem(item.id, e)} title="Elimina" style={{ ...btnStyle, padding: '5px 7px', background: 'var(--accent-danger-soft)', color: 'var(--accent-danger)', fontSize: 11 }}>ðŸ—‘ï¸</button>
                      </div></td>
                    </tr>
                  );
                })}
              </tbody>
            </table>

            {paginatedItems.length === 0 && <div style={{ textAlign: 'center', padding: 60, color: 'var(--text-muted)' }}><div style={{ fontSize: 48, marginBottom: 16, opacity: 0.5 }}>ðŸ–‹ï¸</div><div style={{ fontSize: 14 }}>{searchTerm || categoryFilter !== 'Tutti' || brandFilter !== 'Tutti' || locationFilter !== 'Tutte' || statusFilter !== 'Tutti' ? 'Nessun risultato' : 'Nessun oggetto'}</div></div>}

            {/* Pagination */}
            {totalPages > 1 && <div style={{ display: 'flex', justifyContent: 'center', alignItems: 'center', gap: 8, marginTop: 20 }}>
              <button onClick={() => setCurrentPage(p => Math.max(1, p - 1))} disabled={currentPage === 1} style={{ ...btnStyle, padding: '8px 12px', background: 'var(--bg-tertiary)', color: currentPage === 1 ? 'var(--text-muted)' : 'var(--text-primary)', cursor: currentPage === 1 ? 'not-allowed' : 'pointer' }}>â—€</button>
              <span style={{ fontSize: 13, color: 'var(--text-secondary)' }}>Pagina {currentPage} di {totalPages}</span>
              <button onClick={() => setCurrentPage(p => Math.min(totalPages, p + 1))} disabled={currentPage === totalPages} style={{ ...btnStyle, padding: '8px 12px', background: 'var(--bg-tertiary)', color: currentPage === totalPages ? 'var(--text-muted)' : 'var(--text-primary)', cursor: currentPage === totalPages ? 'not-allowed' : 'pointer' }}>â–¶</button>
            </div>}

            {/* Collection Summary */}
            <div style={{ marginTop: 24, padding: 20, background: 'var(--bg-secondary)', borderRadius: 12, border: '1px solid var(--border-subtle)' }}>
              <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: 16 }}>
                <span style={{ fontSize: 16, fontWeight: 700, display: 'flex', alignItems: 'center', gap: 8 }}>ðŸ“Š Riepilogo</span>
                <button onClick={() => setShowEconomics(!showEconomics)} title={showEconomics ? 'Nascondi dati economici' : 'Mostra dati economici'} style={{ ...btnStyle, padding: '6px 14px', fontSize: 12, background: showEconomics ? 'var(--accent-primary)' : 'var(--bg-tertiary)', color: showEconomics ? '#1a1814' : 'var(--text-muted)' }}>{showEconomics ? 'ðŸ’° Nascondi â‚¬' : 'ðŸ’° Mostra â‚¬'}</button>
              </div>
              
              {/* Compact stats row - larger and more visible */}
              <div style={{ display: 'flex', gap: 12, flexWrap: 'wrap', marginBottom: 16 }}>
                <div title="Totale pezzi in collezione" style={{ padding: '12px 20px', background: 'var(--accent-primary-soft)', borderRadius: 10, display: 'flex', alignItems: 'center', gap: 10, border: '2px solid var(--accent-primary)', cursor: 'default' }}>
                  <span style={{ fontSize: 18 }}>ðŸ–‹ï¸</span>
                  <span style={{ fontSize: 22, fontWeight: 800, color: 'var(--accent-primary)' }}>{stats.total}</span>
                  <span style={{ fontSize: 12, color: 'var(--accent-primary)', fontWeight: 500 }}>pezzi</span>
                </div>
                <div title="Totale riparazioni effettuate" style={{ padding: '12px 18px', background: 'var(--accent-work-soft)', borderRadius: 10, display: 'flex', alignItems: 'center', gap: 8, border: '1px solid var(--accent-work)', cursor: 'default' }}>
                  <span style={{ fontSize: 16 }}>ðŸ”§</span>
                  <span style={{ fontSize: 18, fontWeight: 700, color: 'var(--accent-work)' }}>{stats.totalWorksCount}</span>
                </div>
                <div title="Totale accessori catalogati" style={{ padding: '12px 18px', background: 'var(--accent-accessory-soft)', borderRadius: 10, display: 'flex', alignItems: 'center', gap: 8, border: '1px solid var(--accent-accessory)', cursor: 'default' }}>
                  <span style={{ fontSize: 16 }}>ðŸ“¦</span>
                  <span style={{ fontSize: 18, fontWeight: 700, color: 'var(--accent-accessory)' }}>{stats.totalAccessoriesCount}</span>
                </div>
                <div title="Totale fotografie caricate" style={{ padding: '12px 18px', background: 'var(--bg-card)', borderRadius: 10, display: 'flex', alignItems: 'center', gap: 8, border: '1px solid var(--border-medium)', cursor: 'default' }}>
                  <span style={{ fontSize: 16 }}>ðŸ“·</span>
                  <span style={{ fontSize: 18, fontWeight: 700, color: 'var(--text-secondary)' }}>{items.reduce((s, i) => s + (i.images?.length || 0), 0)}</span>
                </div>
              </div>
              
              {/* Categories and statuses in two columns */}
              <div style={{ display: 'grid', gridTemplateColumns: isMobile ? '1fr' : '1fr 1fr', gap: 16 }}>
                <div>
                  <div style={{ fontSize: 11, color: 'var(--text-muted)', marginBottom: 8, fontWeight: 600, textTransform: 'uppercase' }}>Per Categoria</div>
                  <div style={{ display: 'flex', flexWrap: 'wrap', gap: 6 }}>
                    {categories.map(cat => {
                      const count = items.filter(i => i.category === cat.name).length;
                      if (count === 0) return null;
                      return <div key={cat.id} title={`${count} oggetti in ${cat.name}`} style={{ padding: '6px 12px', background: `${cat.color}20`, borderRadius: 8, fontSize: 12, display: 'flex', alignItems: 'center', gap: 6, border: `1px solid ${cat.color}40`, cursor: 'default' }}>
                        <span style={{ color: cat.color, fontWeight: 500 }}>{cat.name}</span>
                        <span style={{ fontWeight: 700, color: cat.color, background: `${cat.color}30`, padding: '2px 6px', borderRadius: 4, fontSize: 11 }}>{count}</span>
                      </div>;
                    })}
                  </div>
                </div>
                <div>
                  <div style={{ fontSize: 11, color: 'var(--text-muted)', marginBottom: 8, fontWeight: 600, textTransform: 'uppercase' }}>Per Stato</div>
                  <div style={{ display: 'flex', flexWrap: 'wrap', gap: 6 }}>
                    {statuses.map(status => {
                      const count = items.filter(i => i.status === status.name).length;
                      if (count === 0) return null;
                      return <div key={status.id} title={`${count} oggetti ${status.name}`} style={{ padding: '6px 12px', background: `${status.color}20`, borderRadius: 8, fontSize: 12, display: 'flex', alignItems: 'center', gap: 6, border: `1px solid ${status.color}40`, cursor: 'default' }}>
                        <span>{status.icon}</span>
                        <span style={{ color: status.color, fontWeight: 500 }}>{status.name}</span>
                        <span style={{ fontWeight: 700, color: status.color, background: `${status.color}30`, padding: '2px 6px', borderRadius: 4, fontSize: 11 }}>{count}</span>
                      </div>;
                    })}
                  </div>
                </div>
              </div>
              
              {/* Economic details - toggleable */}
              {showEconomics && <div style={{ display: 'flex', gap: 10, flexWrap: 'wrap', marginTop: 16, paddingTop: 16, borderTop: '1px solid var(--border-subtle)' }}>
                <div title="Totale speso in acquisti" style={{ padding: '10px 16px', background: 'var(--bg-card)', borderRadius: 10, flex: '1 1 auto', textAlign: 'center', cursor: 'default' }}><div style={{ fontSize: 10, color: 'var(--text-muted)', marginBottom: 4 }}>Acquisti</div><div style={{ fontSize: 16, fontWeight: 700, color: 'var(--accent-primary)' }}>{formatCurrency(stats.totalPurchaseCost)}</div></div>
                <div title={`Totale speso per ${stats.totalWorksCount} riparazioni`} style={{ padding: '10px 16px', background: 'var(--bg-card)', borderRadius: 10, flex: '1 1 auto', textAlign: 'center', cursor: 'default' }}><div style={{ fontSize: 10, color: 'var(--text-muted)', marginBottom: 4 }}>Riparazioni ({stats.totalWorksCount})</div><div style={{ fontSize: 16, fontWeight: 700, color: 'var(--accent-work)' }}>{formatCurrency(stats.totalWorksCost)}</div></div>
                <div title={`Totale speso per ${stats.totalAccessoriesCount} accessori`} style={{ padding: '10px 16px', background: 'var(--bg-card)', borderRadius: 10, flex: '1 1 auto', textAlign: 'center', cursor: 'default' }}><div style={{ fontSize: 10, color: 'var(--text-muted)', marginBottom: 4 }}>Accessori ({stats.totalAccessoriesCount})</div><div style={{ fontSize: 16, fontWeight: 700, color: 'var(--accent-accessory)' }}>{formatCurrency(stats.totalAccessoriesCost)}</div></div>
                <div title={`Totale speso per ${stats.totalMaintenanceCount} manutenzioni`} style={{ padding: '10px 16px', background: 'var(--bg-card)', borderRadius: 10, flex: '1 1 auto', textAlign: 'center', cursor: 'default' }}><div style={{ fontSize: 10, color: 'var(--text-muted)', marginBottom: 4 }}>Manutenzioni ({stats.totalMaintenanceCount})</div><div style={{ fontSize: 16, fontWeight: 700, color: 'var(--accent-warning)' }}>{formatCurrency(stats.totalMaintenanceCost)}</div></div>
                <div title="Totale investito nella collezione" style={{ padding: '12px 20px', background: 'var(--accent-success-soft)', borderRadius: 10, border: '2px solid var(--accent-success)', flex: '1 1 auto', textAlign: 'center', cursor: 'default' }}><div style={{ fontSize: 10, color: 'var(--accent-success)', fontWeight: 600, marginBottom: 4 }}>TOTALE INVESTITO</div><div style={{ fontSize: 20, fontWeight: 800, color: 'var(--accent-success)' }}>{formatCurrency(stats.grandTotal)}</div></div>
              </div>}
            </div>
          </div>

          {/* Master Data Modal */}
          {showMasterData && (
            <div style={{ position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.8)', backdropFilter: 'blur(8px)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 100, padding: 20 }} onClick={() => setShowMasterData(false)}>
              <div style={{ width: '100%', maxWidth: 850, maxHeight: '90vh', overflowY: 'auto', background: 'var(--bg-secondary)', borderRadius: 16, border: '1px solid var(--border-medium)', boxShadow: '0 25px 80px rgba(0,0,0,0.5)' }} onClick={(e) => e.stopPropagation()}>
                <div style={{ padding: '20px 24px', borderBottom: '1px solid var(--border-subtle)', display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>
                  <h2 style={{ margin: 0, fontSize: 18, display: 'flex', alignItems: 'center', gap: 10 }}><span style={{ fontSize: 22 }}>âš™ï¸</span> Dati Anagrafici</h2>
                  <button onClick={() => setShowMasterData(false)} style={{ width: 36, height: 36, borderRadius: 8, background: 'var(--bg-tertiary)', border: 'none', color: 'var(--text-muted)', cursor: 'pointer', fontSize: 18 }}>Ã—</button>
                </div>
                <div style={{ display: 'flex', borderBottom: '1px solid var(--border-subtle)', overflowX: 'auto' }}>
                  {[{ key: 'brands', label: 'ðŸ­ Marche', count: brands.length }, { key: 'models', label: 'ðŸ“¦ Modelli', count: models.length }, { key: 'categories', label: 'ðŸ·ï¸ Categorie', count: categories.length }, { key: 'subcategories', label: 'ðŸ“‚ Sottocategorie', count: subcategories.length }, { key: 'locations', label: 'ðŸ“ Ubicazioni', count: locations.length }, { key: 'statuses', label: 'ðŸ“‹ Stati', count: statuses.length }, { key: 'accessoryTypes', label: 'ðŸŽ’ Tipi Acc.', count: accessoryTypes.length }, { key: 'maintenanceTypes', label: 'ðŸ”§ Manutenzioni', count: maintenanceTypes.length }].map(tab => (
                    <button key={tab.key} onClick={() => setMasterDataTab(tab.key)} style={{ padding: '14px 16px', background: masterDataTab === tab.key ? 'var(--bg-tertiary)' : 'transparent', border: 'none', borderBottom: masterDataTab === tab.key ? '2px solid var(--accent-primary)' : '2px solid transparent', color: masterDataTab === tab.key ? 'var(--accent-primary)' : 'var(--text-secondary)', cursor: 'pointer', fontSize: 12, fontWeight: 500, fontFamily: 'inherit', whiteSpace: 'nowrap' }}>{tab.label} ({tab.count})</button>
                  ))}
                </div>
                <div style={{ padding: 24 }}>
                  {/* Brands Tab */}
                  {masterDataTab === 'brands' && <>
                    <div style={{ display: 'flex', gap: 10, marginBottom: 20 }}>
                      <input value={newBrandName} onChange={(e) => setNewBrandName(e.target.value)} style={{ ...inputStyle, flex: 1 }} placeholder="Nome nuova marca..." onKeyDown={(e) => e.key === 'Enter' && addBrand(newBrandName)} />
                      <button onClick={() => addBrand(newBrandName)} disabled={!newBrandName.trim()} style={{ ...btnStyle, background: newBrandName.trim() ? 'var(--accent-primary)' : 'var(--bg-tertiary)', color: newBrandName.trim() ? '#1a1814' : 'var(--text-muted)' }}>+ Aggiungi</button>
                    </div>
                    <div style={{ display: 'flex', flexDirection: 'column', gap: 8 }}>
                      {brands.map(brand => {
                        const count = items.filter(i => i.brandId === brand.id).length;
                        const modelCount = models.filter(m => m.brandId === brand.id).length;
                        return (
                          <div key={brand.id} style={{ display: 'flex', alignItems: 'center', gap: 12, padding: 14, background: 'var(--bg-card)', borderRadius: 10, border: '1px solid var(--border-subtle)' }}>
                            {editingBrand?.id === brand.id ? <>
                              <input value={editingBrand.name} onChange={(e) => setEditingBrand({ ...editingBrand, name: e.target.value })} style={{ ...inputStyle, flex: 1 }} autoFocus />
                              <button onClick={() => updateBrand(brand.id, editingBrand.name)} style={{ ...btnStyle, background: 'var(--accent-success)', color: '#fff', padding: '8px 14px' }}>âœ“</button>
                              <button onClick={() => setEditingBrand(null)} style={{ ...btnStyle, background: 'var(--bg-tertiary)', color: 'var(--text-secondary)', padding: '8px 14px' }}>âœ•</button>
                            </> : <>
                              <span style={{ fontSize: 16 }}>ðŸ­</span>
                              <span style={{ flex: 1, fontWeight: 500 }}>{brand.name}</span>
                              <span style={{ fontSize: 11, color: 'var(--text-muted)', padding: '6px 12px', background: 'var(--bg-tertiary)', borderRadius: 6 }}>{count} oggetti, {modelCount} modelli</span>
                              <button onClick={() => setEditingBrand({ ...brand })} title="Modifica" style={{ ...btnStyle, background: 'var(--accent-info-soft)', color: 'var(--accent-info)', padding: '8px 12px' }}>âœï¸</button>
                              <button onClick={() => deleteBrand(brand.id)} disabled={count > 0 || modelCount > 0} title="Elimina" style={{ ...btnStyle, background: (count > 0 || modelCount > 0) ? 'var(--bg-tertiary)' : 'var(--accent-danger-soft)', color: (count > 0 || modelCount > 0) ? 'var(--text-muted)' : 'var(--accent-danger)', padding: '8px 12px', cursor: (count > 0 || modelCount > 0) ? 'not-allowed' : 'pointer' }}>ðŸ—‘ï¸</button>
                            </>}
                          </div>
                        );
                      })}
                    </div>
                  </>}

                  {/* Models Tab */}
                  {masterDataTab === 'models' && <>
                    <div style={{ display: 'flex', gap: 10, marginBottom: 20, flexWrap: 'wrap' }}>
                      <select value={newModelBrandId} onChange={(e) => setNewModelBrandId(e.target.value)} style={{ ...inputStyle, width: 160 }}><option value="">Seleziona marca...</option>{brands.map(b => <option key={b.id} value={b.id}>{b.name}</option>)}</select>
                      <input value={newModelName} onChange={(e) => setNewModelName(e.target.value)} style={{ ...inputStyle, flex: 1 }} placeholder="Nome nuovo modello..." />
                      <button onClick={() => addModel(newModelName, newModelBrandId)} disabled={!newModelName.trim() || !newModelBrandId} style={{ ...btnStyle, background: (newModelName.trim() && newModelBrandId) ? 'var(--accent-primary)' : 'var(--bg-tertiary)', color: (newModelName.trim() && newModelBrandId) ? '#1a1814' : 'var(--text-muted)' }}>+ Aggiungi</button>
                    </div>
                    <div style={{ display: 'flex', flexDirection: 'column', gap: 8 }}>
                      {models.map(model => {
                        const count = items.filter(i => i.modelId === model.id).length;
                        const brandName = getBrandName(model.brandId);
                        return (
                          <div key={model.id} style={{ display: 'flex', alignItems: 'center', gap: 12, padding: 14, background: 'var(--bg-card)', borderRadius: 10, border: '1px solid var(--border-subtle)', flexWrap: 'wrap' }}>
                            {editingModel?.id === model.id ? <>
                              <select value={editingModel.brandId} onChange={(e) => setEditingModel({ ...editingModel, brandId: e.target.value })} style={{ ...inputStyle, width: 150 }}>{brands.map(b => <option key={b.id} value={b.id}>{b.name}</option>)}</select>
                              <input value={editingModel.name} onChange={(e) => setEditingModel({ ...editingModel, name: e.target.value })} style={{ ...inputStyle, flex: 1 }} />
                              <button onClick={() => updateModel(model.id, editingModel.name, editingModel.brandId)} style={{ ...btnStyle, background: 'var(--accent-success)', color: '#fff', padding: '8px 14px' }}>âœ“</button>
                              <button onClick={() => setEditingModel(null)} style={{ ...btnStyle, background: 'var(--bg-tertiary)', color: 'var(--text-secondary)', padding: '8px 14px' }}>âœ•</button>
                            </> : <>
                              <span style={{ fontSize: 16 }}>ðŸ“¦</span>
                              <span style={{ fontSize: 12, padding: '4px 10px', background: 'var(--accent-primary-soft)', borderRadius: 6, color: 'var(--accent-primary)' }}>{brandName}</span>
                              <span style={{ flex: 1, fontWeight: 500 }}>{model.name}</span>
                              <span style={{ fontSize: 11, color: 'var(--text-muted)', padding: '6px 12px', background: 'var(--bg-tertiary)', borderRadius: 6 }}>{count} oggetti</span>
                              <button onClick={() => setEditingModel({ ...model })} title="Modifica" style={{ ...btnStyle, background: 'var(--accent-info-soft)', color: 'var(--accent-info)', padding: '8px 12px' }}>âœï¸</button>
                              <button onClick={() => deleteModel(model.id)} disabled={count > 0} title="Elimina" style={{ ...btnStyle, background: count > 0 ? 'var(--bg-tertiary)' : 'var(--accent-danger-soft)', color: count > 0 ? 'var(--text-muted)' : 'var(--accent-danger)', padding: '8px 12px', cursor: count > 0 ? 'not-allowed' : 'pointer' }}>ðŸ—‘ï¸</button>
                            </>}
                          </div>
                        );
                      })}
                    </div>
                  </>}

                  {/* Categories Tab */}
                  {masterDataTab === 'categories' && <>
                    <div style={{ display: 'flex', gap: 10, marginBottom: 20 }}>
                      <input type="color" value={newCategoryColor} onChange={(e) => setNewCategoryColor(e.target.value)} style={{ width: 50, height: 42, border: 'none', borderRadius: 8, cursor: 'pointer' }} />
                      <input value={newCategoryName} onChange={(e) => setNewCategoryName(e.target.value)} style={{ ...inputStyle, flex: 1 }} placeholder="Nome nuova categoria..." />
                      <button onClick={() => addCategory(newCategoryName, newCategoryColor)} disabled={!newCategoryName.trim()} style={{ ...btnStyle, background: newCategoryName.trim() ? 'var(--accent-primary)' : 'var(--bg-tertiary)', color: newCategoryName.trim() ? '#1a1814' : 'var(--text-muted)' }}>+ Aggiungi</button>
                    </div>
                    <div style={{ display: 'flex', flexDirection: 'column', gap: 8 }}>
                      {categories.map(cat => {
                        const count = items.filter(i => i.category === cat.name).length;
                        const subCount = subcategories.filter(s => s.categoryId === cat.id).length;
                        return (
                          <div key={cat.id} style={{ display: 'flex', alignItems: 'center', gap: 12, padding: 14, background: 'var(--bg-card)', borderRadius: 10, border: '1px solid var(--border-subtle)' }}>
                            {editingCategory?.id === cat.id ? <>
                              <input type="color" value={editingCategory.color} onChange={(e) => setEditingCategory({ ...editingCategory, color: e.target.value })} style={{ width: 40, height: 36, border: 'none', borderRadius: 6, cursor: 'pointer' }} />
                              <input value={editingCategory.name} onChange={(e) => setEditingCategory({ ...editingCategory, name: e.target.value })} style={{ ...inputStyle, flex: 1 }} />
                              <button onClick={() => updateCategory(cat.id, editingCategory.name, editingCategory.color)} style={{ ...btnStyle, background: 'var(--accent-success)', color: '#fff', padding: '8px 14px' }}>âœ“</button>
                              <button onClick={() => setEditingCategory(null)} style={{ ...btnStyle, background: 'var(--bg-tertiary)', color: 'var(--text-secondary)', padding: '8px 14px' }}>âœ•</button>
                            </> : <>
                              <div style={{ width: 20, height: 20, borderRadius: 6, background: cat.color }} />
                              <span style={{ flex: 1, fontWeight: 500 }}>{cat.name}</span>
                              <span style={{ fontSize: 11, color: 'var(--text-muted)', padding: '6px 12px', background: 'var(--bg-tertiary)', borderRadius: 6 }}>{count} oggetti, {subCount} sottocategorie</span>
                              <button onClick={() => setEditingCategory({ ...cat })} title="Modifica" style={{ ...btnStyle, background: 'var(--accent-info-soft)', color: 'var(--accent-info)', padding: '8px 12px' }}>âœï¸</button>
                              <button onClick={() => deleteCategory(cat.id)} disabled={count > 0 || subCount > 0} title="Elimina" style={{ ...btnStyle, background: (count > 0 || subCount > 0) ? 'var(--bg-tertiary)' : 'var(--accent-danger-soft)', color: (count > 0 || subCount > 0) ? 'var(--text-muted)' : 'var(--accent-danger)', padding: '8px 12px', cursor: (count > 0 || subCount > 0) ? 'not-allowed' : 'pointer' }}>ðŸ—‘ï¸</button>
                            </>}
                          </div>
                        );
                      })}
                    </div>
                  </>}

                  {/* Subcategories Tab */}
                  {masterDataTab === 'subcategories' && <>
                    <div style={{ display: 'flex', gap: 10, marginBottom: 20, flexWrap: 'wrap' }}>
                      <select value={newSubcategoryCatId} onChange={(e) => setNewSubcategoryCatId(e.target.value)} style={{ ...inputStyle, width: 200 }}><option value="">Seleziona categoria...</option>{categories.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}</select>
                      <input value={newSubcategoryName} onChange={(e) => setNewSubcategoryName(e.target.value)} style={{ ...inputStyle, flex: 1 }} placeholder="Nome sottocategoria..." />
                      <button onClick={() => addSubcategory(newSubcategoryName, newSubcategoryCatId)} disabled={!newSubcategoryName.trim() || !newSubcategoryCatId} style={{ ...btnStyle, background: (newSubcategoryName.trim() && newSubcategoryCatId) ? 'var(--accent-primary)' : 'var(--bg-tertiary)', color: (newSubcategoryName.trim() && newSubcategoryCatId) ? '#1a1814' : 'var(--text-muted)' }}>+ Aggiungi</button>
                    </div>
                    <div style={{ display: 'flex', flexDirection: 'column', gap: 8 }}>
                      {subcategories.map(sub => {
                        const cat = categories.find(c => c.id === sub.categoryId);
                        const count = items.filter(i => i.subcategory === sub.name).length;
                        return (
                          <div key={sub.id} style={{ display: 'flex', alignItems: 'center', gap: 12, padding: 14, background: 'var(--bg-card)', borderRadius: 10, border: '1px solid var(--border-subtle)', flexWrap: 'wrap' }}>
                            {editingSubcategory?.id === sub.id ? <>
                              <select value={editingSubcategory.categoryId} onChange={(e) => setEditingSubcategory({ ...editingSubcategory, categoryId: e.target.value })} style={{ ...inputStyle, width: 180 }}>{categories.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}</select>
                              <input value={editingSubcategory.name} onChange={(e) => setEditingSubcategory({ ...editingSubcategory, name: e.target.value })} style={{ ...inputStyle, flex: 1 }} />
                              <button onClick={() => updateSubcategory(sub.id, editingSubcategory.name, editingSubcategory.categoryId)} style={{ ...btnStyle, background: 'var(--accent-success)', color: '#fff', padding: '8px 14px' }}>âœ“</button>
                              <button onClick={() => setEditingSubcategory(null)} style={{ ...btnStyle, background: 'var(--bg-tertiary)', color: 'var(--text-secondary)', padding: '8px 14px' }}>âœ•</button>
                            </> : <>
                              <span style={{ fontSize: 16 }}>ðŸ“‚</span>
                              <div style={{ width: 14, height: 14, borderRadius: 4, background: cat?.color || '#8a7e6d' }} />
                              <span style={{ fontSize: 12, padding: '4px 10px', background: 'var(--bg-tertiary)', borderRadius: 6, color: 'var(--text-secondary)' }}>{cat?.name || '-'}</span>
                              <span style={{ flex: 1, fontWeight: 500 }}>{sub.name}</span>
                              <span style={{ fontSize: 11, color: 'var(--text-muted)', padding: '6px 12px', background: 'var(--bg-tertiary)', borderRadius: 6 }}>{count} oggetti</span>
                              <button onClick={() => setEditingSubcategory({ ...sub })} title="Modifica" style={{ ...btnStyle, background: 'var(--accent-info-soft)', color: 'var(--accent-info)', padding: '8px 12px' }}>âœï¸</button>
                              <button onClick={() => deleteSubcategory(sub.id)} disabled={count > 0} title="Elimina" style={{ ...btnStyle, background: count > 0 ? 'var(--bg-tertiary)' : 'var(--accent-danger-soft)', color: count > 0 ? 'var(--text-muted)' : 'var(--accent-danger)', padding: '8px 12px', cursor: count > 0 ? 'not-allowed' : 'pointer' }}>ðŸ—‘ï¸</button>
                            </>}
                          </div>
                        );
                      })}
                    </div>
                  </>}

                  {/* Locations Tab */}
                  {masterDataTab === 'locations' && <>
                    <div style={{ display: 'flex', gap: 10, marginBottom: 20, flexWrap: 'wrap' }}>
                      <input value={newLocationName} onChange={(e) => setNewLocationName(e.target.value)} style={{ ...inputStyle, flex: '1 1 150px' }} placeholder="Nome ubicazione..." />
                      <input value={newLocationDesc} onChange={(e) => setNewLocationDesc(e.target.value)} style={{ ...inputStyle, flex: '2 1 200px' }} placeholder="Descrizione (opzionale)" />
                      <button onClick={() => addLocation(newLocationName, newLocationDesc)} disabled={!newLocationName.trim()} style={{ ...btnStyle, background: newLocationName.trim() ? 'var(--accent-primary)' : 'var(--bg-tertiary)', color: newLocationName.trim() ? '#1a1814' : 'var(--text-muted)' }}>+ Aggiungi</button>
                    </div>
                    <div style={{ display: 'flex', flexDirection: 'column', gap: 8 }}>
                      {locations.map(loc => {
                        const count = items.filter(i => i.location === loc.name).length;
                        return (
                          <div key={loc.id} style={{ display: 'flex', alignItems: 'center', gap: 12, padding: 14, background: 'var(--bg-card)', borderRadius: 10, border: '1px solid var(--border-subtle)', flexWrap: 'wrap' }}>
                            {editingLocation?.id === loc.id ? <>
                              <input value={editingLocation.name} onChange={(e) => setEditingLocation({ ...editingLocation, name: e.target.value })} style={{ ...inputStyle, flex: '1 1 120px' }} />
                              <input value={editingLocation.description} onChange={(e) => setEditingLocation({ ...editingLocation, description: e.target.value })} style={{ ...inputStyle, flex: '2 1 200px' }} placeholder="Descrizione" />
                              <button onClick={() => updateLocation(loc.id, editingLocation.name, editingLocation.description)} style={{ ...btnStyle, background: 'var(--accent-success)', color: '#fff', padding: '8px 14px' }}>âœ“</button>
                              <button onClick={() => setEditingLocation(null)} style={{ ...btnStyle, background: 'var(--bg-tertiary)', color: 'var(--text-secondary)', padding: '8px 14px' }}>âœ•</button>
                            </> : <>
                              <span style={{ fontSize: 16 }}>ðŸ“</span>
                              <span style={{ fontWeight: 600, color: 'var(--accent-info)', minWidth: 100 }}>{loc.name}</span>
                              <span style={{ flex: 1, fontSize: 13, color: 'var(--text-secondary)' }}>{loc.description || '-'}</span>
                              <span style={{ fontSize: 11, color: 'var(--text-muted)', padding: '6px 12px', background: 'var(--bg-tertiary)', borderRadius: 6 }}>{count} oggetti</span>
                              <button onClick={() => setEditingLocation({ ...loc })} title="Modifica" style={{ ...btnStyle, background: 'var(--accent-info-soft)', color: 'var(--accent-info)', padding: '8px 12px' }}>âœï¸</button>
                              <button onClick={() => deleteLocation(loc.id)} disabled={count > 0} title="Elimina" style={{ ...btnStyle, background: count > 0 ? 'var(--bg-tertiary)' : 'var(--accent-danger-soft)', color: count > 0 ? 'var(--text-muted)' : 'var(--accent-danger)', padding: '8px 12px', cursor: count > 0 ? 'not-allowed' : 'pointer' }}>ðŸ—‘ï¸</button>
                            </>}
                          </div>
                        );
                      })}
                    </div>
                  </>}

                  {/* Statuses Tab */}
                  {masterDataTab === 'statuses' && <>
                    <div style={{ display: 'flex', gap: 10, marginBottom: 20, flexWrap: 'wrap', alignItems: 'flex-start' }}>
                      <EmojiPicker value={newStatusIcon} onChange={setNewStatusIcon} />
                      <input type="color" value={newStatusColor} onChange={(e) => setNewStatusColor(e.target.value)} style={{ width: 50, height: 42, border: 'none', borderRadius: 8, cursor: 'pointer' }} />
                      <input value={newStatusName} onChange={(e) => setNewStatusName(e.target.value)} style={{ ...inputStyle, flex: 1 }} placeholder="Nome nuovo stato..." />
                      <button onClick={() => addStatus(newStatusName, newStatusColor, newStatusIcon)} disabled={!newStatusName.trim()} style={{ ...btnStyle, background: newStatusName.trim() ? 'var(--accent-primary)' : 'var(--bg-tertiary)', color: newStatusName.trim() ? '#1a1814' : 'var(--text-muted)' }}>+ Aggiungi</button>
                    </div>
                    <div style={{ display: 'flex', flexDirection: 'column', gap: 8 }}>
                      {statuses.map(status => {
                        const count = items.filter(i => i.status === status.name).length;
                        return (
                          <div key={status.id} style={{ display: 'flex', alignItems: 'center', gap: 12, padding: 14, background: 'var(--bg-card)', borderRadius: 10, border: '1px solid var(--border-subtle)', flexWrap: 'wrap' }}>
                            {editingStatus?.id === status.id ? <>
                              <EmojiPicker value={editingStatus.icon} onChange={(v) => setEditingStatus({ ...editingStatus, icon: v })} />
                              <input type="color" value={editingStatus.color} onChange={(e) => setEditingStatus({ ...editingStatus, color: e.target.value })} style={{ width: 40, height: 36, border: 'none', borderRadius: 6, cursor: 'pointer' }} />
                              <input value={editingStatus.name} onChange={(e) => setEditingStatus({ ...editingStatus, name: e.target.value })} style={{ ...inputStyle, flex: 1 }} />
                              <button onClick={() => updateStatus(status.id, editingStatus.name, editingStatus.color, editingStatus.icon)} style={{ ...btnStyle, background: 'var(--accent-success)', color: '#fff', padding: '8px 14px' }}>âœ“</button>
                              <button onClick={() => setEditingStatus(null)} style={{ ...btnStyle, background: 'var(--bg-tertiary)', color: 'var(--text-secondary)', padding: '8px 14px' }}>âœ•</button>
                            </> : <>
                              <span style={{ fontSize: 18, width: 30, textAlign: 'center' }}>{status.icon}</span>
                              <div style={{ width: 20, height: 20, borderRadius: 6, background: status.color }} />
                              <span style={{ flex: 1, fontWeight: 500 }}>{status.name}</span>
                              <span style={{ fontSize: 11, color: 'var(--text-muted)', padding: '6px 12px', background: 'var(--bg-tertiary)', borderRadius: 6 }}>{count} oggetti</span>
                              <button onClick={() => setEditingStatus({ ...status })} title="Modifica" style={{ ...btnStyle, background: 'var(--accent-info-soft)', color: 'var(--accent-info)', padding: '8px 12px' }}>âœï¸</button>
                              <button onClick={() => deleteStatus(status.id)} disabled={count > 0} title="Elimina" style={{ ...btnStyle, background: count > 0 ? 'var(--bg-tertiary)' : 'var(--accent-danger-soft)', color: count > 0 ? 'var(--text-muted)' : 'var(--accent-danger)', padding: '8px 12px', cursor: count > 0 ? 'not-allowed' : 'pointer' }}>ðŸ—‘ï¸</button>
                            </>}
                          </div>
                        );
                      })}
                    </div>
                  </>}

                  {/* Accessory Types Tab */}
                  {masterDataTab === 'accessoryTypes' && <>
                    <div style={{ display: 'flex', gap: 10, marginBottom: 20, alignItems: 'flex-start' }}>
                      <EmojiPicker value={newAccessoryTypeIcon} onChange={setNewAccessoryTypeIcon} />
                      <input value={newAccessoryTypeName} onChange={(e) => setNewAccessoryTypeName(e.target.value)} style={{ ...inputStyle, flex: 1 }} placeholder="Nome tipo accessorio..." />
                      <button onClick={() => addAccessoryType(newAccessoryTypeName, newAccessoryTypeIcon)} disabled={!newAccessoryTypeName.trim()} style={{ ...btnStyle, background: newAccessoryTypeName.trim() ? 'var(--accent-primary)' : 'var(--bg-tertiary)', color: newAccessoryTypeName.trim() ? '#1a1814' : 'var(--text-muted)' }}>+ Aggiungi</button>
                    </div>
                    <div style={{ display: 'flex', flexDirection: 'column', gap: 8 }}>
                      {accessoryTypes.map(type => {
                        const count = items.reduce((c, item) => c + (item.accessories?.filter(a => a.typeId === type.id).length || 0), 0);
                        return (
                          <div key={type.id} style={{ display: 'flex', alignItems: 'center', gap: 12, padding: 14, background: 'var(--bg-card)', borderRadius: 10, border: '1px solid var(--border-subtle)' }}>
                            {editingAccessoryType?.id === type.id ? <>
                              <EmojiPicker value={editingAccessoryType.icon} onChange={(v) => setEditingAccessoryType({ ...editingAccessoryType, icon: v })} />
                              <input value={editingAccessoryType.name} onChange={(e) => setEditingAccessoryType({ ...editingAccessoryType, name: e.target.value })} style={{ ...inputStyle, flex: 1 }} />
                              <button onClick={() => updateAccessoryType(type.id, editingAccessoryType.name, editingAccessoryType.icon)} style={{ ...btnStyle, background: 'var(--accent-success)', color: '#fff', padding: '8px 14px' }}>âœ“</button>
                              <button onClick={() => setEditingAccessoryType(null)} style={{ ...btnStyle, background: 'var(--bg-tertiary)', color: 'var(--text-secondary)', padding: '8px 14px' }}>âœ•</button>
                            </> : <>
                              <span style={{ fontSize: 18, width: 30, textAlign: 'center' }}>{type.icon}</span>
                              <span style={{ flex: 1, fontWeight: 500 }}>{type.name}</span>
                              <span style={{ fontSize: 11, color: 'var(--text-muted)', padding: '6px 12px', background: 'var(--bg-tertiary)', borderRadius: 6 }}>{count} accessori</span>
                              <button onClick={() => setEditingAccessoryType({ ...type })} title="Modifica" style={{ ...btnStyle, background: 'var(--accent-info-soft)', color: 'var(--accent-info)', padding: '8px 12px' }}>âœï¸</button>
                              <button onClick={() => deleteAccessoryType(type.id)} disabled={count > 0} title="Elimina" style={{ ...btnStyle, background: count > 0 ? 'var(--bg-tertiary)' : 'var(--accent-danger-soft)', color: count > 0 ? 'var(--text-muted)' : 'var(--accent-danger)', padding: '8px 12px', cursor: count > 0 ? 'not-allowed' : 'pointer' }}>ðŸ—‘ï¸</button>
                            </>}
                          </div>
                        );
                      })}
                    </div>
                  </>}

                  {/* Maintenance Types Tab */}
                  {masterDataTab === 'maintenanceTypes' && <>
                    <div style={{ display: 'flex', gap: 10, marginBottom: 20, flexWrap: 'wrap', alignItems: 'flex-start' }}>
                      <select value={newMaintenanceCategoryId} onChange={(e) => setNewMaintenanceCategoryId(e.target.value)} style={{ ...inputStyle, width: 140 }}>
                        <option value="">Categoria...</option>
                        {categories.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                      </select>
                      <input value={newMaintenanceName} onChange={(e) => setNewMaintenanceName(e.target.value)} style={{ ...inputStyle, flex: 1, minWidth: 150 }} placeholder="Nome tipo manutenzione..." />
                      <div style={{ display: 'flex', alignItems: 'center', gap: 4 }}>
                        <input type="number" value={newMaintenanceFrequency} onChange={(e) => setNewMaintenanceFrequency(e.target.value)} style={{ ...inputStyle, width: 70, textAlign: 'center' }} min="1" />
                        <span style={{ fontSize: 11, color: 'var(--text-muted)' }}>gg</span>
                      </div>
                      <button onClick={() => addMaintenanceType(newMaintenanceName, newMaintenanceCategoryId, newMaintenanceFrequency)} disabled={!newMaintenanceName.trim() || !newMaintenanceCategoryId} style={{ ...btnStyle, background: (newMaintenanceName.trim() && newMaintenanceCategoryId) ? 'var(--accent-primary)' : 'var(--bg-tertiary)', color: (newMaintenanceName.trim() && newMaintenanceCategoryId) ? '#1a1814' : 'var(--text-muted)' }}>+ Aggiungi</button>
                    </div>
                    <div style={{ fontSize: 11, color: 'var(--text-muted)', marginBottom: 12 }}>I tipi di manutenzione sono associati alle categorie. Solo i tipi della categoria dell'oggetto saranno disponibili.</div>
                    <div style={{ display: 'flex', flexDirection: 'column', gap: 8 }}>
                      {maintenanceTypes.map(type => {
                        const catName = categories.find(c => c.id === type.categoryId)?.name || '-';
                        const count = items.reduce((c, item) => c + (item.scheduledChecks?.filter(s => s.maintenanceTypeId === type.id).length || 0), 0);
                        return (
                          <div key={type.id} style={{ display: 'flex', alignItems: 'center', gap: 10, padding: 12, background: 'var(--bg-card)', borderRadius: 10, border: '1px solid var(--border-subtle)', flexWrap: 'wrap' }}>
                            {editingMaintenanceType?.id === type.id ? <>
                              <select value={editingMaintenanceType.categoryId} onChange={(e) => setEditingMaintenanceType({ ...editingMaintenanceType, categoryId: e.target.value })} style={{ ...inputStyle, width: 120 }}>
                                {categories.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                              </select>
                              <input value={editingMaintenanceType.name} onChange={(e) => setEditingMaintenanceType({ ...editingMaintenanceType, name: e.target.value })} style={{ ...inputStyle, flex: 1, minWidth: 120 }} />
                              <input type="number" value={editingMaintenanceType.defaultFrequencyDays} onChange={(e) => setEditingMaintenanceType({ ...editingMaintenanceType, defaultFrequencyDays: e.target.value })} style={{ ...inputStyle, width: 60, textAlign: 'center' }} min="1" />
                              <button onClick={() => updateMaintenanceType(type.id, editingMaintenanceType.name, editingMaintenanceType.categoryId, editingMaintenanceType.defaultFrequencyDays)} style={{ ...btnStyle, background: 'var(--accent-success)', color: '#fff', padding: '8px 12px' }}>âœ“</button>
                              <button onClick={() => setEditingMaintenanceType(null)} style={{ ...btnStyle, background: 'var(--bg-tertiary)', color: 'var(--text-secondary)', padding: '8px 12px' }}>âœ•</button>
                            </> : <>
                              <span style={{ fontSize: 16 }}>ðŸ”§</span>
                              <span style={{ fontSize: 11, padding: '4px 8px', background: 'var(--accent-primary-soft)', borderRadius: 4, color: 'var(--accent-primary)' }}>{catName}</span>
                              <span style={{ flex: 1, fontWeight: 500, minWidth: 100 }}>{type.name}</span>
                              <span style={{ fontSize: 11, color: 'var(--text-muted)' }}>ogni {type.defaultFrequencyDays} gg</span>
                              <span style={{ fontSize: 11, color: 'var(--text-muted)', padding: '4px 8px', background: 'var(--bg-tertiary)', borderRadius: 4 }}>{count} in uso</span>
                              <button onClick={() => setEditingMaintenanceType({ ...type })} title="Modifica" style={{ ...btnStyle, background: 'var(--accent-info-soft)', color: 'var(--accent-info)', padding: '6px 10px' }}>âœï¸</button>
                              <button onClick={() => deleteMaintenanceType(type.id)} disabled={count > 0} title="Elimina" style={{ ...btnStyle, background: count > 0 ? 'var(--bg-tertiary)' : 'var(--accent-danger-soft)', color: count > 0 ? 'var(--text-muted)' : 'var(--accent-danger)', padding: '6px 10px', cursor: count > 0 ? 'not-allowed' : 'pointer' }}>ðŸ—‘ï¸</button>
                            </>}
                          </div>
                        );
                      })}
                    </div>
                  </>}
                </div>
              </div>
            </div>
          )}

          {/* Lightbox */}
          {lightboxOpen && lightboxImages.length > 0 && (
            <div style={{ position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.95)', zIndex: 200, display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', padding: 20 }} onClick={() => setLightboxOpen(false)}>
              <button onClick={() => setLightboxOpen(false)} style={{ position: 'absolute', top: 20, right: 20, width: 44, height: 44, borderRadius: 10, background: 'var(--bg-tertiary)', border: 'none', color: 'var(--text-secondary)', cursor: 'pointer', fontSize: 20 }}>Ã—</button>
              <div style={{ position: 'relative', maxWidth: '90vw', maxHeight: '75vh', display: 'flex', alignItems: 'center', justifyContent: 'center' }} onClick={(e) => e.stopPropagation()}>
                {lightboxImages.length > 1 && <button onClick={() => setLightboxIndex(i => (i - 1 + lightboxImages.length) % lightboxImages.length)} style={{ position: 'absolute', left: isMobile ? 10 : -60, width: 44, height: 44, borderRadius: '50%', background: 'var(--bg-tertiary)', border: 'none', color: 'var(--text-secondary)', cursor: 'pointer', fontSize: 18, zIndex: 1 }}>â—€</button>}
                <img src={lightboxImages[lightboxIndex]} style={{ maxWidth: '90vw', maxHeight: '75vh', borderRadius: 12, boxShadow: '0 10px 50px rgba(0,0,0,0.5)' }} />
                {lightboxImages.length > 1 && <button onClick={() => setLightboxIndex(i => (i + 1) % lightboxImages.length)} style={{ position: 'absolute', right: isMobile ? 10 : -60, width: 44, height: 44, borderRadius: '50%', background: 'var(--bg-tertiary)', border: 'none', color: 'var(--text-secondary)', cursor: 'pointer', fontSize: 18, zIndex: 1 }}>â–¶</button>}
              </div>
              {lightboxImages.length > 1 && <div style={{ marginTop: 20, display: 'flex', gap: 8, flexWrap: 'wrap', justifyContent: 'center' }} onClick={(e) => e.stopPropagation()}>{lightboxImages.map((img, i) => <div key={i} onClick={() => setLightboxIndex(i)} style={{ width: 56, height: 56, borderRadius: 8, background: `url(${img}) center/cover`, cursor: 'pointer', border: i === lightboxIndex ? '3px solid var(--accent-primary)' : '3px solid transparent', opacity: i === lightboxIndex ? 1 : 0.5 }} />)}</div>}
              <div style={{ marginTop: 16, fontSize: 13, color: 'var(--text-muted)' }}>{lightboxIndex + 1} / {lightboxImages.length}</div>
            </div>
          )}

          {/* Detail Popup - Wide Two-Column Layout */}
          {selectedItem && !isEditing && (
            <div style={{ position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.85)', backdropFilter: 'blur(10px)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 100, padding: 16 }} onClick={() => setSelectedItem(null)}>
              <div style={{ width: '100%', maxWidth: 1100, maxHeight: '92vh', display: 'flex', flexDirection: 'column', background: 'var(--bg-secondary)', borderRadius: 16, border: '1px solid var(--border-medium)', boxShadow: '0 30px 100px rgba(0,0,0,0.6)' }} onClick={(e) => e.stopPropagation()}>
                {/* Header */}
                <div style={{ padding: '16px 24px', borderBottom: '1px solid var(--border-subtle)', background: 'var(--bg-card)', display: 'flex', alignItems: 'center', justifyContent: 'space-between', gap: 16, flexShrink: 0 }}>
                  <div style={{ display: 'flex', alignItems: 'center', gap: 12, flexWrap: 'wrap', flex: 1 }}>
                    <span style={{ fontSize: 15, padding: '6px 14px', background: 'var(--accent-primary)', borderRadius: 8, color: '#fff', fontWeight: 700 }}>{getBrandName(selectedItem.brandId)}</span>
                    <span style={{ fontSize: 14, padding: '6px 12px', background: 'var(--bg-tertiary)', borderRadius: 8, color: 'var(--text-primary)', fontWeight: 600 }}>{getModelName(selectedItem.modelId)}</span>
                    {selectedItem.version && <span style={{ fontSize: 14, color: 'var(--accent-secondary)', fontWeight: 600 }}>{selectedItem.version}</span>}
                    <span style={{ fontSize: 12, padding: '5px 10px', background: `${getCategoryColor(selectedItem.category)}25`, borderRadius: 6, color: getCategoryColor(selectedItem.category) }}>{selectedItem.category}</span>
                    {selectedItem.status && (() => { const s = getStatusInfo(selectedItem.status); return <span style={{ fontSize: 12, padding: '5px 10px', background: `${s.color}20`, borderRadius: 6, color: s.color }}>{s.icon} {selectedItem.status}</span>; })()}
                    {selectedItem.aestheticGrade && <span style={{ fontSize: 12, padding: '5px 10px', background: 'var(--accent-info-soft)', borderRadius: 6, color: 'var(--accent-info)' }}>â­ {selectedItem.aestheticGrade}</span>}
                  </div>
                  <button onClick={() => setSelectedItem(null)} style={{ width: 36, height: 36, borderRadius: 8, background: 'var(--bg-tertiary)', border: 'none', color: 'var(--text-muted)', cursor: 'pointer', fontSize: 18, flexShrink: 0 }}>Ã—</button>
                </div>
                
                {/* Two-Column Content */}
                <div style={{ display: 'grid', gridTemplateColumns: isMobile ? '1fr' : '340px 1fr', gap: 0, flex: 1, overflow: 'hidden' }}>
                  {/* Left Column - Image & Economic Summary */}
                  <div style={{ padding: 20, borderRight: isMobile ? 'none' : '1px solid var(--border-subtle)', background: 'var(--bg-tertiary)', overflowY: 'auto' }}>
                    {selectedItem.images?.length > 0 ? (
                      <div>
                        <div style={{ width: '100%', aspectRatio: '4/3', borderRadius: 12, background: `url(${selectedItem.images[activeImageIndex]}) center/contain no-repeat`, backgroundColor: 'var(--bg-card)', cursor: 'zoom-in', border: '1px solid var(--border-subtle)' }} onClick={() => openLightbox(selectedItem.images, activeImageIndex)} />
                        {/* Collapsible Gallery */}
                        {selectedItem.images.length > 1 && (
                          <details style={{ marginTop: 10 }}>
                            <summary style={{ cursor: 'pointer', padding: '8px 12px', background: 'var(--bg-card)', borderRadius: 8, fontSize: 12, color: 'var(--text-secondary)', display: 'flex', alignItems: 'center', gap: 8, listStyle: 'none' }}>
                              <span style={{ transform: 'rotate(0deg)', transition: 'transform 0.2s' }}>â–¶</span>
                              ðŸ“· Galleria ({selectedItem.images.length} foto) - Foto {activeImageIndex + 1}
                            </summary>
                            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(50px, 1fr))', gap: 6, marginTop: 8, padding: 8, background: 'var(--bg-card)', borderRadius: 8 }}>
                              {selectedItem.images.map((img, i) => (
                                <div key={i} onClick={() => setActiveImageIndex(i)} style={{ aspectRatio: '1', borderRadius: 6, background: `url(${img}) center/cover`, cursor: 'pointer', border: i === activeImageIndex ? '3px solid var(--accent-primary)' : '2px solid transparent', opacity: i === activeImageIndex ? 1 : 0.7 }} />
                              ))}
                            </div>
                          </details>
                        )}
                      </div>
                    ) : (
                      <div style={{ width: '100%', aspectRatio: '4/3', borderRadius: 12, background: 'var(--bg-card)', display: 'flex', alignItems: 'center', justifyContent: 'center', color: 'var(--text-muted)', fontSize: 13, border: '1px solid var(--border-subtle)' }}>Nessuna immagine</div>
                    )}
                    
                    {/* Economic Summary in left column */}
                    <div style={{ marginTop: 16 }}><EconomicSummary item={selectedItem} /></div>
                  </div>
                  
                  {/* Right Column - All Details */}
                  <div style={{ padding: 20, display: 'flex', flexDirection: 'column', gap: 14, overflowY: 'auto' }}>
                    
                    {/* Quick Info Cards - Top of right column */}
                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: 10 }}>
                      <div style={{ padding: 12, background: 'var(--bg-card)', borderRadius: 10 }}>
                        <div style={{ fontSize: 10, color: 'var(--text-muted)', marginBottom: 4, display: 'flex', alignItems: 'center', gap: 5 }}>ðŸ“… Anno prod.</div>
                        <div style={{ fontSize: 15, fontWeight: 700 }}>{selectedItem.year || '-'}</div>
                      </div>
                      <div style={{ padding: 12, background: 'var(--bg-card)', borderRadius: 10 }}>
                        <div style={{ fontSize: 10, color: 'var(--text-muted)', marginBottom: 4, display: 'flex', alignItems: 'center', gap: 5 }}>ðŸ”¢ N. Serie</div>
                        <div style={{ fontSize: 13, fontWeight: 600, wordBreak: 'break-all' }}>{selectedItem.serialNumber || '-'}</div>
                      </div>
                      <div style={{ padding: 12, background: 'var(--bg-card)', borderRadius: 10 }}>
                        <div style={{ fontSize: 10, color: 'var(--text-muted)', marginBottom: 4, display: 'flex', alignItems: 'center', gap: 5 }}>ðŸ“ Ubicazione</div>
                        <div style={{ fontSize: 13, fontWeight: 600 }}>{selectedItem.location || '-'}</div>
                      </div>
                      <div style={{ padding: 12, background: 'var(--bg-card)', borderRadius: 10 }}>
                        <div style={{ fontSize: 10, color: 'var(--text-muted)', marginBottom: 4, display: 'flex', alignItems: 'center', gap: 5 }}>ðŸ›’ Acquisto</div>
                        <div style={{ fontSize: 13, fontWeight: 600 }}>{selectedItem.purchaseYear || '-'}</div>
                      </div>
                    </div>
                    
                    {/* Description */}
                    {selectedItem.description && (
                      <div><div style={{ fontSize: 11, color: 'var(--text-muted)', marginBottom: 6, fontWeight: 600, textTransform: 'uppercase', letterSpacing: 0.5 }}>Descrizione</div><div style={{ fontSize: 14, lineHeight: 1.7, color: 'var(--text-secondary)' }}>{selectedItem.description}</div></div>
                    )}
                    
                    {/* Defects */}
                    {selectedItem.defectFound && (
                      <div style={{ padding: 14, background: 'var(--accent-danger-soft)', borderRadius: 10, border: '1px solid var(--accent-danger)' }}>
                        <div style={{ fontSize: 11, color: 'var(--accent-danger)', marginBottom: 6, fontWeight: 700, textTransform: 'uppercase' }}>âš ï¸ Difetti riscontrati</div>
                        <div style={{ fontSize: 13, color: 'var(--text-secondary)', lineHeight: 1.6 }}>{selectedItem.defectFound}</div>
                      </div>
                    )}
                    
                    {/* Notes */}
                    {selectedItem.notes && (
                      <div style={{ padding: 14, background: 'var(--accent-warning-soft)', borderRadius: 10 }}>
                        <div style={{ fontSize: 11, color: 'var(--accent-warning)', marginBottom: 6, fontWeight: 700, textTransform: 'uppercase' }}>ðŸ“ Note</div>
                        <div style={{ fontSize: 13, color: 'var(--text-secondary)', lineHeight: 1.6 }}>{selectedItem.notes}</div>
                      </div>
                    )}
                    
                    {/* Works + Accessories side by side */}
                    {(selectedItem.works?.length > 0 || selectedItem.accessories?.length > 0) && (
                      <div style={{ display: 'grid', gridTemplateColumns: selectedItem.works?.length > 0 && selectedItem.accessories?.length > 0 ? '1fr 1fr' : '1fr', gap: 14 }}>
                        {/* Works Summary */}
                        {selectedItem.works?.length > 0 && (
                          <div style={{ padding: 14, background: 'var(--accent-work-soft)', borderRadius: 10 }}>
                            <div style={{ fontSize: 11, color: 'var(--accent-work)', marginBottom: 8, fontWeight: 700, textTransform: 'uppercase', display: 'flex', justifyContent: 'space-between' }}>
                              <span>ðŸ”§ Riparazioni ({selectedItem.works.length})</span>
                              <span>â‚¬{selectedItem.works.reduce((s, w) => s + (w.cost || 0), 0).toFixed(2)}</span>
                            </div>
                            <div style={{ display: 'flex', flexDirection: 'column', gap: 4 }}>
                              {selectedItem.works.slice(0, 4).map(w => (
                                <div key={w.id} style={{ fontSize: 12, color: 'var(--text-secondary)', display: 'flex', justifyContent: 'space-between', gap: 8 }}>
                                  <span style={{ flex: 1, overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>{formatDate(w.date)} - {w.description}</span>
                                  <span style={{ fontWeight: 600, flexShrink: 0 }}>â‚¬{(w.cost || 0).toFixed(2)}</span>
                                </div>
                              ))}
                              {selectedItem.works.length > 4 && <div style={{ fontSize: 11, color: 'var(--text-muted)', fontStyle: 'italic' }}>... e altre {selectedItem.works.length - 4}</div>}
                            </div>
                          </div>
                        )}
                        
                        {/* Accessories Summary */}
                        {selectedItem.accessories?.length > 0 && (
                          <div style={{ padding: 14, background: 'var(--accent-accessory-soft)', borderRadius: 10 }}>
                            <div style={{ fontSize: 11, color: 'var(--accent-accessory)', marginBottom: 8, fontWeight: 700, textTransform: 'uppercase', display: 'flex', justifyContent: 'space-between' }}>
                              <span>ðŸ“¦ Accessori ({selectedItem.accessories.length})</span>
                              <span>â‚¬{selectedItem.accessories.reduce((s, a) => s + (a.cost || 0), 0).toFixed(2)}</span>
                            </div>
                            <div style={{ display: 'flex', flexWrap: 'wrap', gap: 6 }}>
                              {selectedItem.accessories.map(a => (
                                <span key={a.id} style={{ fontSize: 11, padding: '4px 10px', background: 'var(--bg-secondary)', borderRadius: 6, color: 'var(--text-secondary)' }}>{a.name}</span>
                              ))}
                            </div>
                          </div>
                        )}
                      </div>
                    )}
                    
                    {/* Scheduled Checks */}
                    {selectedItem.scheduledChecks?.filter(c => !c.isCompleted).length > 0 && (() => {
                      const activeChecks = selectedItem.scheduledChecks.filter(c => !c.isCompleted);
                      const maintStatus = getMaintenanceStatus(selectedItem);
                      const getTypeName = (id) => maintenanceTypes.find(t => t.id === id)?.name || '-';
                      return (
                        <div style={{ padding: 14, background: maintStatus.status === 'overdue' ? 'var(--accent-danger-soft)' : maintStatus.status === 'soon' ? 'var(--accent-warning-soft)' : 'var(--bg-card)', borderRadius: 10, border: `1px solid ${maintStatus.status === 'overdue' ? 'var(--accent-danger)' : maintStatus.status === 'soon' ? 'var(--accent-warning)' : 'var(--border-subtle)'}` }}>
                          <div style={{ fontSize: 11, color: maintStatus.status === 'overdue' ? 'var(--accent-danger)' : maintStatus.status === 'soon' ? 'var(--accent-warning)' : 'var(--text-muted)', marginBottom: 10, fontWeight: 700, textTransform: 'uppercase', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                            <span>ðŸ”” Controlli Attivi ({activeChecks.length})</span>
                            {maintStatus.overdue > 0 && <span style={{ padding: '3px 8px', background: 'var(--accent-danger)', color: '#fff', borderRadius: 4, fontSize: 10 }}>{maintStatus.overdue} scaduti</span>}
                          </div>
                          <div style={{ display: 'flex', flexDirection: 'column', gap: 8 }}>
                            {activeChecks.slice(0, 4).map(check => {
                              const today = new Date(); today.setHours(0, 0, 0, 0);
                              const nextDate = check.nextCheckDate ? new Date(check.nextCheckDate) : null;
                              if (nextDate) nextDate.setHours(0, 0, 0, 0);
                              const daysUntil = nextDate ? Math.ceil((nextDate - today) / (1000 * 60 * 60 * 24)) : null;
                              const isOverdue = daysUntil !== null && daysUntil < 0;
                              const isSoon = daysUntil !== null && daysUntil >= 0 && daysUntil <= (check.warningDays || 30);
                              return (
                                <div key={check.id} style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', gap: 10, padding: 10, background: 'var(--bg-secondary)', borderRadius: 8 }}>
                                  <span style={{ fontSize: 13, fontWeight: 500 }}>{getTypeName(check.maintenanceTypeId)}</span>
                                  <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
                                    <span style={{ fontSize: 11, padding: '3px 8px', borderRadius: 4, fontWeight: 600, background: isOverdue ? 'var(--accent-danger)' : isSoon ? 'var(--accent-warning)' : 'var(--accent-success-soft)', color: isOverdue ? '#fff' : isSoon ? '#1a1814' : 'var(--accent-success)' }}>
                                      {isOverdue ? `${Math.abs(daysUntil)}gg fa` : daysUntil === 0 ? 'Oggi' : `${daysUntil}gg`}
                                    </span>
                                    {(isOverdue || isSoon) && <button onClick={() => setCheckConfirmPopup({ item: selectedItem, check })} style={{ ...btnStyle, padding: '4px 10px', fontSize: 11, background: 'var(--accent-success)', color: '#fff' }}>âœ“</button>}
                                  </div>
                                </div>
                              );
                            })}
                          </div>
                        </div>
                      );
                    })()}
                    
                    {/* Maintenance History */}
                    {(() => {
                      const allHistory = [];
                      const getTypeName = (id) => maintenanceTypes.find(t => t.id === id)?.name || '-';
                      selectedItem.scheduledChecks?.forEach(check => {
                        check.history?.forEach((h, idx) => {
                          allHistory.push({ ...h, checkName: getTypeName(check.maintenanceTypeId), checkId: check.id, idx, isRecursive: check.isRecursive !== false });
                        });
                      });
                      allHistory.sort((a, b) => new Date(b.date) - new Date(a.date));
                      if (allHistory.length === 0) return null;
                      const totalHistoryCost = allHistory.reduce((s, h) => s + (h.cost || 0), 0);
                      return (
                        <div style={{ padding: 14, background: 'var(--accent-success-soft)', borderRadius: 10 }}>
                          <div style={{ fontSize: 11, color: 'var(--accent-success)', marginBottom: 10, fontWeight: 700, textTransform: 'uppercase', display: 'flex', justifyContent: 'space-between' }}>
                            <span>ðŸ“‹ Storico Manutenzioni ({allHistory.length})</span>
                            <span>â‚¬{totalHistoryCost.toFixed(2)}</span>
                          </div>
                          <div style={{ maxHeight: 150, overflowY: 'auto' }}>
                            <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: 12 }}>
                              <tbody>
                                {allHistory.slice(0, 5).map((h, i) => (
                                  <tr key={`${h.checkId}-${h.idx}`} style={{ borderBottom: '1px solid var(--border-subtle)' }}>
                                    <td style={{ padding: '6px 4px', fontWeight: 500, width: 80 }}>{new Date(h.date).toLocaleDateString('it-IT')}</td>
                                    <td style={{ padding: '6px 4px' }}>{h.checkName} {!h.isRecursive && <span style={{ fontSize: 9, padding: '1px 4px', background: 'var(--accent-info-soft)', color: 'var(--accent-info)', borderRadius: 3 }}>1x</span>}</td>
                                    <td style={{ padding: '6px 4px', textAlign: 'right', fontWeight: 600 }}>â‚¬{(h.cost || 0).toFixed(2)}</td>
                                  </tr>
                                ))}
                              </tbody>
                            </table>
                            {allHistory.length > 5 && <div style={{ fontSize: 11, color: 'var(--text-muted)', fontStyle: 'italic', marginTop: 6 }}>... e altri {allHistory.length - 5} interventi</div>}
                          </div>
                        </div>
                      );
                    })()}
                  </div>
                </div>
                
                {/* Footer with Action Buttons - Full Width */}
                <div style={{ padding: '16px 24px', borderTop: '1px solid var(--border-subtle)', background: 'var(--bg-card)', flexShrink: 0 }}>
                  <div style={{ display: 'flex', gap: 10, flexWrap: 'wrap' }}>
                    <button onClick={() => handleEdit(selectedItem)} style={{ ...btnStyle, flex: '1 1 auto', justifyContent: 'center', background: 'var(--accent-info)', color: '#fff', padding: '12px 16px' }}>âœï¸ Modifica</button>
                    <button onClick={() => setWorksPopup(selectedItem)} style={{ ...btnStyle, flex: '1 1 auto', justifyContent: 'center', background: 'var(--accent-work)', color: '#fff', padding: '12px 16px' }}>ðŸ”§ Riparazioni</button>
                    <button onClick={() => setAccessoriesPopup(selectedItem)} style={{ ...btnStyle, flex: '1 1 auto', justifyContent: 'center', background: 'var(--accent-accessory)', color: '#fff', padding: '12px 16px' }}>ðŸ“¦ Accessori</button>
                    <button onClick={() => setScheduledChecksPopup(selectedItem)} style={{ ...btnStyle, flex: '1 1 auto', justifyContent: 'center', background: getMaintenanceStatus(selectedItem).status === 'overdue' ? 'var(--accent-danger)' : getMaintenanceStatus(selectedItem).status === 'soon' ? 'var(--accent-warning)' : 'var(--bg-tertiary)', color: getMaintenanceStatus(selectedItem).status === 'overdue' ? '#fff' : getMaintenanceStatus(selectedItem).status === 'soon' ? '#1a1814' : 'var(--text-secondary)', padding: '12px 16px' }}>ðŸ”” Controlli</button>
                    <button onClick={() => generateItemPDF(selectedItem, brands, models, accessoryTypes, maintenanceTypes, showEconomics)} style={{ ...btnStyle, flex: '1 1 auto', justifyContent: 'center', background: 'var(--accent-danger-soft)', color: 'var(--accent-danger)', padding: '12px 16px' }}>ðŸ“„ PDF</button>
                    <button onClick={async () => { await exportSingleItemZip(selectedItem, brands, models, accessoryTypes, maintenanceTypes, getBrandName, getModelName); showNotification('ZIP creato'); }} style={{ ...btnStyle, flex: '1 1 auto', justifyContent: 'center', background: 'var(--accent-info-soft)', color: 'var(--accent-info)', padding: '12px 16px' }}>ðŸ“¦ ZIP</button>
                    <button onClick={() => duplicateItem(selectedItem)} style={{ ...btnStyle, justifyContent: 'center', background: 'var(--bg-tertiary)', color: 'var(--text-secondary)', padding: '12px 16px' }}>ðŸ“‹ Duplica</button>
                    <button onClick={() => { deleteItem(selectedItem.id); setSelectedItem(null); }} style={{ ...btnStyle, justifyContent: 'center', background: 'var(--accent-danger-soft)', color: 'var(--accent-danger)', padding: '12px 16px' }}>ðŸ—‘ï¸ Elimina</button>
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* Edit Modal */}
          {isEditing && (
            <div style={{ position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.8)', backdropFilter: 'blur(8px)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 100, padding: 20 }} onClick={handleCancel}>
              <div style={{ width: '100%', maxWidth: 900, maxHeight: '90vh', overflowY: 'auto', background: 'var(--bg-secondary)', borderRadius: 16, border: '1px solid var(--border-medium)', boxShadow: '0 25px 80px rgba(0,0,0,0.5)' }} onClick={(e) => e.stopPropagation()}>
                <div style={{ padding: '20px 24px', borderBottom: '1px solid var(--border-subtle)', display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>
                  <h2 style={{ margin: 0, fontSize: 18 }}>{items.find(i => i.id === editForm.id) ? 'âœï¸ Modifica oggetto' : 'âž• Nuovo oggetto'}</h2>
                  <button onClick={handleCancel} style={{ width: 36, height: 36, borderRadius: 8, background: 'var(--bg-tertiary)', border: 'none', color: 'var(--text-muted)', cursor: 'pointer', fontSize: 18 }}>Ã—</button>
                </div>
                <div style={{ padding: 24 }}>
                  {/* Brand & Model */}
                  <div style={{ display: 'grid', gridTemplateColumns: isMobile ? '1fr' : '1fr 1fr', gap: 14, marginBottom: 14 }}>
                    <div>
                      <label style={{ fontSize: 12, color: 'var(--text-muted)', display: 'block', marginBottom: 6 }}>ðŸ­ Marca <span style={{ color: 'var(--accent-danger)' }}>*</span></label>
                      {!showInlineAddBrand ? <div style={{ display: 'flex', gap: 8 }}>
                        <select value={editForm.brandId || ''} onChange={(e) => setEditForm({ ...editForm, brandId: e.target.value, modelId: '' })} style={{ ...inputStyle, flex: 1 }}><option value="">Seleziona marca...</option>{brands.map(b => <option key={b.id} value={b.id}>{b.name}</option>)}</select>
                        <button onClick={() => setShowInlineAddBrand(true)} style={{ ...btnStyle, padding: '10px', background: 'var(--accent-primary-soft)', color: 'var(--accent-primary)' }}>+</button>
                      </div> : <div style={{ display: 'flex', gap: 8 }}>
                        <input value={inlineBrandName} onChange={(e) => setInlineBrandName(e.target.value)} style={{ ...inputStyle, flex: 1 }} placeholder="Nome marca" autoFocus />
                        <button onClick={() => addBrand(inlineBrandName, true)} style={{ ...btnStyle, background: 'var(--accent-success)', color: '#fff' }}>âœ“</button>
                        <button onClick={() => { setShowInlineAddBrand(false); setInlineBrandName(''); }} style={{ ...btnStyle, background: 'var(--bg-tertiary)', color: 'var(--text-secondary)' }}>âœ•</button>
                      </div>}
                    </div>
                    <div>
                      <label style={{ fontSize: 12, color: 'var(--text-muted)', display: 'block', marginBottom: 6 }}>ðŸ“¦ Modello</label>
                      {!showInlineAddModel ? <div style={{ display: 'flex', gap: 8 }}>
                        <select value={editForm.modelId || ''} onChange={(e) => setEditForm({ ...editForm, modelId: e.target.value })} style={{ ...inputStyle, flex: 1 }} disabled={!editForm.brandId}><option value="">Seleziona modello...</option>{getModelsForBrand(editForm.brandId).map(m => <option key={m.id} value={m.id}>{m.name}</option>)}</select>
                        <button onClick={() => setShowInlineAddModel(true)} disabled={!editForm.brandId} style={{ ...btnStyle, padding: '10px', background: editForm.brandId ? 'var(--accent-primary-soft)' : 'var(--bg-tertiary)', color: editForm.brandId ? 'var(--accent-primary)' : 'var(--text-muted)', cursor: editForm.brandId ? 'pointer' : 'not-allowed' }}>+</button>
                      </div> : <div style={{ display: 'flex', gap: 8 }}>
                        <input value={inlineModelName} onChange={(e) => setInlineModelName(e.target.value)} style={{ ...inputStyle, flex: 1 }} placeholder="Nome modello" autoFocus />
                        <button onClick={() => addModel(inlineModelName, editForm.brandId, true)} style={{ ...btnStyle, background: 'var(--accent-success)', color: '#fff' }}>âœ“</button>
                        <button onClick={() => { setShowInlineAddModel(false); setInlineModelName(''); }} style={{ ...btnStyle, background: 'var(--bg-tertiary)', color: 'var(--text-secondary)' }}>âœ•</button>
                      </div>}
                    </div>
                  </div>

                  {/* Category & Subcategory */}
                  <div style={{ display: 'grid', gridTemplateColumns: isMobile ? '1fr' : '1fr 1fr', gap: 14, marginBottom: 14 }}>
                    <div>
                      <label style={{ fontSize: 12, color: 'var(--text-muted)', display: 'block', marginBottom: 6 }}>ðŸ·ï¸ Categoria <span style={{ color: 'var(--accent-danger)' }}>*</span></label>
                      {!showInlineAddCategory ? <div style={{ display: 'flex', gap: 8 }}>
                        <select value={editForm.category || ''} onChange={(e) => setEditForm({ ...editForm, category: e.target.value, subcategory: '' })} style={{ ...inputStyle, flex: 1 }}><option value="">Seleziona categoria...</option>{categories.map(c => <option key={c.id} value={c.name}>{c.name}</option>)}</select>
                        <button onClick={() => setShowInlineAddCategory(true)} style={{ ...btnStyle, padding: '10px', background: 'var(--accent-primary-soft)', color: 'var(--accent-primary)' }}>+</button>
                      </div> : <div style={{ display: 'flex', gap: 8 }}>
                        <input type="color" value={inlineCategoryColor} onChange={(e) => setInlineCategoryColor(e.target.value)} style={{ width: 42, height: 42, border: 'none', borderRadius: 8, cursor: 'pointer' }} />
                        <input value={inlineCategoryName} onChange={(e) => setInlineCategoryName(e.target.value)} style={{ ...inputStyle, flex: 1 }} placeholder="Nome categoria" autoFocus />
                        <button onClick={() => addCategory(inlineCategoryName, inlineCategoryColor, true)} style={{ ...btnStyle, background: 'var(--accent-success)', color: '#fff' }}>âœ“</button>
                        <button onClick={() => { setShowInlineAddCategory(false); setInlineCategoryName(''); }} style={{ ...btnStyle, background: 'var(--bg-tertiary)', color: 'var(--text-secondary)' }}>âœ•</button>
                      </div>}
                    </div>
                    <div>
                      <label style={{ fontSize: 12, color: 'var(--text-muted)', display: 'block', marginBottom: 6 }}>ðŸ“‚ Sottocategoria</label>
                      <select value={editForm.subcategory || ''} onChange={(e) => setEditForm({ ...editForm, subcategory: e.target.value })} style={inputStyle} disabled={!editForm.category}>
                        <option value="">Seleziona sottocategoria...</option>
                        {getSubcategoriesForCategory(editForm.category).map(s => <option key={s.id} value={s.name}>{s.name}</option>)}
                      </select>
                    </div>
                  </div>

                  {/* Status & Aesthetic Grade */}
                  <div style={{ display: 'grid', gridTemplateColumns: isMobile ? '1fr' : '1fr 1fr', gap: 14, marginBottom: 14 }}>
                    <div>
                      <label style={{ fontSize: 12, color: 'var(--text-muted)', display: 'block', marginBottom: 6 }}>ðŸ“‹ Stato</label>
                      <select value={editForm.status || ''} onChange={(e) => setEditForm({ ...editForm, status: e.target.value })} style={inputStyle}><option value="">Seleziona stato...</option>{statuses.map(s => <option key={s.id} value={s.name}>{s.icon} {s.name}</option>)}</select>
                    </div>
                    <div>
                      <label style={{ fontSize: 12, color: 'var(--text-muted)', display: 'block', marginBottom: 6 }}>â­ Grado estetico</label>
                      <select value={editForm.aestheticGrade || ''} onChange={(e) => setEditForm({ ...editForm, aestheticGrade: e.target.value })} style={inputStyle}><option value="">Seleziona grado...</option>{aestheticGrades.map(g => <option key={g.id} value={g.name}>{g.name}</option>)}</select>
                    </div>
                  </div>

                  {/* Description */}
                  <div style={{ marginBottom: 14 }}>
                    <label style={{ fontSize: 12, color: 'var(--text-muted)', display: 'block', marginBottom: 6 }}>Descrizione</label>
                    <textarea value={editForm.description || ''} onChange={(e) => setEditForm({ ...editForm, description: e.target.value })} rows={2} style={{ ...inputStyle, resize: 'vertical' }} placeholder="Descrizione dettagliata..." />
                  </div>

                  {/* Year, Version, Serial */}
                  <div style={{ display: 'grid', gridTemplateColumns: isMobile ? '1fr 1fr' : '1fr 1fr 1fr', gap: 14, marginBottom: 14 }}>
                    <div><label style={{ fontSize: 12, color: 'var(--text-muted)', display: 'block', marginBottom: 6 }}>Anno produzione</label><input value={editForm.year || ''} onChange={(e) => setEditForm({ ...editForm, year: e.target.value })} style={inputStyle} placeholder="Es: 1950" /></div>
                    <div><label style={{ fontSize: 12, color: 'var(--text-muted)', display: 'block', marginBottom: 6 }}>Versione</label><input value={editForm.version || ''} onChange={(e) => setEditForm({ ...editForm, version: e.target.value })} style={inputStyle} placeholder="Es: 1a serie, GT, ZK" /></div>
                    <div style={{ gridColumn: isMobile ? 'span 2' : 'auto' }}><label style={{ fontSize: 12, color: 'var(--text-muted)', display: 'block', marginBottom: 6 }}>Numero di serie</label><input value={editForm.serialNumber || ''} onChange={(e) => setEditForm({ ...editForm, serialNumber: e.target.value })} style={inputStyle} placeholder="Es: L22-45678" /></div>
                  </div>

                  {/* Purchase Cost, Purchase Year */}
                  <div style={{ display: 'grid', gridTemplateColumns: isMobile ? '1fr 1fr' : '1fr 1fr', gap: 14, marginBottom: 14 }}>
                    <div><label style={{ fontSize: 12, color: 'var(--text-muted)', display: 'block', marginBottom: 6 }}>ðŸ’° Costo acquisto (â‚¬)</label><input type="number" value={editForm.purchaseCost || 0} onChange={(e) => setEditForm({ ...editForm, purchaseCost: parseFloat(e.target.value) || 0 })} style={inputStyle} step="0.01" /></div>
                    <div><label style={{ fontSize: 12, color: 'var(--text-muted)', display: 'block', marginBottom: 6 }}>ðŸ“… Anno acquisto</label><input value={editForm.purchaseYear || ''} onChange={(e) => setEditForm({ ...editForm, purchaseYear: e.target.value })} style={inputStyle} placeholder="Es: 2024" /></div>
                  </div>

                  {/* Location (single) */}
                  <div style={{ marginBottom: 14 }}>
                    <label style={{ fontSize: 12, color: 'var(--text-muted)', display: 'block', marginBottom: 6 }}>ðŸ“ Ubicazione <span style={{ color: 'var(--accent-danger)' }}>*</span></label>
                    {!showInlineAddLocation ? <div style={{ display: 'flex', gap: 8 }}>
                      <select value={editForm.location || ''} onChange={(e) => setEditForm({ ...editForm, location: e.target.value })} style={{ ...inputStyle, flex: 1 }}><option value="">Seleziona ubicazione...</option>{locations.map(l => <option key={l.id} value={l.name}>{l.name}</option>)}</select>
                      <button onClick={() => setShowInlineAddLocation(true)} style={{ ...btnStyle, padding: '10px', background: 'var(--accent-primary-soft)', color: 'var(--accent-primary)' }}>+</button>
                    </div> : <div style={{ display: 'flex', gap: 8, flexWrap: 'wrap' }}>
                      <input value={inlineLocationName} onChange={(e) => setInlineLocationName(e.target.value)} style={{ ...inputStyle, flex: '1 1 100px' }} placeholder="Nome ubicazione" autoFocus />
                      <input value={inlineLocationDesc} onChange={(e) => setInlineLocationDesc(e.target.value)} style={{ ...inputStyle, flex: '2 1 150px' }} placeholder="Descrizione" />
                      <button onClick={() => addLocation(inlineLocationName, inlineLocationDesc, true)} style={{ ...btnStyle, background: 'var(--accent-success)', color: '#fff' }}>âœ“</button>
                      <button onClick={() => { setShowInlineAddLocation(false); setInlineLocationName(''); setInlineLocationDesc(''); }} style={{ ...btnStyle, background: 'var(--bg-tertiary)', color: 'var(--text-secondary)' }}>âœ•</button>
                    </div>}
                  </div>

                  {/* Defect Found */}
                  <div style={{ marginBottom: 14 }}>
                    <label style={{ fontSize: 12, color: 'var(--text-muted)', display: 'block', marginBottom: 6 }}>âš ï¸ Difetti riscontrati</label>
                    <textarea value={editForm.defectFound || ''} onChange={(e) => setEditForm({ ...editForm, defectFound: e.target.value })} rows={2} style={{ ...inputStyle, resize: 'vertical' }} placeholder="Descrivi eventuali difetti o problemi..." />
                  </div>

                  {/* Images */}
                  <div style={{ marginBottom: 14 }}>
                    <label style={{ fontSize: 12, color: 'var(--text-muted)', display: 'block', marginBottom: 6 }}>ðŸ“· Immagini ({editForm.images?.length || 0}) <span style={{ fontWeight: 400, color: 'var(--accent-info)' }}>Convertite in WebP</span></label>
                    <div style={{ marginBottom: 12 }}><SortableImageGallery images={editForm.images || []} onChange={(imgs) => setEditForm({ ...editForm, images: imgs })} onOpenLightbox={openLightbox} /></div>
                    <div style={{ display: 'flex', gap: 12 }}>
                      <label style={{ flex: 1, padding: 14, textAlign: 'center', borderRadius: 10, background: 'var(--accent-success-soft)', border: '2px dashed rgba(124,184,124,0.3)', color: 'var(--accent-success)', cursor: 'pointer', fontSize: 13 }}>ðŸ“ Carica da PC (WebP)<input type="file" accept="image/*" multiple onChange={handleImageUpload} style={{ display: 'none' }} /></label>
                      <button onClick={addImageUrl} style={{ flex: 1, padding: 14, borderRadius: 10, background: 'var(--accent-info-soft)', border: '2px dashed rgba(122,172,196,0.3)', color: 'var(--accent-info)', cursor: 'pointer', fontSize: 13, fontFamily: 'inherit' }}>ðŸ”— Aggiungi URL</button>
                    </div>
                  </div>

                  {/* Notes */}
                  <div style={{ marginBottom: 20 }}>
                    <label style={{ fontSize: 12, color: 'var(--text-muted)', display: 'block', marginBottom: 6 }}>ðŸ“ Note</label>
                    <textarea value={editForm.notes || ''} onChange={(e) => setEditForm({ ...editForm, notes: e.target.value })} rows={2} style={{ ...inputStyle, resize: 'vertical' }} placeholder="Note aggiuntive..." />
                  </div>

                  {/* Save/Cancel */}
                  <div style={{ display: 'flex', gap: 12 }}>
                    <button onClick={handleSave} disabled={!isFormValid} style={{ ...btnStyle, flex: 1, justifyContent: 'center', background: isFormValid ? 'var(--accent-success)' : 'var(--bg-tertiary)', color: isFormValid ? '#fff' : 'var(--text-muted)', padding: '14px 20px', cursor: isFormValid ? 'pointer' : 'not-allowed' }}>ðŸ’¾ Salva oggetto</button>
                    <button onClick={handleCancel} style={{ ...btnStyle, flex: 1, justifyContent: 'center', background: 'var(--bg-tertiary)', color: 'var(--text-secondary)', padding: '14px 20px' }}>Annulla</button>
                  </div>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    ReactDOM.render(<CollectionManager />, document.getElementById('root'));
  </script>
</body>
</html>
